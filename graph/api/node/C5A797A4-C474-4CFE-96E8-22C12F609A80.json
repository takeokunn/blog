{
  "id": "C5A797A4-C474-4CFE-96E8-22C12F609A80",
  "title": "org-crypt運用メモ",
  "raw": ":PROPERTIES:\n:ID:       C5A797A4-C474-4CFE-96E8-22C12F609A80\n:END:\n#+TITLE: org-crypt運用メモ\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-01-27T14:49:25+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting org-mode\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\n=org-crypt= の使い方をイマイチに理解していなかったが、ふと調べてたら急に理解が進んだ。\n\n個人的な運用が固まったのでメモしておく。\n\n* Motivation\n\n=~/.aws/credentials= のような秘匿情報を =secret.org.gpg= から =org-babel-tangle= から出力していた。\nファイルごとGPGで暗号化すると =git diff= がきれいに取れないので地味に困っていた。\n\n=org-crypt= で必要な分を部分的に暗号化することによって、以前よりはGitフレンドリーにすることが可能になることが分かった。\n\n* =org-crypt= 使い方\n\n[[https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/org/org-crypt.el][org-crypt.el]] を読むのでもよいが、 [[https://fluca1978.github.io/2021/09/16/Emacs_Org_Encrypt.html][Encrypting the content of Emacs Org files]] にわかりやすくまとまっている。\n\n次のように設定した。\n\n#+begin_src emacs-lisp\n  (with-eval-after-load 'org\n    (setopt org-tags-exclude-from-inheritance '(\"crypt\")))\n\n  (with-eval-after-load 'org-crypt\n    (setopt org-crypt-key \"0B10DAA7BA0236D7382287660F79C0AB03FD7A1C\"))\n#+end_src\n\n=:crypt:= タグをつけて =M-x org-encrypt-entries= を実行すると次のようにGPGで暗号化される。\nタグはヘッダで =C-c C-c= を押すと入力できる。\n\n=M-x org-decrypt-entries= でファイル内全体を復号することも可能。\n\n=:crypt:= タグを変えたいなら =org-crypt-tag-matcher= を設定すればよい。\n\n#+begin_src org\n  ,* before\n  ,** access token\n  ,#+begin_src text\n  P@ssw0rd\n  ,#+end_src\n  ,* after                                                               :crypt:\n  -----BEGIN PGP MESSAGE-----\n\n  hQIMA6smtgkkGn+yAQ/+N67k5bFjZ+o/n3cRncdI7AXxZ4fcw7+vM9G/twKBkRqB\n  caleG2+FZy2u3ZHIE04ZnvKKPxZCDdm79Q6QxwBuuLsQiSn/jJ57QwNJySggQjwZ\n  aWQCzBFL5fBHgCR0eTZKX3Otr8Cpe2Eg1oH5SrUMEiRJ+uap+ZeVGs960icDy3AI\n  FRZ7z8BmaqFmA/ZRr3HO2nkFxJutzDnf7uCACa2JxpkJVDrhBOvGVrgHSqn/kzWu\n  +sriWo19z6O2mvVoWXOeg/3PNOP76ZCYFmqAa5zqoutBZ3GVEZ4M+uBcFJtQ6BHT\n  LgWLGNBEJeNjVWF1kGQYot4iArzrSbRzvNsEFzCiGyVYukgJSJuWWlC93aL4bJH+\n  c52Grie0DDacmiCADUVdUabvx16r82ptRylqV6um7mqdYGmPUErLhkp6zOwwhLgx\n  saAG4lY07DZeEdBtUfnYB39CRqxI/jVwSYoyTQC9PYUyo2y4E7Q2LjcoSyuJ8sPr\n  qgenSMn0gkF86ffm2ITmHDv5iQPgfhdzYIjtwrrDBpwCRkkoDfD68nS/zvekAe74\n  mO3fUOoM8jmMtQvCo9OMnVKkEXRXnzsyMI12KVIzMakljxnzvgDaELr5s6XTR/0F\n  FgAP19OQNbf24Ax3W+/m5GYxf5ltm+W4qDO0add5z2WLavOYGdknCCLFSN74/VLS\n  bwHums4w2RPZ00nnEX5zI+eN76UM42yZ53gDRjQgfVzfKdX4Rub/D19ZhL+bfqXR\n  iOJwPGz6yfeCDbz4RVvQgd/U8g5LkTrRu/itq9eZpCEjfH/HamC4meOrChI7xvJZ\n  nBkMYucqr7d5DPWEp4gYzQ==\n  =/Ual\n  -----END PGP MESSAGE-----\n#+end_src\n\n* =org-babel-tangle= との連携\n\n自分のユースケースだと =org-babel-tangle= と組み合わせて実行するのだが、 =org-babel-tangle= はencrypt/decryptとは関係のない処理ですので、実行前後でencrypt/decryptする必要がある。\n\nok:\n\n#+begin_src org\n  ,* Secret\n  ,** Password\n  ,#+begin_src text :noweb-ref personal-access-token-github-for-private\n    ghp_xxx\n  ,#+end_src\n  ,** Config\n  ,#+begin_src yaml :tangle (expand-file-name \"~/.config/gh/hosts.yml\") :mkdirp yes :noweb yes\n    github.com:\n      user: takeokunn\n      oauth_token: <<personal-access-token-github-for-private>>\n      git_protocol: ssh\n  ,#+end_src\n#+end_src\n\nng:\n\n#+begin_src org\n  ,* Secret\n  ,** Password                                                           :crypt:\n  -----BEGIN PGP MESSAGE-----\n\n  hQIMA6smtgkkGn+yAQ/9FbKfh2bZdSPGQo6uEwJMXxYTUPzfE0RwiefZH0DMDwq0\n  GNPByVgSBd8Cl8U/CyALIwC2FRSkRhnRzbF80ukSaSAacDnmMb4tJFsqSlmG0cll\n  eM5sDGLCehZa06v2x6E6wt6kCE+pawEwTjts917PczOyxmZvA7jPK+uSsLUg5IUw\n  m/ykhS1JuOLs9JuEQdIfZlFp2k1jy3kZMkNsoJV2l25vci6LP4Dc7qsptCZpNU3H\n  zmJRyA7fVPYpCRVdpUzpmsFmYsaEf7LgI0bsCORne+Uy9R+YFakgYj2a0lWAUtVX\n  Z+yKKs0Pmt9EPYP3rC598VPZreNxJJSC/4jlceBwXYJ+13dbebg1xFxoze4fqlzp\n  mTW6yJthHmwGd3O7xMiyoojYqwoQ4wCzeLCT9v4BvGJYbpVKPtQuNUw6aYlvw5Eu\n  IN3/sCq+TTo+KJcrB8H/40XaVgYT9pR69Ak8Ptu+J2txOD6tglQaqMihtJN2+Dzt\n  dvvOONnFd3HOzNL99/ymSTgk4ezypwqjX06TbkdVgWIT5XMKCCI5I/ZAAe3oLW2Z\n  L5F+Gadhkky3dfPuivR6rT/CH8/L/hQzk5ejFkZu9u3ltxC+oeGHWQXsS1CyYqTE\n  fyiUd1u/yME5R+IFlSoG28un48Kc8GoJcydObaKUMDajgPwEZB1TR9rlmSNxCMDS\n  kwEFB49p4TvBosy8762aYp1gwftyg69m5CDtCC5jxpkVuz7GDBphy7qAQlS3gTNN\n  Jb+r9PuJf8h+XfSZqJFyfYGzr0FBITIxI8gu+m+Tf9q7cS93s22w7t2yzS014Dwq\n  6u4pwk8AG9SxJ4kcPmN7z9kwZwrMlaPImb1boBmKOsnL6onuUO5pNT+PNE3JbSFt\n  NL/rJw==\n  =hxwG\n  -----END PGP MESSAGE-----\n  ,** Config\n  ,#+begin_src yaml :tangle (expand-file-name \"~/.config/gh/hosts.yml\") :mkdirp yes :noweb yes\n    github.com:\n      user: takeokunn\n      oauth_token: <<personal-access-token-github-for-private>>\n      git_protocol: ssh\n  ,#+end_src\n#+end_src\n\n[[https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/org/org-crypt.el#L313-L318][org-crypt-use-before-save-magic]] は有効にすると、次のような問題が発生する。\n\n1. =org-decrypt-entries= を実行する\n2. =org-babel-tangle= を実行すると内部的にsave処理が走る\n3. =org-crypt-use-before-save-magic= でsave hookして =org-encrypt-entries= が実行される\n4. =org-babel-tangle= 時に空文字で出力される\n\nそこでadvice関数で前後にencrypt/decryptする処理を追加した。\n\n#+begin_src emacs-lisp\n  (advice-add 'org-babel-tangle :before #'org-decrypt-entries)\n  (advice-add 'org-babel-tangle :after #'org-encrypt-entries)\n#+end_src\n\n* 終わりに\n当初の目的を満たせてよかったので満足。\npre-commitでsecretlintを回すようにしているので、encrypt忘れはそちらでもカバーできるようにしている。\n\n余談だが、org-encryptを活用例でいうとこなゆき氏のdotfilesが非常によくできているので、一読することをお勧めする。\nhttps://github.com/p-snow/config/blob/main/dotfiles.org\n",
  "backlinks": [
    {
      "title": "mcp-servers-nixを導入した",
      "source": "653CAD86-42DF-4987-9642-D5179B90CA97"
    },
    {
      "title": "credential管理をorg-encryptからpassword-storeに移行した",
      "source": "8A0AAFA0-0FDA-4C4C-BDC3-8279A68CE44C"
    }
  ]
}