{
  "id": "923E2C2D-EAF9-F6A4-8C43-136BEC60DBBA",
  "title": "sitemap.xmlからURLを良い感じに抽出してPlaywrightでUIを目視確認する",
  "raw": ":PROPERTIES:\n:ID:       923E2C2D-EAF9-F6A4-8C43-136BEC60DBBA\n:mtime:    20231217115507\n:ctime:    20221222102844\n:END:\n#+TITLE: sitemap.xmlからURLを良い感じに抽出してPlaywrightでUIを目視確認する\n#+AUTHOR: takeokunn\n#+DESCRIPTION: playwright使ってみた\n#+DATE: 2022-12-22T09:00:00+09:00\n#+HUGO_BASE_DIR: ../../\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_TAGS: playwright\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* やりたいこと\n\nフレームワークや言語のバージョンを上げたり、UI周りのリファクタリングをした際に、500やデザイン崩れがないかを確認したい。\n理想をいうとxUnitのようなテストコードを書いたりする方がよいのだが、テストコードを書くと工数が非常にかかるし、もともとテストコードがない環境だとしんどい。\n\nまた、テストコードでは当然UIの目視確認まではできない。\n\nサクっと主要なページを目視で眺める方法ないかなと考えてたところ、「確認したいページリストを =sitemap.xml= から生成してよい感じに自動でスクロールすればよいのでは。..?」ということを思いついたので書いていく。\n\n特に拘泥がなかったので [[https://zenn.dev/yusukeiwaki/articles/db1cd8d7aa87ed][2021年現在、Puppeteerを使う理由はなくなった。Playwrightを使おう。]] を読んでPlaywrightを選んだ。\n\n* ソースコード\n\n必要packageは次の3つ。\n\n#+begin_src shell\n  $ npm install playwright\n  $ npm install axios\n  $ npm install xml2json\n#+end_src\n\nコード全体像は以下。\n\n#+begin_src js\n  const axios = require(\"axios\");\n  const parser = require(\"xml2json\");\n  const { chromium } = require(\"playwright\");\n\n  const BASE_URL = \"<edit your url>\";\n\n  const fetchSitemap = async () => {\n      const res = await axios.get(`${BASE_URL}/sitemap.xml`);\n      const body = JSON.parse(parser.toJson(res.data));\n      return body.urlset.url.map((url) => url.loc);\n  };\n\n  const filterSitemapUrls = (urls) => {\n      const cb = (path) => {\n          let count = 0;\n\n          return (url) => {\n              if (!url.match(path)) return true;\n              if (count === 3) return false;\n\n              count++;\n              return true;\n          };\n      };\n\n      return urls\n          .filter(cb(/posts\\//))\n          .filter(cb(/articles\\//));\n  };\n\n  const evaluateScript = async () => {\n      const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n      for (let index = 0; index < document.body.scrollHeight / 10; index += 100) {\n          window.scrollTo(0, index * 10);\n          await delay(1000);\n      }\n  };\n\n  const runSitemapScenarios = async (page) => {\n      const urls = await fetchSitemap();\n      for (const url of filterSitemapUrls(urls)) {\n          await page.goto(url);\n          await page.evaluate(evaluateScript);\n      }\n  };\n\n  const main = async () => {\n      const browser = await chromium.launch({ headless: false });\n      const page = await browser.newPage();\n\n      await runSitemapScenarios(page)\n\n      await browser.close();\n  };\n\n  main();\n#+end_src\n\n* 解説\n\n=<base_url>/sitemap.xml= を =axios= で取得し、 =xml2json= でxmlをjsonに変換後、playwrightで下までスクロールする。\nただ、純粋に =sitemap.xml= をすべて眺めるのは厳しい。\n=/articles/<id>= のような動的に生成されたページをすべて見るのは無駄だ。\n\n特定のパターンのURLは先頭3つのみにするなど丸める必要があったので次のようなコードを書いた。\n\n#+begin_src js\n  const filterSitemapUrls = (urls) => {\n      const cb = (path) => {\n          let count = 0;\n\n          return (url) => {\n              if (!url.match(path)) return true;\n              if (count === 3) return false;\n\n              count++;\n              return true;\n          };\n      };\n\n      return urls\n          .filter(cb(/posts\\//))\n          .filter(cb(/articles\\//));\n  };\n#+end_src\n\nまた、ページを開いてから一番下まで目視確認できるようにゆっくりスクロールするようにした。\n\n#+begin_src js\n  const evaluateScript = async () => {\n      const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));\n      for (let index = 0; index < document.body.scrollHeight / 10; index += 100) {\n          window.scrollTo(0, index * 10);\n          await delay(1000);\n      }\n  };\n\n  const runSitemapScenarios = async (page) => {\n      const urls = await fetchSitemap();\n      for (const url of filterSitemapUrls(urls)) {\n          await page.goto(url);\n          await page.evaluate(evaluateScript);\n      }\n  };\n#+end_src\n",
  "backlinks": []
}