:PROPERTIES:
:ID:       99A051B3-00A2-484A-8E02-2E2206FE81B3
:END:
#+TITLE: emacs wgrepが便利だった
#+AUTHOR: takeokunn
#+DESCRIPTION: description
#+DATE: 2025-12-03T02:18:11+0900
#+HUGO_BASE_DIR: ../../
#+HUGO_CATEGORIES: fleeting
#+HUGO_SECTION: posts/fleeting
#+HUGO_TAGS: fleeting emacs
#+HUGO_DRAFT: false
#+STARTUP: fold
* 背景・動機

本記事は [[https://qiita.com/advent-calendar/2025/emacs][Emacs Advent Calendar 2025]] の2日目の記事です。

[[id:0359A766-FE00-4CC8-B319-3E033DD9F77E][emacs wdiredが便利だった]] でwgrepも便利だということが判明したのでこちらも調査してみる。

* 試したこと・やったこと
** 1. wgrepの機能調査

[[https://github.com/mhayashi1120/Emacs-wgrep][mhayashi1120/Emacs-wgrep]] のサードパーティpackageでMelpaから落とすことができる。

https://melpa.org/#/?q=wgrep

=*grep*= bufferの =grep-mode= にhookして =wgrep-setup= を実行し、 =wgrep-mode= というminor modeを起動する。

#+begin_src emacs-lisp
  (add-hook 'grep-setup-hook 'wgrep-setup)
#+end_src

類似機能に標準機能の =moccur-edit= があり、migemoとの連携も取れるようだ。
自分はmigemoユーザではないが将来的に試してみたい。

** 2. wgrep設定

=defcustom= としては以下だが、自分は特に設定していない。

| 変数名 （Variable）         | 機能概要                                                             | 戦略的利用法                                                                      |
|----------------------------+---------------------------------------------------------------------+----------------------------------------------------------------------------------|
| wgrep-auto-save-buffer     | 変更適用完了時（wgrep-finish-edit）にバッファを自動保存するか 。          | 大規模リファクタリング時、安全のため =nil= （手動保存）を維持するか、迅速な処理のために =t= に設定。 |
| wgrep-enable-key           | wgrepモードを有効にするためのキーバインド 。                             | ワークフローの摩擦を減らすため、単一キー（例: "r"や"e"）に設定することを推奨。             |
| wgrep-change-readonly-file | バッファが読み取り専用であるかどうかにかかわらず、変更を強制的に適用するか 。 | VCSによって保護されたファイルを編集する場合に有効化。                                   |

デフォルトのkeybindは次のようになっている。

#+begin_src emacs-lisp
  (unless wgrep-mode-map
    (let ((map (make-sparse-keymap)))

      (define-key map "\C-c\C-c" 'wgrep-finish-edit)
      (define-key map "\C-c\C-d" 'wgrep-mark-deletion)
      (define-key map "\C-c\C-e" 'wgrep-finish-edit)
      (define-key map "\C-c\C-p" 'wgrep-toggle-readonly-area)
      (define-key map "\C-c\C-r" 'wgrep-remove-change)
      (define-key map "\C-x\C-s" 'wgrep-finish-edit)
      (define-key map "\C-c\C-u" 'wgrep-remove-all-change)
      (define-key map "\C-c\C-k" 'wgrep-abort-changes)
      (define-key map "\C-x\C-q" 'wgrep-exit)

      (setq wgrep-mode-map map)))
#+end_src
** 3. 挙動の確認

minad-wareのaffeで実験すると次のようになる。

https://github.com/minad/affe

1. =M-x affe-grep= を実行する

[[file:../../static/images/38E7738C-FDAF-448A-9A77-F9C9F8BC5EE1.png]]

2. 雑にgrepをかける

[[file:../../static/images/867FC3BF-8EA3-445D-A2D6-76010F11AA9E.png]]

3. =embark-act= を起動しつつ =embark-export= する

[[file:../../static/images/AE662EFE-2D8D-4E3B-A3CB-C06C7D13513B.png]]

4. =C-c C-q= でwgrep-modeに入り編集、 =C-x C-s= で保存すると変更される

[[file:../../static/images/2FB49852-E12D-4F3B-87B8-72189BB6409F.png]]

* 得られた結果・所感

wdiredと双対をなすキラーアプリと言っても過言ではないくらい便利でもっと早く知りたかった。

* 今後の展開・検討事項

[[https://github.com/bbatsov/projectile][projectile]] からEmacs標準の project.el に移行したいと長年思ってたが、projectileのgrep/replace周りを使いたいしなーと思ってなんとなく移行できてなかった。
projectileを剥がして =affe-grep= や =affre-find= を使いつつ =wgrep= でよいなという結論がついたので次回は移行する記事を書く。
