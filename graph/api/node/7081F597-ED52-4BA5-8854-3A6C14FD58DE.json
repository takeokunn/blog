{
  "id": "7081F597-ED52-4BA5-8854-3A6C14FD58DE",
  "title": "@github/copilot-language-serverをNixで扱う時のメモ",
  "raw": ":PROPERTIES:\n:ID:       7081F597-ED52-4BA5-8854-3A6C14FD58DE\n:END:\n#+TITLE: @github/copilot-language-serverをNixで扱う時のメモ\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-02-27T21:37:32+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting emacs nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\n[[https://github.com/orgs/github/packages/npm/package/copilot-language-server][@github/copilot-language-server]] を [[https://github.com/takeokunn/nixos-configuration][takeokunn/nixos-configuration]] 上で扱えるようにしたのでメモしておく。\n\n* Background\n\n- [[https://github.com/copilot-emacs/copilot.el][copilot.el]] のバージョンが上がった\n- [[https://github.com/orgs/github/packages/npm/package/copilot-language-server][@github/copilot-language-server]] をnpmでインストールして使う必要があった\n- 次の要件を満たしたい\n  - Nixでパッケージングしたい\n  - Neovimなどのエディタでも汎用的に使えるようにしたい\n\n* 対応手順\n** 1. node2nixでパッケージングする\n\n=node2nix/node-packages.json= に次のような記述をした。\n\n#+begin_src json\n  [\"@github/copilot-language-server\"]\n#+end_src\n\n\n次のshell scriptを実行するとファイルが生成された。\n\n- =node2nix/default.nix=\n- =node2nix/node-env.nix=\n- =node2nix/node-packages.nix=\n\n#+begin_src console\n  $ nix-shell -p nodePackages.node2nix --command \"node2nix -i ./node-packages.json -o node-packages.nix\"\n#+end_src\n** 2. 実行ファイルを取得する\n\n=node2nix/default.nix= をimportするとpackageが読み込めるようになった。\n\n#+begin_src nix\n  nodePkgs = pkgs.callPackage ../node2nix { inherit pkgs; };\n#+end_src\n\n\ncopilot-language-server は次のようなディレクトリ構造になっている。\n\n#+begin_src console\n  $ dust native/\n\n   65M ├─┬ native/darwin-x64\n   65M │ └── native/darwin-x64/copilot-language-server\n   60M ├─┬ native/darwin-arm64\n   60M │ └── native/darwin-arm64/copilot-language-server\n   59M ├─┬ native/linux-x64\n   59M │ └── native/linux-x64/copilot-language-server\n   50M └─┬ native/win32-x64\n   50M   └── native/win32-x64/copilot-language-server.exe\n#+end_src\n\nそこで、platformごとに対応表を作って =COPILOT_LANGUAGE_SERVER_PATH= にPATHを通してあげた。\n\n#+begin_src nix\n  { pkgs, nodePkgs }:\n  let\n    platforms = {\n      \"x86_64-linux\" = \"linux-amd64\";\n      \"aarch64-linux\" = \"linux-aarch64\";\n      \"x86_64-darwin\" = \"darwin-amd64\";\n      \"aarch64-darwin\" = \"darwin-arm64\";\n    };\n    platform = builtins.getAttr pkgs.system platforms;\n  in\n  {\n    home.packages = [ nodePkgs.\"@github/copilot-language-server\" ];\n\n    programs.fish = {\n      interactiveShellInit = ''\n        set -gx COPILOT_LANGUAGE_SERVER_PATH ${\n          nodePkgs.\"@github/copilot-language-server\"\n        }/lib/node_modules/@github/copilot-language-server/native/${platform}/copilot-language-server\n      '';\n    };\n  }\n#+end_src\n\n=2025/03/27(Mon)= 現在、次のような環境変数が定義されている。\n\n#+begin_src console\n  $ echo $COPILOT_LANGUAGE_SERVER_PATH\n  /nix/store/314dbj3vqb5s0f37gszm948arm37layx-_at_github_slash_copilot-language-server-1.291.0/lib/node_modules/@github/copilot-language-server/native/darwin-arm64/copilot-language-server\n#+end_src\n** 3. copilot.elにPATHを通す\n\n=exec-path-from-shell=:\n\n#+begin_src emacs-lisp\n  (setopt exec-path-from-shell-variables '(\"PATH\" \"TERM\" \"SSH_AUTH_SOCK\" \"COPILOT_LANGUAGE_SERVER_PATH\"))\n#+end_src\n\n=copilot.el=:\n\n#+begin_src emacs-lisp\n  (setopt copilot-server-executable (getenv \"COPILOT_LANGUAGE_SERVER_PATH\"))\n#+end_src\n\n* 終わりに\n問題なく使えるようになってうれしい。今後ともcopilotを使い倒していきたい。\n",
  "backlinks": [
    {
      "title": "node2nixの使い方",
      "source": "86EA901D-8BF0-4AD8-B9D5-64284E4D1322"
    }
  ]
}