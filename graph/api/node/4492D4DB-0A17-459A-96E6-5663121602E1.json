{
  "id": "4492D4DB-0A17-459A-96E6-5663121602E1",
  "title": "GitHub Actions内で署名付きCommitをする",
  "raw": ":PROPERTIES:\n:ID:       4492D4DB-0A17-459A-96E6-5663121602E1\n:END:\n#+TITLE: GitHub Actions内で署名付きCommitをする\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-05-18T20:14:16+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting gpg\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\n[[id:A942A0CA-829F-45C0-A9CC-F7CA8C0DE873][Terraform GitHub Providerを導入した]] で署名付きCommitを強制するBranch Ruleを網羅的に適用した。\n\n#+begin_src terraform\n  resource \"github_repository_ruleset\" \"default-branch\" {\n    name        = \"main\"\n    repository  = \"repo-name\"\n    target      = \"branch\"\n    enforcement = \"active\"\n\n    conditions {\n      ref_name {\n        include = [\"~DEFAULT_BRANCH\"]\n        exclude = []\n      }\n    }\n\n    rules {\n      required_signatures = true\n      non_fast_forward    = true\n    }\n  }\n#+end_src\n\n2025年5月現在、 [[https://github.com/takeokunn/nixos-configuration][takeokunn/nixos-configuration]] では次のGitHub Actionsが動いている。\n\n1. 毎日20時に発火する\n2. =nix flake update= などを実行して依存を更新する\n3. 変更をcommitしてpushする\n\n署名付きCommitを強制する変更を加えた影響で「3. 変更をcommitしてpushする」が動かなくなってしまった。\n\n調べた所、GitHub Actions内で署名付きCommitをしている人が世の中に少なかったので対応方法を纏めておく。\n\n* 試したこと・やったこと\n** 1. 署名用のGPG Keyを生成する\n\n[[id:B3ECD5FA-DFCE-447B-AAB0-72BEAAA28AEF][GPG KeyのYubiKey運用をはじめた]] にあるとおり、自分の手元では主鍵副鍵運用をしている。\n\n主鍵から =addkey= Signのみを付与した副鍵を生成する。\n生成する際に必ずパスフレーズも設定する。\n\n後に使うのでフィンガープリントもメモしておく。\n\n#+begin_src console\n  $ gpg -K --with-fingerprint\n#+end_src\n** 2. GitHub Actions Secretに副鍵のPrivate Keyを登録する\n\n=GPG_PRIVATE_KEY= と =PASSPHRASE= を設定する。\n\n自分の場合はTerraform GitHub Provider経由で設定をした。\n\n#+begin_src terraform\n  resource \"github_actions_secret\" \"nixos-configuration-GPG_PRIVATE_KEY\" {\n    repository      = github_repository.nixos-configuration.name\n    secret_name     = \"GPG_PRIVATE_KEY\"\n    plaintext_value = var.GPG_PRIVATE_KEY\n  }\n\n  resource \"github_actions_secret\" \"nixos-configuration-PASSPHRASE\" {\n    repository      = github_repository.nixos-configuration.name\n    secret_name     = \"PASSPHRASE\"\n    plaintext_value = var.PASSPHRASE\n  }\n#+end_src\n** 3. GitHub Actionsに組込む\n\n全体像は以下。\n\nhttps://github.com/takeokunn/nixos-configuration/blob/ff99ab4eb83d729f93f76608273daea49a9dae85/.github/workflows/update.yml\n\n[[http://github.com/crazy-max/ghaction-import-gpg][crazy-max/ghaction-import-gpg]] を使い、次のように =GPG_PRIVATE_KEY= と =PASSPHRASE= とfingerprintを設定する。\n\n#+begin_src yaml\n  steps:\n    - name: Import GPG key\n      uses: crazy-max/ghaction-import-gpg@v6\n      with:\n        gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}\n        passphrase: ${{ secrets.PASSPHRASE }}\n        fingerprint: <控えておいたfingerprint>\n        git_user_signingkey: true\n        git_commit_gpgsign: true\n        git_config_global: true\n#+end_src\n\ncommit部分はsigned optionをつけてpushをする。\n\n#+begin_src console\n  git commit -S -m \"Update lockfile\"\n  git push origin HEAD\n#+end_src\n* 得られた結果・所感\n\n多少強引だが無事に実現できた。\n\n=GPG_PRIVATE_KEY= が漏れる経路は以下が考えられる。\n\n- Terraform CloudのSecretが抜かれた時\n- GitHub Actions Secretが抜かれた時\n- [[http://github.com/crazy-max/ghaction-import-gpg][crazy-max/ghaction-import-gpg]] に不正なコードが入った時\n\n副鍵にはSignしか降ってないので失効対応をすれば問題ない認識だが注意して扱う必要がある。\n\n調査する過程で、GitHubの署名付きCommitはGPGだけでなくSSHやX.509も対応していることが分かった。\n\nhttps://docs.github.com/ja/authentication/managing-commit-signature-verification/telling-git-about-your-signing-key\n\n* 今後の展開・検討事項\nそもそも論としてPull Requestを自動で作成しCIが通ったらMergeするようにすべきなので別途対応する。\n",
  "backlinks": []
}