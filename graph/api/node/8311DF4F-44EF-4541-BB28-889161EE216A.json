{
  "id": "8311DF4F-44EF-4541-BB28-889161EE216A",
  "title": "Bitwardenからpassword-storeに移行した",
  "raw": ":PROPERTIES:\n:ID:       8311DF4F-44EF-4541-BB28-889161EE216A\n:END:\n#+TITLE: Bitwardenからpassword-storeに移行した\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2024-01-08T21:13:54+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting password-store\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\nBitwardenからpassword-storeに移行したので作業内容をメモしておく。\n\n* Basic\n\n- 普段使うものは可能な限りPlain TextとGitで管理したい\n- EmacsやTerminalから簡単に呼び出したい\n- [[https://www.gnupg.org/][GnuPG]]を可能な限り活用したい\n\n* Goal\n\n- Bitwardenに保存されているすべての情報をpassword-storeに移行する\n- EmacsやTerminalから簡単にパスワードを取得できるようにする\n\n* Not Goal\n\n- Bitwardenのアカウントを完全に削除する\n  - 数年間使わなくても問題なかったら適切に削除する\n\n* 技術選定\n\n[[https://www.passwordstore.org/][password-store]]を選択した理由は以下。\n\n- 十分に枯れている\n- Plain TextとGitで管理できる\n- password-storeが挙動しなくなってもGPGさえ動けばよい\n  - shell scriptの小さなコードベースで書かれている\n  - GPGが動かない時は =git commit= もできない状態なので根本的に問題\n- 2024年現在所属している会社でpassword-storeを使っている\n  - ref. [[https://qiita.com/karronoli/items/7ac1984712495fdc570d][Pass: The Standard Unix Password Manager の紹介 - Qiita]]\n- [[https://ja.wikipedia.org/wiki/Time-based_One-time_Password][TOTP]]に対応している\n- Emacs Packageがある\n\n周りのエンジニアに何を使っているのか聞いたところ、[[https://1password.com/jp][1password]]や[[https://bitwarden.com/][Bitwarden]]を使っている人が大半だった。\n\n* 作業手順\n** 1. Bitwardenからパスワードを抽出する\n\n[[https://github.com/bitwarden/clients][bitwarden/clients]] を手元のPCに入れる。\n\n#+begin_src console\n  $ bw --version\n  2023.12.1\n#+end_src\n\nLoginしてセッションを取得。\n\n#+begin_src console\n  $ bw login\n#+end_src\n\n=bw list items= コマンドを叩いてパスワードを抽出する。\n\n#+begin_src console\n  $ bw list items --session <session_id> \\\n        | jq '.[] | { folderId: .folderId, name: .name, login: .login }' \\\n        | jq . > /tmp/bw.json\n#+end_src\n\n次のようなjsonが =/tmp/bw.json= に出力される。\n\n#+begin_src json\n  {\n    \"folderId\": \"ad72f121-6385-49ea-8983-xxx\",\n    \"name\": \"foo\",\n    \"login\": {\n      \"fido2Credentials\": [],\n      \"username\": \"name\",\n      \"password\": \"pass\",\n      \"totp\": null,\n      \"passwordRevisionDate\": null\n    }\n  }\n  {\n    \"folderId\": \"ad72f121-6385-49ea-8983-yyy\",\n    \"name\": \"bar\",\n    \"login\": {\n      \"fido2Credentials\": [],\n      \"username\": \"name\",\n      \"password\": \"pass\",\n      \"totp\": null,\n      \"passwordRevisionDate\": null\n    }\n  }\n#+end_src\n\n** 2. passコマンドをインストールする\n\n私はNixユーザーなので[[https://search.nixos.org/packages?channel=23.11&show=pass&from=0&size=50&sort=relevance&type=packages&query=pass][Nix Packageからpass]]を落としてくる。次のような設定で[[https://github.com/nix-community/home-manager][home-manager]]経由で入れる。\n\n#+begin_src nix\n  { pkgs, ... }:\n\n  {\n    home.packages = with pkgs; [\n      (pass.withExtensions (extensions: with extensions; [ pass-otp ]))\n    ];\n  }\n#+end_src\n** 3. password-storeのリポジトリを作成する\nGitHub Private Repoを作成し、[[https://wiki.archlinux.jp/index.php/Pass][pass - archlinux wiki]]を参考にpassword-storeを作る。\n\n#+begin_src console\n  $ pass init <gpg-id or email>\n#+end_src\n** 4. password-storeへパスワードを移行\n\n=folder_id= の一覧APIはなさそうだったので、Bitwardenの画面と照らし合わせて手動でfolder_idを取得する。\n\n#+begin_src console\n  $ cat /tmp/bw.json | jq 'select(.folderId == \"<folder_id>\")'  | jq . > /tmp/<folder>.json\n#+end_src\n\n抽出したものを手動で次のようなフォーマットに変換した。\n\n#+begin_src console\n  P@ssw0rd\n  url: https://servicename.com/\n  username: username\n#+end_src\n\n** 5. Fish Shell設定\n\n=config.fish= に次の設定を追加する。\n\n#+begin_src fish\n  if type -q pass\n      set -x PASSWORD_STORE_DIR $HOME/ghq/github.com/takeokunn/password-store\n      set -x PASSWORD_STORE_ENABLE_EXTENSIONS true\n  end\n#+end_src\n\nFish Completionはここから落としてくる。\n\n[[https://github.com/zx2c4/password-store/blob/master/src/completion/pass.fish-completion][https://github.com/zx2c4/password-store/blob/master/src/completion/pass.fish-completion]]\n\n** 6. Emacs Plugin導入\n\n次のように[[https://github.com/NicolasPetton/pass][NicolasPetton/pass]]を設定する。\n\n#+begin_src emacs-lisp\n  (autoload-if-found '(pass pass-view-mode) \"pass\" nil t)\n\n  (add-to-list 'auto-mode-alist (cons (substitute-in-file-name \"$HOME/ghq/github.com/takeokunn/password-store/.*\\\\.gpg\") 'pass-view-mode))\n\n  (with-eval-after-load 'pass\n    (setq pass-suppress-confirmations t))\n#+end_src\n\n=pass-view-mode= 用に次のような[[https://github.com/joaotavora/yasnippet][yasnippet]]を設定する。\n\n#+begin_src text\n  # -*- mode: snippet -*-\n  # name: template\n  # key: template\n  # --\n  url: $1\n  username: $2\n  memo: $0\n#+end_src\n\n* Result\n\n183個の秘匿情報が入ったgpgファイルを作成した。\n\n#+begin_src console\n  $ git -C ~/ghq/github.com/takeokunn/password-store ls-files | grep .gpg | wc -l\n  183\n#+end_src\n\n次のようなディレクトリ構成を作成した。\n\n#+begin_src shell\n  ~/.ghq/github.com/takeokunn/password-store/\n  ├── README.org\n  ├── .gpg-id\n  ├── private\n  |   └── life\n  |       └── 楽天証券.gpg\n  ├── project-A\n  ├── project-B\n  └── project-C\n      └── shopify\n          └── aaa.gpg\n      └── infra\n          └── aws.gpg\n#+end_src\n* NextStep\n\n- ディレクトリ構成を整理する\n- TOTP周りを[[https://authy.com/][Authy]]から[[https://github.com/tadfisher/pass-otp][pass-otp]]に移行する\n- GPG Private Keyの管理方法を考える\n  - [[https://keens.github.io/blog/2021/03/23/yubikeywotsukau_openpghen][YubikeyでOpenPGP鍵をセキュアに使う - κeenのHappy Hacκing Blog]] が良さそう\n* 所感\nBitwardenは使いやすく特に文句がなかったので、理由がない限りはでpassword-storeに移行する必要はないし、これからパスワードマネージャーを入れる人はBitwardenを勧めたい。\n",
  "backlinks": [
    {
      "title": "BitwardenとAuthyのアカウントを削除した",
      "source": "7ACD0B88-960A-44C6-954B-C597AE60ECD1"
    },
    {
      "title": "GPG KeyのYubiKey運用をはじめた",
      "source": "B3ECD5FA-DFCE-447B-AAB0-72BEAAA28AEF"
    },
    {
      "title": "Authyからpassword-store-otpに移行した",
      "source": "624F0A4B-0F8A-40B1-8AAD-DCC88CFC719A"
    }
  ]
}