{
  "id": "C59EE651-BB54-4F4B-89C6-B3503DEF3C57",
  "title": "AjaxとBrowser Cookie",
  "raw": ":PROPERTIES:\n:ID:       C59EE651-BB54-4F4B-89C6-B3503DEF3C57\n:mtime:    20231204003005\n:ctime:    20221215003237\n:END:\n#+TITLE: AjaxとBrowser Cookie\n#+AUTHOR: takeokunn\n#+DESCRIPTION: AjaxとBrowser Cookie\n#+DATE: 2019-03-30T09:00:00+09:00\n#+HUGO_BASE_DIR: ../../\n#+HUGO_SECTION: posts/permanent\n#+HUGO_CATEGORIES: permanent\n#+HUGO_TAGS: javascript\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n\n「ブラウザからアクセスするのと、AjaxからアクセスするのってCookieってかわっちゃうの？」という質問をされたので自分なりの答えを書いていく。\n\nAjaxなのだが、JavaScriptで一番有名なlibraryの[[https://github.com/axios/axios][axios/axios]]を用いて書く。\n\nFetchAPIについては今回は含めない。\n\n--------------\n\n** 結論\n\n基本的にはCookieは変わらない。\n\n同一オリジンの場合は自動的にCookieが使われる。\n\n別オリジンの場合にCookieを使いたいなら ~{ withCredentials: true }~ をoptionに持たせればよい。\n\n#+begin_src js\n  axios.get('https://www.uuum.jp', { withCredentials: true });\n#+end_src\n\n--------------\n\nそもそもAjaxとはなんだろうか？\n\n[[https://developer.mozilla.org/ja/docs/Web/Guide/AJAX/Getting_Started][MDN]]にこう書いてある。\n\n#+begin_quote\nAJAX は Asynchronous JavaScript And XML の頭文字を取ったものです。\nこれは一言で言えば、 XMLHttpRequest オブジェクトを使ってサーバーと通信することです。\nAJAX は JSON, XML, HTML, テキストファイルなど、様々な形式の情報で送受信することができます。\nAJAX の最も魅力的な特徴は「非同期」であること、つまり、サーバーとの通信、データの交換、ページの更新を、ページの再読み込みなしに行うことができる点です。\n#+end_quote\n\n要するに、JavaScriptから通信ができるというだけ。\n\n~XMLHttRequest~ のサンプルは以下。\n\n#+begin_src js\n  const xhr = new XMLHttpRequest();\n  xhr.open(\"GET\", \"https://www.uuum.jp\");\n  xhr.send();\n\n  console.log(xhr.status); // 200\n#+end_src\n\nこれで通信ができる。以上だ。\n\n--------------\n\naxiosのコードを読んでみる。\n\n[[https://github.com/axios/axios/blob/503418718f669fcc674719fd862b355605d7b41f/lib/adapters/xhr.js][axios/lib/adapters/xhr.js]]に ~XMLHttpRequest~ が書いてある。\n\n#+begin_src js\nvar request = new XMLHttpRequest();\n#+end_src\n\n~XMLHttpRequest~ を使っているのが確認できた。\n\nさて、Cookieの扱い方はどうなっているだろうか？　ググったら ~withCredentials~ を使えって書いてある。\n\n実際にコード読んでみるとこんな記述がある。\n\n[[https://github.com/axios/axios/blob/503418718f669fcc674719fd862b355605d7b41f/lib/adapters/xhr.js#L103-L105][axios/lib/adapters/xhr.js#L103-L105]]:\n\n#+begin_src js\n  var xsrfValue = (config.withCredentials || isURLSameOrigin(config.url)) && config.xsrfCookieName ?\n      cookies.read(config.xsrfCookieName) :\n      undefined;\n#+end_src\n\n同一オリジンの場合や ~withCredentials~ の場合に ~cookies.read~ が走る。\n\nCookiesの定義元を読んで見る。\n\n[[https://github.com/axios/axios/blob/503418718f669fcc674719fd862b355605d7b41f/lib/helpers/cookies.js#L9-L43][axios/lib/helpers/cookies.js]]:\n\n#+begin_src js\n  (function standardBrowserEnv() {\n    return {\n      write: function write(name, value, expires, path, domain, secure) {\n        var cookie = [];\n        cookie.push(name + '=' + encodeURIComponent(value));\n\n        if (utils.isNumber(expires)) {\n          cookie.push('expires=' + new Date(expires).toGMTString());\n        }\n\n        if (utils.isString(path)) {\n          cookie.push('path=' + path);\n        }\n\n        if (utils.isString(domain)) {\n          cookie.push('domain=' + domain);\n        }\n\n        if (secure === true) {\n          cookie.push('secure');\n        }\n\n        document.cookie = cookie.join('; ');\n      },\n\n      read: function read(name) {\n        var match = document.cookie.match(new RegExp('(^|;\\\\s*)(' + name + ')=([^;]*)'));\n        return (match ? decodeURIComponent(match[3]) : null);\n      },\n\n      remove: function remove(name) {\n        this.write(name, '', Date.now() - 86400000);\n      }\n    };\n  })() :\n#+end_src\n\n~document.cookie~ から取得してきている。\n~document.cookie~ のMDNはこれだ。\n\n[[https://developer.mozilla.org/ja/docs/Web/API/Document/cookie]]\n",
  "backlinks": []
}