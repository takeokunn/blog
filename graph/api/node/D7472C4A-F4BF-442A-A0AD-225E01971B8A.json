{
  "id": "D7472C4A-F4BF-442A-A0AD-225E01971B8A",
  "title": "GitHub Actions上でtblsを使ってスキーマ情報を取得してAIでSQLを生成する",
  "raw": ":PROPERTIES:\n:ID:       D7472C4A-F4BF-442A-A0AD-225E01971B8A\n:END:\n#+TITLE: GitHub Actions上でtblsを使ってスキーマ情報を取得してAIでSQLを生成する\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-06-28T16:53:54+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting tbls\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\n日頃から [[https://github.com/k1LoW/tbls][k1LoW/tbls]] を 利用しているが、個人的に気に入ってる運用をメモしておく。\n\n* 試したこと・やったこと\n** 1. GitHub ActionsでDBに入れつつtblsを実行する\n\n[[https://k1low.hatenablog.com/entry/2023/02/16/093315][tblsをセットアップするGitHub Actionとしてsetup-tbls（を作るツールとしてgh-setup）を作った]] にもあるとおり、[[https://github.com/k1low/setup-tbls][k1low/setup-tbls]] を利用すればGitHub Actions上でtblsを簡単に利用できる。\n\n以下はISUCONで使っているGitHub Actionsだが、Laravelでも同じように =php artisan migrate= すればよい。\n=main= branchにpushされたら更新される。\n\n1. MySQLのセットアップ\n2. tblsをインストール\n3. DBにスキーマ情報を反映\n4. tbls docを実行する\n5. dbdoc branchに =./dbdoc= を反映してpushする\n\n#+begin_src yaml\n  name: Run db_tbls\n\n  on:\n    workflow_dispatch:\n    push:\n      branches:\n        - main\n\n  permissions:\n    contents: write\n\n  jobs:\n    db-tbls:\n      runs-on: ubuntu-latest\n      timeout-minutes: 300\n      services:\n        mysql:\n          image: mysql:8\n          options: --health-cmd \"mysqladmin ping -h localhost\" --health-interval 20s --health-timeout 10s --health-retries 10\n          ports:\n            - 3306:3306\n          env:\n            MYSQL_DATABASE: isuride\n            MYSQL_ROOT_PASSWORD: isucon\n            MYSQL_ROOT_HOST: '%'\n      steps:\n        - uses: actions/checkout@v4\n        - uses: k1low/setup-tbls@v1\n\n        - name: Run schema.sql\n          run: mysql --host=\"127.0.0.1\" --port=3306 --user=\"root\" --password=\"isucon\" isuride < webapp/sql/1-schema.sql\n\n        - name: Run tbls for generate database document\n          run: tbls doc --dsn \"mysql://root:isucon@127.0.0.1:3306/isuride\"\n\n        - name: Deploy dbdob\n          uses: peaceiris/actions-gh-pages@v4\n          with:\n            github_token: ${{ secrets.GITHUB_TOKEN }}\n            publish_dir: ./dbdoc\n            publish_branch: dbdoc\n#+end_src\n** 2. dbdoc repoを用意する\n\n=<repo-name>-dbdoc>= を用意する。\n\n#+begin_src console\n  $ ghq get git@github.com:takeokunn/test-repo.git\n  $ mv ~/ghq/github.com/takeokunn/test-repo ~/ghq/github.com/takeokunn/test-repo-dbdoc\n  $ git checkout origin/main\n#+end_src\n\n[[id:57E8F735-BD82-49F9-BE50-6740DAF4F603][個人的Local環境のGit Branch運用について]] にも書いたとおり、local branchを作らずに定期的に =git fetch -p= をする。\n\n#+begin_src console\n  $ cd ~/ghq/github.com/takeokunn/test-repo-dbdoc\n  $ git fetch -p\n  $ git branch -D main\n#+end_src\n** 3. AI AgentでSQLを生成する\n\n自分の場合は [[https://aider.chat/][aider]] だが、適当なAI AgentにSQLを作成させる。\n\n#+begin_src markdown\n  ユーザ数を計算するSQLを作成して\n#+end_src\n* 得られた結果・所感\n\n運用フローが固まったのでかなりSQLを書くハードルが下がった。\ntblsがCIフレンドリーだからこそできる運用フローなので作者のk1Lowさんに感謝。\n\n* 今後の展開・検討事項\n\nSQLを精度高く生成させるプロンプトを用意する。\n",
  "backlinks": []
}