{
  "id": "85A5A5FA-92DA-491F-8CDC-FC1442F77DD7",
  "title": "nixpkgsのunstableでEmacs Nativecomp Buildができない問題とワークアラウンド",
  "raw": ":PROPERTIES:\n:ID:       85A5A5FA-92DA-491F-8CDC-FC1442F77DD7\n:END:\n#+TITLE: nixpkgsのunstableでEmacs Nativecomp Buildができない問題とワークアラウンド\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-04-17T00:18:12+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting emacs nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\n2025年4月16日現在、 =aarch64-darwin= 環境でnixpkgs unstableのemacs（nativecomp）をビルドできない問題が発生している。\n\n* ワークアラウンド方法\n\npackageに =withNativeCompilation = false;= を書く。\n\nhttps://github.com/NixOS/nixpkgs/blob/e51f02babf0ecf7d66e081917e609ae2c3d43ef2/pkgs/applications/editors/emacs/make-emacs.nix#L69\n\nhome-managerをoverlayする場合:\n\n#+begin_src nix\n  { emacs-overlay }:\n  [\n    (import emacs-overlay)\n\n    # bug: https://github.com/NixOS/nixpkgs/issues/395169\n    (final: prev: {\n      emacs = prev.emacs.override {\n        withNativeCompilation = false;\n      };\n      emacs-unstable = prev.emacs-unstable.override {\n        withNativeCompilation = false;\n      };\n      emacs-git = prev.emacs-git.override {\n        withNativeCompilation = false;\n      };\n    })\n  ]\n#+end_src\n\npkgsをoverrideする場合:\n\n#+begin_src nix\n  { pkgs }:\n  pkgs.emacs.override {\n    withNativeCompilation = false;\n  }\n#+end_src\n\n* 原因\n\n「emacs: fails to launch on macOS Sequoia 15.4 #395169」に纏まってる。\nhttps://github.com/NixOS/nixpkgs/issues/395169\n\nmacOS Sequoia 15.4でLC_RPATHが重複して登録されると =Duplicate LC_RPATH are deprecated= で落ちるようになった。\n\n次のようなshell scriptを実行することで解決しているDraft PRがあるが、まだ時間がかかりそうな印象。\nhttps://github.com/NixOS/nixpkgs/pull/398156\n\n#+begin_src bash\n  # maxOS Sequoia 15.4 updated their link-loader to refuse to evaluate\n  # dylibs that include duplciate LC_RPATH instructions. Some libraries\n  # haven't properly fixed this yet, and some internal NixOS builds seem\n  # to cause this type of issue to occur. This hook simply cleans up any\n  # duplicates detected inside dylib files.\n\n  fixupOutputHooks+=('fixDarwinDuplicateRpathsIn $prefix')\n\n  removeDarwinDuplicateRpaths() {\n      dylib_path=$1\n      duplicates=$(@targetPrefix@otool -l \"$dylib_path\" | awk '/cmd LC_RPATH/{getline; getline; paths[$2]+=1} END { for (p in paths) if (paths[p]>1) print p }')\n      if [ -n \"$duplicates\" ]; then\n          echo \"$dylib_path: removing duplicates\"\n          echo \"$duplicates\"\n          while IFS= read -r dup; do\n              @targetPrefix@install_name_tool $dylib_path -delete_rpath \"$dup\"\n          done <<< \"$duplicates\"\n      fi\n  }\n\n  fixDarwinDuplicateRpathsIn() {\n      local dir=\"$1\"\n      dirs=$(find $dir -name \"*.dylib\")\n      if [ -n \"$dirs\" ]; then\n          while IFS= read -r dylib_path; do\n              removeDarwinDuplicateRpaths $dylib_path\n          done <<< \"$dirs\"\n      fi\n  }\n#+end_src\n\n* 終わりに\n\nnativecompが有効になってなくても速度面でストレスはないので、暫くはこの運用を続けようと思う。\n",
  "backlinks": []
}