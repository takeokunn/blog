{
  "id": "5F8E307D-D488-4608-B479-8D3DE71E697A",
  "title": "localhost:0 でサーバを立てると空いてるエフェメラルポートが割り当てられる",
  "raw": ":PROPERTIES:\n:ID:       5F8E307D-D488-4608-B479-8D3DE71E697A\n:END:\n#+TITLE: localhost:0 でサーバを立てると空いてるエフェメラルポートが割り当てられる\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-07-16T16:16:52+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting network\n#+HUGO_DRAFT: true\n#+STARTUP: fold\n* 背景・動機\n\nhttps://x.com/songmu/status/1945140892844875894\n\n* 試したこと・やったこと\n** 1. 実際に立ててみる\n#+begin_src bash\n  $ nix run nixpkgs#php -- -S localhost:0\n  [Wed Jul 16 00:19:32 2025] PHP 8.4.10 Development Server (http://localhost:59439) started\n#+end_src\n** 2. RFCを読む\n#+begin_example\n- 内容: TCP/IPとして port 0 自体は予約されておらず、使用すべきでないポート番号とされている。\n- RFC参考: RFC 6335 「0番ポートは使用不可（“Reserved”）」と明示。\n- 解釈: 通信に使うべきではないが、bind(0) というAPIレベルでの「ポート番号の省略記法」として利用されている。\n#+end_example\n** 3. 実装を読む\n#+begin_example\nLinux: inet_bind()で port == 0 のとき inet_csk_get_port() で動的に空きポートを探して割り当てる。\n\n関連ソースファイル：\n\t•\tnet/ipv4/inet_connection_sock.c\n\t•\tnet/ipv4/inet_sock.c\n\t•\tnet/ipv4/af_inet.c\n\n処理の流れ（概要）：\n\t1.\tsys_bind() → inet_bind()（af_inet.c）\n\t2.\tport == 0 の場合：\n\t•\tinet_csk_get_port() が呼ばれる\n\t•\tこの関数が空きポートを検索して、該当ポートをソケットに割り当てる\n\t3.\t成功すれば inet->inet_num にセットされ、以後 getsockname() 等で取得できる\n#+end_example\n* 得られた結果・所感\n\n- 無事確認が取れた\n- なにげないツイートだったけど勉強になった\n\n* 今後の展開・検討事項\n今後新規でプロジェクトを立てる時はこれで良さそう。個人のプロジェクトで実践してみる。\n",
  "backlinks": []
}