{
  "id": "861C8003-2791-4BF3-8126-489838D804F9",
  "title": "お名前comからCloudflareにドメイン移管してTerraformで管理する",
  "raw": ":PROPERTIES:\n:ID:       861C8003-2791-4BF3-8126-489838D804F9\n:END:\n#+TITLE: お名前comからCloudflareにドメイン移管してTerraformで管理する\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-04-03T22:05:33+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting terraform\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\nお名前comで管理していた =takeokunn.org= をCloudflareに移管したのでメモしておく。\n\n* Background\n\nお名前comには世の中のエンジニアと同じように、長年次の不満を抱えていた。\n\n- 管理画面がとにかく使いづらい\n- 広告・営業メールが多い\n- 自動更新やオプションの設定が本当に分かりづらい\n- IaCに対応していない\n\nvim-jpで令和時代にドメインを管理するならCloudflare一択という意見をもらったので移管した。\n\n* 作業手順\n\nドメインの移管はじめてだったこと、個人ドメインであることからダウンタイムが発生許容した。\n2と3を入れ替えればダウンタイムが発生しなかったかもしれない。\n\n** 1. Cloudflareにアカウントを作成する\n\n公式サイトから新規登録をしてクレジットカードを登録する。\n\n[[https://www.cloudflare.com/ja-jp/][https://www.cloudflare.com/ja-jp/]]\n\n** 2. お名前comからCloudflareに移管する\n\n[[https://zenn.dev/muchoco/articles/9039762136e15c][お名前.com から Cloudflare Registrar にドメイン移管した話 - Zenn]] を参考に移管した。\n\n「トランスファー申請の承認」が15分以上かかったがいずれ来るので気長に待てばよい。\n** 3. Terraformで管理する\n\nTerraform Cloudflare Providerを使う。\n\n[[https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs][https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs]]\n\n*** 3.1 provider作成\n\n[[https://github.com/getsops/sops][sops]] にAPI Tokenを保存して [[https://github.com/carlpett/terraform-provider-sops][terraform-provider-sops]] 経由で入れる。\n\n#+begin_src terraform\n  terraform {\n    required_providers {\n      sops = {\n        source  = \"carlpett/sops\"\n        version = \"~> 0.5\"\n      }\n      cloudflare = {\n        source  = \"cloudflare/cloudflare\"\n        version = \"~> 5\"\n      }\n    }\n  }\n\n  provider \"sops\" {}\n\n  data \"sops_file\" \"secret\" {\n    source_file = \"./secrets.yaml\"\n  }\n\n  provider \"cloudflare\" {\n    api_token = data.sops_file.secret.data.cloudflare\n  }\n#+end_src\n*** 3.2 レコード作成\n#+begin_src terraform\n  locals {\n    # for takeokunn.org\n    takeokunn_org_zone_id = \"xxx\"\n  }\n\n  resource \"cloudflare_dns_record\" \"a_records\" {\n    provider = cloudflare\n    for_each = toset([\n      \"185.199.108.153\",\n      \"185.199.109.153\",\n      \"185.199.110.153\",\n      \"185.199.111.153\"\n    ])\n    zone_id = local.takeokunn_org_zone_id\n    name    = \"takeokunn.org\"\n    content = each.key\n    type    = \"A\"\n    ttl     = 1\n    proxied = false\n  }\n\n  resource \"cloudflare_dns_record\" \"cname_emacs\" {\n    zone_id = local.takeokunn_org_zone_id\n    name    = \"emacs.takeokunn.org\"\n    content = \"takeokunn.github.io\"\n    type    = \"CNAME\"\n    ttl     = 1\n    proxied = false\n  }\n#+end_src\n** 4. 管理画面から確認する\n\n正常に =terraform apply=  されていることを確認する。\n\n[[file:../../static/images/67154738-5226-46D6-80F3-959E0BD1F962.png]]\n\n* 終わりに\n\nお名前comからの脱却と、手元環境のTerraform化が進んできて非常によい。\n\n- [[id:4E845C70-F095-47B3-BF75-F6872164BD43][NextDNSを導入した]]\n- [[id:A942A0CA-829F-45C0-A9CC-F7CA8C0DE873][Terraform GitHub Providerを導入した]]\n",
  "backlinks": [
    {
      "title": "private-terraformをHCP Terraformに移行した",
      "source": "FFA7027E-161A-498C-AD36-C0033C7A9CD6"
    }
  ]
}