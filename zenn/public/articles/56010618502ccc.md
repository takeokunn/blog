---
title: "Emacsã‚’ä¸–ç•Œæœ€é€Ÿç´šã§èµ·å‹•ã™ã‚‹æ–¹æ³•"
emoji: "ğŸ–‹ï¸"
type: "tech"
topics:
  - "emacs"
published: true
published_at: "2022-12-18 02:49"
---

[Emacs Advent Calendar 2022](https://qiita.com/advent-calendar/2022/emacs) 19æ—¥ç›®ã§ã™ã€‚

[Vim Advent Calendar 2022](https://qiita.com/advent-calendar/2022/vim) 3æ—¥ç›®ã® [çˆ†é€Ÿã§èµ·å‹•ã™ã‚‹ Neovim ã‚’ä½œã‚‹](https://qiita.com/delphinus/items/fb905e452b2de72f1a0f) ã«è§¦ç™ºã•ã‚Œã¦ã€ã€Œè‡ªåˆ†ã‚‚Emacsç‰ˆã‚’æ›¸ãã!ã€ã¨ã„ã†ã“ã¨ã§æ›¸ã„ã¦ã„ãã¾ã™ã€‚

ãªãŠã€Vimã¨Emacsã®æ¯”è¼ƒã‚’ã—æ˜“ãã™ã‚‹ãŸã‚ã«ãªã‚‹ã¹ãæ–‡ç« ã®æ§‹æˆã‚’å¯„ã›ã¦æ›¸ãã“ã¨ã‚’ã”äº†æ‰¿ãã ã•ã„ã€‚


# ã¯ã˜ã‚ã«

ã€ŒEmacsã‚’é«˜é€Ÿã«èµ·å‹•ã™ã‚‹ã€ã¨ã„ã†ã“ã¨ã«å¯¾ã—ã¦ã€å¤šãã®Emacsãƒ¦ãƒ¼ã‚¶ã¯èˆˆå‘³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ æœ¬æ¥Emacsã¨ã„ã†ã®ã¯å¸¸ã«èµ·å‹•ã—ç¶šã‘ã‚‹ã‚‚ã®ã§ã‚ã‚Šã€å¿…è¦ã«å¿œã˜ã¦Emacs Lispã‚’é©ç”¨ã—ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã„ãã‚‚ã®ã§ã™ã€‚ ç¾ã«ã€ŒEmacs, èµ·å‹•, é«˜é€ŸåŒ–ã€ã¨æ¤œç´¢ã™ã‚‹ã¨ã€ã€Œ4000msã‚’1000msã«ã—ãŸã€ã®ã‚ˆã†ãªç§’å˜ä½ã§ã®é«˜é€ŸåŒ–ã®è¨˜äº‹ã°ã‹ã‚Šã¿ã¤ã‹ã‚Šã¾ã™ã€‚

ã‚‚ã—è²´æ–¹ãŒè¨­å®šã‚’å¤‰ãˆãšã«æ‰‹è»½ã«é«˜é€Ÿã«èµ·å‹•ã—ãŸã„å ´åˆã¯ `emacs --daemon` ã§daemonã‚’ç«‹ã¡ä¸Šã’ã€ `emacsclient` ã§ç¹‹ãã‚ˆã†ã«ã™ã‚Œã°è‰¯ã„ã§ã—ã‚‡ã†ã€‚ ç§ã¯ä»–äººã®dotfilesã‚’èª­ã‚€ã®ãŒè¶£å‘³ãªã®ã§ã™ãŒã€å¤šãã®Emacsãƒ¦ãƒ¼ã‚¶ã¯ `EDITOR=emacsclient` ã¨è¨­å®šã—ã¦ã„ã¾ã™ã€‚

ã¾ãŸã€èµ·å‹•æ™‚é–“ã®ã¿ã‚’è€ƒæ…®ã™ã‚‹ãªã‚‰ `~/.emacs.d/init.el` ã‚’å‰Šé™¤ã—ã¦ç´ ã§èµ·å‹•ã™ã‚Œã°è‰¯ã„ã§ã—ã‚‡ã†ã€‚ ãã†ãªã‚‹ã¨ç´”ç²‹ã«ãƒã‚·ãƒ³ã‚¹ãƒšãƒƒã‚¯ã®å‹è² ã«ãªã‚Šã¾ã™ã€‚ Emacsã¯ç´ ã®çŠ¶æ…‹ã§ã‚‚ååˆ†é­…åŠ›çš„ãªæ©Ÿèƒ½ã‚’å¤šæ•°ç››ã‚Šè¾¼ã¾ã‚Œã¦ã„ã‚‹ãŒã€ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ã“ãçœŸä¾¡ã‚’ç™ºæ®ã™ã‚‹ã‚¨ãƒ‡ã‚£ã‚¿ãªã®ã§ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã¨ã—ã¦ã¯ã‚¤ãƒã‚¤ãƒã§ã—ã‚‡ã†ã€‚

ã“ã®è¨˜äº‹ã‚’èª­ã‚€å‰ã« [Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4) ã‚’ç†Ÿèª­ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¦ã„ã¾ã™ã€‚ ç‰¹ã«ä»¥ä¸‹ã®Chapterã¯éå¸¸ã«æœ‰ç›Šãªãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ãŒè©°ã‚è¾¼ã¾ã‚Œã¦ãŠã‚Šã€å¤§å¹…ãªé€Ÿåº¦æ”¹å–„ã‚’è¦‹è¾¼ã‚ã¾ã™ã€‚

-   [autoload ã¨ with-eval-after-load](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/abb04ff2351b3564a1a0)
-   [æ“¬ä¼¼éåŒæœŸãƒ­ãƒ¼ãƒ‰ã«ã‚ˆã‚‹"å¾…ãŸã•ã‚Œæ„Ÿ"æ”¹å–„](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/c47f8eb7cd547b95ba91)
-   [ãã®ä»–ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ï¼šä¸è¦ãªå‡¦ç†ã‚’çœããƒãƒƒã‚¯ãŸã¡](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/dcebc13578d42055f8a4)

æœ¬ã®ã‚ã‚‰ã™ã˜ã«ã‚‚æ›¸ã„ã¦ã‚ã‚‹é€šã‚Šã€Emacsè‡ªä½“ã«æ—¢ã«å¤§é‡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹çŠ¶æ…‹ã§é«˜é€Ÿã«èµ·å‹•ã™ã‚‹æ™‚ç‚¹ã§è‡ªåˆ†ã®è¨­å®šã‚’è¦‹ç›´ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„ã“ã¨ã¯æ˜ç™½ã§ã—ã‚‡ã†ã€‚

> ã—ã‹ã—ã€è€ƒãˆã¦ã¿ã‚Œã° Emacs ã«ã¯ 1000 ä»¥ä¸Šã® Emacs Lisp ãƒ•ã‚¡ã‚¤ãƒ«ãŒåˆã‚ã‹ã‚‰åŒæ¢±ã•ã‚Œã¦ã„ã‚‹ã‚ã‘ã§ã€ãã“ã«æ•°åã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’è¶³ã—ãŸã ã‘ã§çˆ†è£‚ã«é…ããªã‚‹ã®ã¯ã€ãªã«ã‹è¨­å®šã«ã‚‚å•é¡ŒãŒã‚ã‚‹æ°—ãŒã—ã¾ã™ã€‚

è©³ç´°ã¯å¾Œè¿°ã—ã¾ã™ãŒã€ç¾åœ¨ã®ç§ã®Emacsã¯15ã€œ25msç¨‹åº¦ã§èµ·å‹•ã‚’ã—ã¾ã™ã€‚ ä¸€åˆ‡è¨­å®šã‚’èª­ã¾ãšã«ç´ ã§èµ·å‹•ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ `emacs -Q` ã§èµ·å‹•ã•ã›ã‚‹ã¨2msç¨‹åº¦ã§ã™ã€‚ ã¾ã ã¾ã é«˜é€Ÿã«èµ·å‹•ã•ã›ã‚‹ä½™åœ°ã¯ã‚ã‚Šã¾ã™ãŒã€ã€Œé«˜é€Ÿã«èµ·å‹•ã•ã›ã‚‹ã“ã¨ãŒã§ãã¦ã„ã‚‹ã€ã¨è‡ªè² ã—ã¦ã‚‚å•é¡Œãªã„ã§ã—ã‚‡ã†ã€‚

    Emacs booting time: 20 [msec] = â€˜emacs-init-timeâ€™.
    Loading init files: 10 [msec], of which 1 [msec] for â€˜after-init-hookâ€™.

https://twitter.com/takeokunn/status/1604444680896200704?s=20&t=WjnQVUt7OiBANmOBkEEJlw

# å‰æ


## ç’°å¢ƒ

2022å¹´12æœˆç¾åœ¨ã€ `Macbook Pro 16-inch, 2019` ã®æ¨™æº–ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

```shell
$ neofetch
                    'c.          take@obaranoMacBook-Pro.local
                 ,xNMM.          -----------------------------
               .OMMMMo           OS: macOS 13.1 22C65 x86_64
               OMMM0,            Host: MacBookPro16,1
     .;loddo:' loolloddol;.      Kernel: 22.2.0
   cKMMMMMMMMMMNWMMMMMMMMMM0:    Uptime: 1 day, 18 hours, 29 mins
 .KMMMMMMMMMMMMMMMMMMMMMMMWd.    Packages: 347 (brew)
 XMMMMMMMMMMMMMMMMMMMMMMMX.      Shell: fish 3.5.1
;MMMMMMMMMMMMMMMMMMMMMMMM:       Resolution: 1792x1120@2x
:MMMMMMMMMMMMMMMMMMMMMMMM:       DE: Aqua
.MMMMMMMMMMMMMMMMMMMMMMMMX.      WM: Quartz Compositor
 kMMMMMMMMMMMMMMMMMMMMMMMMWd.    WM Theme: Blue (Dark)
 .XMMMMMMMMMMMMMMMMMMMMMMMMMMk   Terminal: tmux
  .XMMMMMMMMMMMMMMMMMMMMMMMMK.   CPU: Intel i7-9750H (12) @ 2.60GHz
    kMMMMMMMMMMMMMMMMMMMMMMd     GPU: Intel UHD Graphics 630, AMD Radeon Pro 5300M
     ;KMMMMMMMWXXWMMMMMMMk.      Memory: 9716MiB / 16384MiB
       .cooc,.    .,coo:.
```

Emacsã®versionã¯ `30.0.50` ã§ã™ã€‚ æ—¥ã€…HEAD buildã‚’ã—ã¦ã„ã‚‹ã®ã§stableã®versionã¨ã¯å¾®å¦™ã«å·®ç•°ãŒã‚ã‚Šã¾ã™ãŒã€èµ·å‹•é€Ÿåº¦ã«ã¯ãã“ã¾ã§å¤§ããªå·®ãŒå‡ºãªã„ã§ã—ã‚‡ã†ã€‚

```shell
$ emacs -version
GNU Emacs 30.0.50
Development version 6a390fd42ec4 on master branch; build date 2022-12-17.
Copyright (C) 2022 Free Software Foundation, Inc.
GNU Emacs comes with ABSOLUTELY NO WARRANTY.
You may redistribute copies of GNU Emacs
under the terms of the GNU General Public License.
For more information about these matters, see the file named COPYING.
```


## è¨­å®šã«ã¤ã„ã¦

-   [takeokunn/.emacs.d](https://github.com/takeokunn/.emacs.d)
-   [init.el](https://emacs.takeokunn.org/)
-   [early-init](https://emacs.takeokunn.org/early-init)

2022å¹´ç¾åœ¨ã€ `init.el` ã¨ `early-init.el` ã¯6800è¡Œ(ç©ºç™½ã‚’é™¤ãã¨5800è¡Œ)ç¨‹åº¦ã‚ã‚Šã¾ã™ã€‚ è¨­å®šã‚’åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ‡ã‚Šåˆ†ã‘ãŸã‚Šã—ã¦ãŠã‚‰ãšã€ `init.el` 1ã¤ã§ç®¡ç†ã‚’ã—ã¦ã„ã¾ã™ã€‚

å…¨ã¦ã®è¨­å®šã‚’ `org-mode` ã§ç®¡ç†ã—ã¦ãŠã‚Šã€GitHub Actionsã§buildã‚’ã—GitHub Pagesã«hostingã—ã¦ã„ã¾ã™ã€‚

`el-get` ã§å°å…¥ã—ã¦ã„ã‚‹packageæ•°ã¯384å€‹ã§ã™ã€‚

```shell
$ ls -l ~/.emacs.d/el-get | wc -l
     384
```


# èµ·å‹•é€Ÿåº¦ã®æ¸¬ã‚Šæ–¹


## ãã‚‚ãã‚‚èµ·å‹•é€Ÿåº¦ã¨ã¯ãªã‚“ãªã®ã‹

Emacsã¯ã–ã£ãã‚Šä»¥ä¸‹ã®ã‚ˆã†ãªèµ·å‹•ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¸ã¿ã¾ã™ã€‚

-   bootå‡¦ç†(Cè¨€èª)
-   [lisp/startup.el](https://github.com/emacs-mirror/emacs/blob/master/lisp/startup.el) ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹
-   [normal-top-level](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L577-L850) ãŒå®Ÿè¡Œã•ã‚Œã‚‹
-   [command-line](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1125-L1639) ãŒå®Ÿè¡Œã•ã‚Œã‚‹
-   `~/.emacs.d/early-init.el` ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹
    -   [https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1358-L1367](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1358-L1367)
-   `~/.emacs.d/init.el` ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹
    -   [https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1482-L1507](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1482-L1507)

Emacsè‡ªä½“ã«patchã‚’å½“ã¦ãªã„é™ã‚Šã€ `~/.emacs.d/early-init.el` ã‚ˆã‚Šå‰ã«ã¯æ‰‹ãŒå‡ºã›ã¾ã›ã‚“ã€‚ [lisp/proced.el](https://github.com/emacs-mirror/emacs/blob/master/lisp/proced.el) ã®ã‚ˆã†ãªæ—¢å­˜ã®Emacs Lispãƒ•ã‚¡ã‚¤ãƒ«ã¯[portable dumper](https://www.emacswiki.org/emacs/DumpingEmacs)ã§æ—¢ã«å®Ÿè¡Œå¯èƒ½ãªbinaryã«å‡ºåŠ›ã•ã‚Œã¦ãŠã‚Šã€fileã‚’loadã™ã‚‹ã“ã¨ãªãå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

Emacsã®buildæ™‚ã«è‡ªåˆ†ã® `init.el` ã‚’èª­ã¿è¾¼ã¾ã›ã¦ `pdump` ã‚’ç”Ÿæˆã™ã‚‹ã®ãŒçœŸã®æœ€é€Ÿã§ã‚ã‚Šã€5msä»¥å†…ã§ã®èµ·å‹•ã‚’æœŸå¾…ã§ãã¾ã™ã€‚ ãŸã¨ãˆè¨˜è¿°ãŒã»ã¼ç„¡ã„ã¨ã—ã¦ã‚‚ `init.el` ã¨ `early-init.el` ã‚’èª­ã¿è¾¼ã¿å®Ÿè¡Œã™ã‚‹ã¨ã„ã†ã®ã¯é‡ã„ã‚‚ã®ã§ã€File I/Oã¨ã„ã†ã®ã¯é‡ã„ã‚‚ã®ã ã¨å®Ÿæ„Ÿã•ã›ã‚‰ã‚Œã¾ã—ãŸã€‚ ã—ã‹ã—ã€ãã‚Œã§ã¯Emacsã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§ã¨ã„ã†ã®ã‚’æ®ºã™ã“ã¨ã«ãªã‚‹ã®ã§ä»Šå›ã¯å«ã‚ãªã„ã“ã¨ã¨ã—ã¾ã™ã€‚


## è¨ˆæ¸¬æ–¹æ³•

`init.el` ã«ä»¥ä¸‹ã®ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

```emacs-lisp
(defconst my/before-load-init-time (current-time))

;;;###autoload
(defun my/load-init-time ()
  "Loading time of user init files including time for `after-init-hook'."
  (let ((time1 (float-time
                (time-subtract after-init-time my/before-load-init-time)))
        (time2 (float-time
                (time-subtract (current-time) my/before-load-init-time))))
    (message (concat "Loading init files: %.0f [msec], "
                     "of which %.f [msec] for `after-init-hook'.")
             (* 1000 time1) (* 1000 (- time2 time1)))))
(add-hook 'after-init-hook #'my/load-init-time t)

(defvar my/tick-previous-time my/before-load-init-time)

;;;###autoload
(defun my/tick-init-time (msg)
  "Tick boot sequence at loading MSG."
  (when my/loading-profile-p
    (let ((ctime (current-time)))
      (message "---- %5.2f[ms] %s"
               (* 1000 (float-time
                        (time-subtract ctime my/tick-previous-time)))
               msg)
      (setq my/tick-previous-time ctime))))

(defun my/emacs-init-time ()
  "Emacs booting time in msec."
  (interactive)
  (message "Emacs booting time: %.0f [msec] = `emacs-init-time'."
           (* 1000
              (float-time (time-subtract
                           after-init-time
                           before-init-time)))))

(add-hook 'after-init-hook #'my/emacs-init-time)
```

å‚è€ƒè¨˜äº‹ã¯ã“ã¡ã‚‰ã€‚

-   [èµ·å‹•æ™‚é–“ã‚’è¨ˆæ¸¬ã™ã‚‹ æ”¹è¨‚ç‰ˆ - ã™ãã‚ƒãƒ¼ã‚“ãƒ¡ãƒ¢](https://memo.sugyan.com/entry/20120120/1327037494)
-   [init.org - takaxp/emacs.d](https://github.com/takaxp/emacs.d/blob/master/init.org#241-emacs-%E8%B5%B7%E5%8B%95%E6%99%82%E3%81%AE%E5%91%BC%E3%81%B3%E5%87%BA%E3%81%97%E9%A0%86)

ãã†ã™ã‚‹ã¨èµ·å‹•å¾Œ `*Minibuffer*` ã«èµ·å‹•æ™‚é–“ã®å‡ºåŠ›ãŒã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

    Emacs booting time: 20 [msec] = â€˜emacs-init-timeâ€™.
    Loading init files: 10 [msec], of which 1 [msec] for â€˜after-init-hookâ€™.


## è©•ä¾¡ã®ä»•æ–¹

é«˜é€ŸåŒ–ã™ã‚‹ä¸Šã§é‡è¦ãªã®ã¯ã€è©•ä¾¡æŒ‡æ¨™ã‚’ãƒã‚·ãƒ³ã‚¹ãƒšãƒƒã‚¯ã«ä¾å­˜ã—ãªã„å½¢ã§è©•ä¾¡ã‚’ã™ã‚‹ã“ã¨ã§ã—ã‚‡ã†ã€‚

ä»¥ä¸‹ã®ã‚ˆã†ãª `init.el` ã‚’ä½œæˆã™ã‚Œã°ã€èµ·å‹•æ™‚ã«ã©ã®ã‚ˆã†ãªå‡¦ç†ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹ã®ã‹çŸ¥ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

`init.el`:

```emacs-lisp
(require 'profiler)
(profiler-start 'cpu)

;;; --------- å‡¦ç†ä¸­ç•¥ ---------

(profiler-report)
(profiler-stop)
```

ä¸Šè¨˜ã®ã‚ˆã†ãªã€å‡¦ç†ãŒç©ºã® `init.el` ã‚’ç”¨æ„ã—ã¦èµ·å‹•ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ãªreport bufferãŒèµ·å‹•ã™ã‚‹ã§ã—ã‚‡ã†ã€‚

    Samples    %   Function
          7 100% - normal-top-level
          7 100%  - command-line
          7 100%   - startup--load-user-init-file
          7 100%    - load
          7 100%       byte-code
          0   0% + ...

å¤šå°‘ãƒ–ãƒ¬ãŒã‚ã‚‹ã‚‚ã®ã®ã€è‡ªåˆ†ã® `init.el` ã§å®Ÿè¡Œã‚’ã™ã‚‹ã¨Samplesæ•°ãŒ15ä»¥å†…ã§èµ·å‹•ã—ã¾ã™ã€‚ Sampleæ•°ãŒç´ ã«è¿‘ã‘ã‚Œã°è¿‘ã„ã»ã©ã€é«˜é€Ÿã«å‹•ã„ã¦ã„ã‚‹ã¨è¨€ãˆã¾ã™ã€‚


# ã“ã®è¨˜äº‹ã§é”æˆã™ã‚‹ç›®æ¨™

çš†ã•ã‚“ã®Emacsã®èµ·å‹•é€Ÿåº¦ã¯ã©ã†ã§ã—ã‚‡ã†ã‹ï¼Ÿ ç§ã®æ„Ÿè¦šã«ãªã‚Šã¾ã™ãŒã€å¤§ä½“ä»¥ä¸‹ã®ã‚ˆã†ã«åˆ†é¡ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚

-   5000msä»¥ä¸Š
    -   ã ã„ã¶é…ã„
    -   å¤–éƒ¨ã¸ã®é€šä¿¡(ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®æ›´æ–°ç­‰)ãŒå¤šæ•°èµ°ã£ã¦ã—ã¾ã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„
-   1000ms ã€œ 5000ms
    -   ä¸€èˆ¬çš„ãªé€Ÿåº¦
    -   å¤§ä½“ã®Emacsãƒ¦ãƒ¼ã‚¶ã¯ã“ã®è¾ºã ã‚ã†
    -   ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚’æ™®é€šã«ä½¿ã£ã¦æ™®é€šã«è¨­å®šã—ã¦ã‚‹ã¨ã“ã®ãã‚‰ã„
-   100ms ã€œ 1000ms
    -   ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã§é«˜é€ŸåŒ–ã‚’ã™ã‚‹ã¨å¤§ä½“ã“ã®è¾ºã«ãªã‚‹
    -   ãã“ãã“é ‘å¼µã‚‹å¿…è¦ãŒã‚ã‚‹
-   100msä»¥ä¸‹
    -   å…¨ã¦ã®è¨­å®šã‚’ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã‚ãšã«ç´ ã§æ›¸ã„ã¦ã„ã‚‹ã‹ã€é«˜é€ŸåŒ–ã«æ‹˜ã£ãŸè¨­å®šã‚’ã—ã¦ã„ã‚‹
    -   ã‹ãªã‚Šé ‘å¼µã‚‹å¿…è¦ãŒã‚ã‚‹
    -   `EDITOR=emacs` è¨­å®šã™ã‚‹ã®ã‚’è¦–é‡ã«å…¥ã‚Œã‚‰ã‚Œã‚‹

[NeoVimã®å ´åˆ](https://qiita.com/delphinus/items/fb905e452b2de72f1a0f#3-%E3%81%93%E3%81%AE%E8%A8%98%E4%BA%8B%E3%81%A7%E9%81%94%E6%88%90%E3%81%99%E3%82%8B%E7%9B%AE%E6%A8%99)ã¯ã“ã¡ã‚‰ã€‚ NeoVimã§ã¯ã€Œ50msä»¥ä¸‹ã€ã‹ã‚‰ã€Œ500msä»¥ä¸Šã€ã‚’è©±é¡Œã«ã—ã¦ã„ã‚‹ã®ã§æ˜ã‹ã«Emacsã¯ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹ãŒé…ã„ã€‚

ã“ã®è¨˜äº‹ã§ã¯å½“ç„¶100msä»¥ä¸‹ã‚’ç›®æŒ‡ã—ã¦ã„ã‚‹ã€‚


# å…·ä½“çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–¹æ³•


## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦

å¤šãã®äººã¯ `use-package` ã‚„ `leaf` ã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã§ã—ã‚‡ã†ã€‚ `use-package` ã®å®Ÿæ…‹ã¯ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãƒ„ãƒ¼ãƒ«ã¨ã„ã†ã‚ˆã‚Šã¯macroã§ã™ã€‚

`use-package` å†…ã«é©åˆ‡ã®è¨­å®šã‚’è¨˜è¿°ã™ã‚‹ã¨ã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è½ã¨ã—ãƒ‘ã‚¹ã‚’é€šã—ã€é–¢æ•°ã‚„å¤‰æ•°ã®è¨­å®šã‚’è¨˜è¿°ã—ãŸã‚Šã™ã‚‹ `så¼` ã‚’ç”Ÿæˆã—ã¦ãã‚Œã¾ã™ã€‚ ç§ã¯ `use-package` ã«ã¯ç–ã„ã®ã§æ­£ç¢ºãªã“ã¨ã¯æ›¸ã‘ã¾ã›ã‚“ãŒã€~så¼~ ã®åŠ¹ç‡ãŒè‰¯ã„ã‹ã¨è¨€ã‚ã‚ŒãŸã‚‰æœ€é«˜é€Ÿã‚’å©ãå‡ºã›ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

æ™®é€šã«Emacsã®è¨­å®šã‚’ã™ã‚‹ãªã‚‰é–“é•ã„ãªãä½¿ã†ã¹ãã‚‚ã®ã§ã™ãŒã€ä»Šå›ã®ã‚ˆã†ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ±‚ã‚ã‚‹å ´åˆã‚ã¾ã‚Šã‚ªã‚¹ã‚¹ãƒ¡ã§ãã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚


## NativeComp


### Emacsã‚’Full NativeCompã§Buildã™ã‚‹

å¤šãã®äººã¯Homebrewã®ã‚ˆã†ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§è½ã—ã¦Buildã—ãŸEmacsã‚’ä½¿ã£ã¦ã„ã‚‹ã“ã¨ã§ã—ã‚‡ã†ã€‚ ãã‚Œã ã¨ç´°ã‹ã„buildã®è¨­å®šã‚‚ã§ããªã„ã—ã€ç—’ã„æ‰€ã«æ‰‹ãŒå±Šãã¾ã›ã‚“ã€‚

ã¾ãšã¯ `git clone` ã‚’ã—ã¾ã™ã€‚

```shell
$ git clone git://git.sv.gnu.org/emacs.git
$ cd emacs
```

æ¬¡ã«NativeCompã§buildã—ã¾ã™ã€‚ ç§ã¯æ¯æ—¥ `git pull` ã—ãŸä¸Šã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å©ã„ã¦buildã—ã¦ã„ã¾ã™ã€‚

```shell
$ ./autogen.sh && ./configure --with-native-compilation=aot --without-ns --without-x --with-libxml2=/usr/bin/xml2-config && make -j8
$ sudo make install
```

`--with-native-compilation=aot` ãŒç‰¹ã«é‡è¦ã§ã™ã€‚

[ãƒã‚¤ãƒ†ã‚£ãƒ–ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«Emacsã®ç™»å ´](https://blog.tomoya.dev/posts/hello-native-comp-emacs/)ã«æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€2021å¹´4æœˆé ƒã«Native CompãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¾ã—ãŸã€‚ `foo.el` ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ `foo.eln` ã¨ã„ã†æ‹¡å¼µå­ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ `brew install libgccjit` ãªã©ã‚’ã—ã¦ã¡ã‚ƒã‚“ã¨ `libgccjit` ã‚’installã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ [Emacsã®Native Compilationã®æ€§èƒ½ã‚’æ¸¬å®šã™ã‚‹](https://www.grugrut.net/posts/202104272222/)ã§ã‚‚æ¤œè¨¼ã•ã‚Œã¦ã„ã‚‹ãŒã€ã‹ãªã‚Šã®é«˜é€ŸåŒ–ãŒæœŸå¾…ã§ãã¾ã™ã€‚

[Add &#x2013;with-native-compilation=aot configuration option](https://github.com/emacs-mirror/emacs/commit/e245c4f226979ccb717cccc8f82b2b0a0f96bdac) ã§ `aot` ã‚’æŒ‡å®šã—ã¦buildã™ã‚‹ã¨Emacsã®Full Native CompãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ `make -j <proc>` ã§procæ•°ã‚’å¤šãã™ã‚‹ã¨å‡¦ç†ãŒé‡ã™ãã¦PCãŒå›ºã¾ã‚‹ã®ã§å°‘ãªã‚ã«è¨­å®šã—ã¦ãŠãæ–¹ãŒè‰¯ã„ã§ã™ã€‚


### NativeCompã—ãŸçµæœã®ãƒ•ã‚¡ã‚¤ãƒ«(eln)ãŒå„ªå…ˆçš„ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹

Emacs Lispã§åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‘¼ã³è¾¼ã‚€éš›ã« `(load "/path/to/dir/file")` ã®ã‚ˆã†ã«æ›¸ãã¾ã™ã€‚

å®Ÿéš›ã«ã€[command-line](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1125-L1639)ã‹ã‚‰ `init.el` ã‚„ `early-init.el` ã‚’èª­ã¿è¾¼ã‚€æ™‚ã«ã‚‚ `load` ã¯ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚

[ã‚³ãƒ¼ãƒ‰(startup&#x2013;load-user-init-file)](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1011-L1120)ã¯ã“ã“ã§ã™ã€‚

[loadé–¢æ•°ã®å®šç¾©](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/src/lread.c#L1173-L1628) ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€å„ªå…ˆçš„ã« `.eln` ã‚’èª­ã‚€ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã‚ˆã†ãªã®ã§æ—©ã‚ã«NativeCompã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


### init.elã¨early-init.elã‚’byte-compileã™ã‚‹

[ãƒã‚¤ãƒˆã‚³ãƒ³ãƒ‘ã‚¤ãƒ« - Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/972544d4b66cf5c1a75c)ã«ã¤ã„ã¦ã€‚

Byte Compileã®[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://ayatakesi.github.io/emacs/24.5/elisp_html/Byte-Compilation.html)ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªè¨˜è¿°ãŒã‚ã‚Šã¾ã™ã€‚

> Emacs Lispã«ã¯ã€Lispã§è¨˜è¿°ã•ã‚ŒãŸé–¢æ•°ã‚’ã€ã‚ˆã‚ŠåŠ¹ç‡çš„ã«å®Ÿè¡Œã§ãã‚‹ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰(byte-code)ã¨å‘¼ã°ã‚Œã‚‹ç‰¹åˆ¥ãªè¡¨ç¾ã«ç¿»è¨³ã™ã‚‹ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼(compiler)ãŒã‚ã‚Šã¾ã™ã€‚ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãƒ¼ã¯Lispã®é–¢æ•°å®šç¾©ã‚’ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã¾ã™ã€‚ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚ŒãŸã¨ãã€ãã®å®šç¾©ã¯ãƒã‚¤ãƒˆã‚³ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚¿ãƒ¼(byte-code interpreter)ã«ã‚ˆã‚Šè©•ä¾¡ã•ã‚Œã¾ã™ã€‚

ã“ã‚“ãªæ„Ÿã˜ã§byte-compileã™ã‚‹ã¨è‰¯ã„ã§ã™ã€‚

```shell
$ emacs -Q --batch -f batch-byte-compile early-init.el
$ emacs -Q --batch -f batch-byte-compile init.el
```

åŸºæœ¬çš„ã«ã¯native compãŒå„ªå…ˆçš„ã«èª­ã¾ã‚Œã‚‹ã®ã§æ„å‘³ãŒãªã„ã¨è¨€ã‚ã‚ŒãŸã‚‰ãã†ãªã®ã ãŒã€å¾Œè¿°ã™ã‚‹ `el-get` ã¯byte-compileæ™‚ã«ç™ºç«ã•ã›ã‚‹ã®ã§æµã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


### NativeCompã®è¨­å®š

`native-comp-speed` ã¨ `native-comp-async-jobs-number` ã‚’è¨­å®šã™ã‚‹ã¨è‰¯ã„ã§ã™ã€‚

`native-comp-speed` ã¯æœ€é©åŒ–ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§0ã€œ3ãŒã‚ã‚Šã¾ã™ã€‚ [ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/emacs-lisp/comp.el#L46-L58)ã¯ã“ã¡ã‚‰ã€‚ ã€ŒWarning: with 3, the compiler is free to perform dangerous optimizations.ã€ã¨æ›¸ã„ã¦ã‚ã‚Šã¾ã™ãŒã€åŠå¹´ä»¥ä¸Šã“ã®è¨­å®šã§å•é¡Œãªãä½¿ãˆã¦ã„ã‚‹ã®ã§æ°—ã«ã—ãªãã¦è‰¯ã„ã§ã—ã‚‡ã†ã€‚

`native-comp-async-jobs-number` ã¯jobæ•°ã§å¤§ãã‚ã«è¨­å®šã™ã‚‹ã¨PCãŒæ¥µç«¯ã«é‡ããªã£ã¦ã—ã¾ã†ã®ã§ä½ã‚ã«è¨­å®šã—ã¦ãŠãã“ã¨ã‚’ã‚ªã‚¹ã‚¹ãƒ¡ã—ã¾ã™ã€‚

```emacs-lisp
(with-eval-after-load 'comp
  (setq native-comp-async-jobs-number 8)
  (setq native-comp-speed 3))
```


### init.elã¨early-init.elã‚’NativeCompã™ã‚‹

`native-compile-async` ã§NativeCompileã§ãã¾ã™ã€‚ ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«çµæœã®å‡ºåŠ›ã¯ `*Async-native-compile-log*` bufferã§ã™ã€‚

```emacs-lisp
(native-compile-async "~/.emacs.d/init.el")
(native-compile-async "~/.emacs.d/early-init.el")
```


## early-init.elã«ã¤ã„ã¦

[early-init.el - Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/dcebc13578d42055f8a4#early-init.el)ã«ã¤ã„ã¦ã€‚

`early` ã¨æ›¸ã„ã¦ã‚ã‚‹é€šã‚Šã€åˆæœŸæ®µéšã§èª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚ ã€ŒåˆæœŸæ®µéšã€ã§èª­ã¿è¾¼ã¾ã‚Œã‚‹ã¨ã¯å…·ä½“çš„ã«ä½•ã§ã—ã‚‡ã†ã‹ï¼Ÿ `early-init.el` ã«æ›¸ãã¹ãå‡¦ç†ã¨ãã†ã§ãªã„å‡¦ç†ã®é•ã„ã¨ã¯ãªã‚“ãªã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

[49.4.6 The Early Init File](https://www.gnu.org/software/emacs/manual/html_node/emacs/Early-Init-File.html)ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚

> By contrast, the normal init files are read after the GUI is initialized.

è¦ã™ã‚‹ã«ã€ŒGUIã‚’åˆæœŸåŒ–ã™ã‚‹ã‚ˆã‚Šå‰ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã€ã¨ã—ã‹æ›¸ã„ã¦ãªã„ã§ã™ã€‚

`early-init.el` ã¨ `init.el` ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹é–“ã®ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€ã—ã‹ãªã„ã§ã™ã€‚

[https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1369-L1479](https://github.com/emacs-mirror/emacs/blob/6a390fd42ec4ef97d637899fc93f34ea65639e3c/lisp/startup.el#L1369-L1479)

å®Ÿè¡Œã•ã‚Œã¦ã‚‹ä¸»ãªé–¢æ•°ã¯ä»¥ä¸‹ã€‚

-   startup&#x2013;update-eln-cache
-   package-activate-all
-   window-system-initialization
-   frame-initialize
-   tool-bar-setup
-   normal-erase-is-backspace-setup-frame
-   tty-register-default-colors

ã“ã®è¾ºã«é–¢ä¿‚ã™ã‚‹è¨­å®šã‚’ã™ã‚Œã°è‰¯ã„ã§ã—ã‚‡ã†ã€‚

ã¾ãŸCè¨€èªå´ã®ã‚³ãƒ¼ãƒ‰ã¯å…ˆã«èª­ã¾ã‚Œã‚‹ã¯ãšã§ã™ã€‚ GCé–¢ä¿‚ã®ã‚³ãƒ¼ãƒ‰ã¯[src/alloc.c](https://github.com/emacs-mirror/emacs/blob/master/src/alloc.c)ã«è¨˜è¿°ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ `gc-cons-threshold` ã¯ `early-init.el` ã«æ›¸ãæ–¹ãŒè‰¯ã„ã§ã™ã€‚

ä½™è«‡ã§ã™ãŒã€EXWMç’°å¢ƒã®å ´åˆ `(setq frame-inhibit-implied-resize t)` ã‚’ã™ã‚‹ã¨EXWMãŒwindow resizeã§ããªããªã‚‹ã®ã§æç”»ãŒãŠã‹ã—ããªã‚‹ã®ã§æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚


## Compileæ™‚å‡¦ç†


### el-get-bundleã‚’eval-when-compileæ™‚ã«è½ã¨ã™

ç§ã¯ `el-get` ãƒ¦ãƒ¼ã‚¶ãªã®ã§ä»–ã®package managerã®ã“ã¨ã¯ã‚ã‹ã‚Šã¾ã›ã‚“ãŒã€package installã¯byte-compileæ™‚ã«è¡Œã£ã¦ã„ã¾ã™ã€‚ [dimitri/el-get](https://github.com/dimitri/el-get)ã® `Installation` ã‚’å‚è€ƒã«è¨­å®šã—ã¦ã„ãã¾ã™ã€‚

`eval-when-compile` ã¯byte-compileæ™‚ã«ã—ã‹ç™ºç«ã›ãšã€ç”Ÿæˆã•ã‚ŒãŸ `elc` ã«ã¯å‡¦ç†çµæœãŒè¨˜è¿°ã•ã‚Œã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚

ç§ã¯ `el-get` ã§380å€‹ç¨‹åº¦ã®packageã‚’è½ã¨ã—ã¦ã„ã‚‹é–¢ä¿‚ä¸Šã€éå¸¸ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§shallow cloneã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

```emacs-lisp
(eval-when-compile
  (add-to-list 'load-path (locate-user-emacs-file "el-get/el-get"))
  (with-current-buffer
      (url-retrieve-synchronously
       "https://raw.githubusercontent.com/dimitri/el-get/master/el-get-install.el")
    (goto-char (point-max))
    (eval-print-last-sexp))

  (with-eval-after-load 'el-get-git
    (setq el-get-git-shallow-clone t)))
```

å®Ÿéš›ã«installã™ã‚‹packageã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¦ã„ã¾ã™ã€‚

```emacs-lisp
(eval-when-compile
  (el-get-bundle "yasnippet"))

(eval-when-compile
  (el-get-bundle takeokunn/yasnippet-org))
```


### ç’°å¢ƒã”ã¨ã®ifæ–‡ã‚’macroã§å®šç¾©ã™ã‚‹

ç§ã®Emacsç’°å¢ƒã¯3ã¤ã‚ã‚Šã¾ã™ã€‚

-   Mac CLIç’°å¢ƒ
-   Mac GUIç’°å¢ƒ
-   Guix exwmç’°å¢ƒ

å‰æã«ã‚‚æ›¸ã„ãŸé€šã‚Šã€ä»Šå›é«˜é€ŸåŒ–ã™ã‚‹ã«ã‚ãŸã£ã¦ã€ŒMac CLIç’°å¢ƒã€ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦è©±ã—ã¦ã„ãŸãŒã€å®Ÿéš›é‹ç”¨ã—ã¦ã„ã‚‹ç’°å¢ƒã¯3ã¤ã‚ã‚Šã¾ã™ã€‚ ä¾‹ãˆã°ã€ŒMacç’°å¢ƒã§ã¯exwmé–¢ä¿‚ã®pluginã¯ä¸è¦ã€ã®ã‚ˆã†ãªã€ç’°å¢ƒã”ã¨ã«å¿…è¦ãªå‡¦ç†ã‚„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒå¾®å¦™ã«é•ã†ã®ã§æ¡ä»¶åˆ†å²ãŒå¿…è¦ã«ãªã£ã¦ãã¾ã™ã€‚

3ç’°å¢ƒã‚’åˆ†å²ã§ãã‚‹ã‚ˆã†ãªmacroã‚’ä½œæˆã—ã€byte-compileæ™‚ã«æ¡ä»¶åˆ†å²ã—ã¾ã—ãŸã€‚

```emacs-lisp
;;; Mac CLIç’°å¢ƒ
(defmacro when-darwin (&rest body)
  (when (string= system-type "darwin")
    `(progn ,@body)))

;;; Mac GUIç’°å¢ƒ
(defmacro when-darwin-not-window-system (&rest body)
  (when (and (string= system-type "darwin")
             window-system)
    `(progn ,@body)))

;;; Guix exwmç’°å¢ƒ
(defmacro when-guix (&rest body)
  (when (string= system-type "guix")
    `(progn ,@body)))
```


## ãƒ©ã‚¤ãƒ–ãƒ©ãƒªå‘¨ã‚Šã®èª­ã¿è¾¼ã¿


### async loadã‚’ã™ã‚‹

[æ“¬ä¼¼éåŒæœŸãƒ­ãƒ¼ãƒ‰ã«ã‚ˆã‚‹"å¾…ãŸã•ã‚Œæ„Ÿ"æ”¹å–„ - Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/c47f8eb7cd547b95ba91) ã«ã¤ã„ã¦ã€‚

`run-with-timer` ã§èµ·å‹•nç§’å¾Œã«queueå†…ã®å‡¦ç†ã‚’é †æ¬¡å®Ÿè¡Œã™ã‚‹ã¨ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚

ç§ã¯packageã‚’380å€‹ç¨‹åº¦å…¥ã‚Œã¦ã„ã‚‹ã®ã§ã€èµ·å‹•ã—ãŸç¬é–“ã«ä½¿ã„ãŸã„packageãŒãªã‹ãªã‹dequeueã—ã¦ãã‚Œãªã„ã¨ã„ã†å•é¡ŒãŒå‡ºã¦ãã¾ã—ãŸã€‚ æ—©ãèª­ã¾ã‚Œã¦ã»ã—ã„packageãŒä»¥ä¸‹ã§ã™ã€‚

-   dash.elã‚„s.elã®ã‚ˆã†ãªbasic packages
-   amx
-   magit
-   ddskk
-   projectile
-   swiper/ivy/counsel
-   doom

æ™®é€šã«Emacsã‚’èµ·å‹•ã—ãŸæ™‚æœ€åˆã«å©ãã‚³ãƒãƒ³ãƒ‰ã¯ `projectile` ã§ã‚ã‚‹ã“ã¨ã‚„ã€ `EDITOR=emacs git commit` ã§ç«‹ã¡ä¸ŠãŒã£ãŸæ™‚ã•ã£ã•ã¨æ—¥æœ¬èªå…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ãŸã„ã‚‚ã®ã§ã™ã€‚ ã¾ãŸã€fish shellã‹ã‚‰ `M-g` ã§magitã‚’èµ·å‹•ã§ãã‚‹ã‚ˆã†ã—ã¦ã„ã¾ã™ã€‚

```fish
function magit
    set -l git_root (git rev-parse --show-toplevel)
    emacs -nw --eval "
(progn
  (add-to-list 'load-path (locate-user-emacs-file \"el-get/dash\"))
  (add-to-list 'load-path (locate-user-emacs-file \"el-get/compat\"))
  (add-to-list 'load-path (locate-user-emacs-file \"el-get/transient/lisp\"))
  (add-to-list 'load-path (locate-user-emacs-file \"el-get/ghub/lisp\"))
  (add-to-list 'load-path (locate-user-emacs-file \"el-get/magit-pop\"))
  (add-to-list 'load-path (locate-user-emacs-file \"el-get/with-editor/lisp\"))
  (add-to-list 'load-path (locate-user-emacs-file \"el-get/magit/lisp\"))
  (require 'magit)
  (setq magit-display-buffer-function #'magit-display-buffer-fullframe-status-v1) (magit-status \"$git_root\"))"
end


function fish_user_key_bindings
    bind \eg magit
end
```

å…ƒè¨˜äº‹ã‚’å‚è€ƒã«å„ªå…ˆé †ä½é«˜ã„queueã‚’å‡¦ç†ã™ã‚‹æ©Ÿæ§‹ã‚‚ä½œã‚Šã¾ã—ãŸã€‚

```emacs-lisp
(defvar my/delayed-priority-high-configurations '())
(defvar my/delayed-priority-high-configuration-timer nil)

(defvar my/delayed-priority-low-configurations '())
(defvar my/delayed-priority-low-configuration-timer nil)

(add-hook 'emacs-startup-hook
          (lambda ()
            (setq my/delayed-priority-high-configuration-timer
                  (run-with-timer
                   0.1 0.001
                   (lambda ()
                     (if my/delayed-priority-high-configurations
                         (let ((inhibit-message t))
                           (eval (pop my/delayed-priority-high-configurations)))
                       (progn
                         (cancel-timer my/delayed-priority-high-configuration-timer))))))
            (setq my/delayed-priority-low-configuration-timer
                  (run-with-timer
                   0.3 0.001
                   (lambda ()
                     (if my/delayed-priority-low-configurations
                         (let ((inhibit-message t))
                           (eval (pop my/delayed-priority-low-configurations)))
                       (progn
                         (cancel-timer my/delayed-priority-low-configuration-timer))))))))

(defmacro with-delayed-execution-priority-high (&rest body)
  (declare (indent 0))
  `(setq my/delayed-priority-high-configurations
         (append my/delayed-priority-high-configurations ',body)))

(defmacro with-delayed-execution (&rest body)
  (declare (indent 0))
  `(setq my/delayed-priority-low-configurations
         (append my/delayed-priority-low-configurations ',body)))
```


### autoload/with-eval-after-loadã‚’æ´»ç”¨ã™ã‚‹

[autoload ã¨ with-eval-after-load - Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/abb04ff2351b3564a1a0)ã«ã¤ã„ã¦ã€‚

`autoload` ã®æŒ™å‹•ã¯ä¸Šè¨˜ã®è¨˜äº‹ã«è©³ç´°ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ã®ã§çœãã¾ã™ã€‚ ãŸã ã€ `autoload` ã¨ã„ã†ã®ã¯1ã¤ã®é–¢æ•°åã—ã‹å¼•æ•°ã«å–ã‚Œãªã„ã®ã§éå¸¸ã«ä¸ä¾¿ã§ã™ã€‚ ä»¥ä¸‹ã®ã‚ˆã†ãª `autoload-if-found` ã¨ã„ã†é–¢æ•°ã‚’ä½œæˆã¾ã—ãŸã€‚

```emacs-lisp
(defun autoload-if-found (functions file &optional docstring interactive type)
  "set autoload iff. FILE has found."
  (when (locate-library file)
    (dolist (f functions)
      (autoload f file docstring interactive type))
    t))
```

ä½¿ã„æ–¹ã¯ã“ã‚“ãªæ„Ÿã˜ã§ã™ã€‚

```emacs-lisp
(autoload-if-found '(lsp lsp-deferred) "lsp-mode" nil t)
```

`with-eval-after-load` ã¯ `require` ãŒå®Ÿè¡Œã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§èª­ã¾ã‚Œã‚‹ã‚‚ã®ã§ã™ã€‚ `autolaod-if-found` ã§å…¨ã¦ã®å‡¦ç†ã‚’é…å»¶ã—ã¦ã‚‹é–¢ä¿‚ã§ã€å…¨ã¦ã®packageã«å¯¾ã—ã¦ä¸å¯§ã«æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ã‚‚ã—è¨­å®šã‚’ã—ãªã‘ã‚Œã°ã€æœªå®šç¾©å¤‰æ•°ã«ãªã£ã¦èµ·å‹•æ™‚ã«Warningãªã‚ŠErrorãŒåã‹ã‚Œã¦ã—ã¾ã„ã¾ã™ã€‚

ä»¥ä¸‹ã® `php-mode-` ã®ä¾‹ã®ã‚ˆã†ã«ã€ `with-eval-after-load` ã«ã¯3ç¨®é¡ã®è¨­å®šã‚’ã™ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

-   hook
-   keybind(map)
-   custom

```emacs-lisp
(with-eval-after-load 'php-mode
  ;; hook
  (add-hook 'php-mode-hook #'lsp-deferred)

  ;; keybind
  (define-key php-mode-map (kbd "C-c C--") #'php-current-class)
  (define-key php-mode-map (kbd "C-c C-=") #'php-current-namespace)

  ;; config
  (setq php-mode-coding-style 'psr2))
```


## è¨­å®š


### Magic File Name ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹ã«ã™ã‚‹

[Magic File Name ã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹ã«ã™ã‚‹ - Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/dcebc13578d42055f8a4#magic-file-name-%E3%82%92%E4%B8%80%E6%99%82%E7%9A%84%E3%81%AB%E7%84%A1%E5%8A%B9%E3%81%AB%E3%81%99%E3%82%8B) ã«ã¤ã„ã¦ã€‚

Fileã®I/Oã¯éå¸¸ã«ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹è¡Œç‚ºã ã¨æ”¹ã‚ã¦æ„Ÿã˜ã¾ã—ãŸã€‚

ä»¥ä¸‹ã®è¨˜è¿°ã‚’æ›¸ãã ã‘ã§ã™ã€‚ æ›¸ãã ã‘ã§ã‹ãªã‚Šæ”¹å–„ã™ã‚‹ã®ã§ã‚³ã‚¹ãƒ‘ã®è‰¯ã„å¯¾å¿œã ã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚

```emacs-lisp
;;; è¡Œé ­
(defconst my/saved-file-name-handler-alist file-name-handler-alist)
(setq file-name-handler-alist nil)

;;; è¡Œæœ«
(setq file-name-handler-alist my/saved-file-name-handler-alist)
```


### GCã®è¨­å®š

[GC ã‚’æ¸›ã‚‰ã™ - Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/dcebc13578d42055f8a4#gc-%E3%82%92%E6%B8%9B%E3%82%89%E3%81%99)ã«ã¤ã„ã¦ã€‚

èµ·å‹•æ™‚ã«GCãŒå›ã‚‹ã“ã¨ã¯ã¯ã£ãã‚Šè¨€ã£ã¦ã‚³ã‚¹ãƒˆã§ã—ã‹ãªã„ã§ã™ã€‚ èµ·å‹•æ™‚ã«ä¸€åº¦ã‚‚GCã‚’å›ã•ãªã„ç¨‹åº¦ã®å¤§ãã•ã§è¨­å®šã—ã¦ãŠãã¨è‰¯ã„ã§ã™ã€‚

GCãŒå›ã£ãŸã‹ã©ã†ã‹ã¯å‰è¿°ã®ã€Œè©•ä¾¡ã®ä»•æ–¹ã€ã§ `profile-report` ãŒå‡ºåŠ›ã—ã¦ãã‚Œã‚‹ã®ã§ã€ãã“ã§åˆ¤æ–­ã§ãã‚‹ã§ã—ã‚‡ã†ã€‚ ç§ã¯ `early-init.el` ã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚

```emacs-lisp
(setq gc-cons-threshold (* 128 1024 1024))
```


# ãã®ä»–


## add-to-listã«ã¤ã„ã¦

[å®‰å…¨ãªé–¢æ•°ã‚’è«¦ã‚ã‚‹ - Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/395aeb41a34a616f58bd#%E5%AE%89%E5%85%A8%E3%81%AA%E9%96%A2%E6%95%B0%E3%82%92%E8%AB%A6%E3%82%81%E3%82%8B) ã«ã¤ã„ã¦ã€‚

`add-to-list` ã‚’ä½¿ã‚ãšã« `push` ã‚’ä½¿ã†ã»ã†ãŒé‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã‚ãªã„é–¢ä¿‚ã§é€Ÿããªã‚‹ã¨ã„ã†ã“ã¨ãŒæ›¸ã‹ã‚Œã¦ã„ã¾ã™ã€‚

`add-to-list` ã¯ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã® `major-mode` ã‚„ `mior-mode` ã§è¨­å®šã™ã‚‹æ™‚ã«ä½¿ã†ã“ã¨ãŒå¤šã„ã§ã™ã€‚ ç§ã¯æ•°åã®packageã‚’å…¥ã‚Œã¦ã„ã‚‹ã®ã ãŒã€ `push` ã«ç½®ãæ›ãˆã¦äº‹æ•…ã£ã¦å‹•ã‹ãªããªã£ãŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’ã™ã‚‹ã‹ã©ã†ã‹ã§å¤‰ã‚ã‚‹ç§’æ•°ã¯1msã‚ˆã‚Šã‚‚åœ§å€’çš„ã«å°‘ãªã„ã ã‚ã†ã—ã€å®‰å…¨æ€§ã‚’æ¨ã¦ã‚‹ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨æ¯”è¼ƒã—ã¦ãƒ¡ãƒªãƒƒãƒˆãŒè–„ã„ã‚ˆã†ã«æ„Ÿã˜ã¦ã„ã‚‹ã®ã§å´ä¸‹ã—ã¾ã—ãŸã€‚

ã¾ãŸasync loadã—ã¦ã„ã‚‹é–¢ä¿‚ã§è¨€èªç³»ã®å‡¦ç†ã¯é…å»¶èª­ã¿è¾¼ã¿ã—ã¦ã‚‹ã®ã§ã€èµ·å‹•æ™‚ã«ã¯å½±éŸ¿ãŒå‡ºãªã„ã§ã™ã€‚


## Portable Dumperã«ã¤ã„ã¦

[ãƒãƒ¼ã‚¿ãƒ–ãƒ«ãƒ€ãƒ³ãƒ‘ãƒ¼ - Emacs ã®èµ·å‹•æ™‚é–“ã‚’""è©°ã‚ã‚‹""](https://zenn.dev/zk_phi/books/cba129aacd4c1418ade4/viewer/e27557c39fceefe6c4f6#%E3%83%9D%E3%83%BC%E3%82%BF%E3%83%96%E3%83%AB%E3%83%80%E3%83%B3%E3%83%91%E3%83%BC) ã«ã¤ã„ã¦ã€‚

ã‚ã‚‰ã‹ã˜ã‚packageã‚’èª­ã¿è¾¼ã‚“ã§ãŠã„ãŸçŠ¶æ…‹ã®memoryã‚’dumpã™ã‚‹ä»•çµ„ã¿ã€‚ ä»Šå›ã®é…å»¶è©•ä¾¡ã‚’ã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯Portable Dumperã¯æ´»èºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚

è¨˜è¿°é‡ãŒã»ã¼ãªã„çŠ¶æ…‹ã®Emacs Lispãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¦memory dumpã—ã¦èª­ã¿è¾¼ã¾ã›ã¦ã¿ãŸã¨ã“ã‚ã€180msç¨‹åº¦ã‹ã‹ã‚Šã¾ã—ãŸã€‚

ãã‚‚ãã‚‚NativeCompã—ã¦ã„ã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¯dumpã§ããªã‹ã£ãŸã‚Šã¨è‰²ã€…ãªè½ã¨ã—ç©´ãŒã‚ã‚‹ã‚‰ã—ãã€éå¸¸ã«ä½¿ã„ã«ãã„ã‚‚ã®ã¨ãªã£ã¦ã„ã¾ã™ã€‚ Emacsã‚’è‡ªå‰Buildã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ç”Ÿæˆã•ã‚Œã‚‹dumpã«è‡ªåˆ†ã®ã‚³ãƒ¼ãƒ‰ã‚’åŸ‹ã‚è¾¼ã‚€ãã‚‰ã„ã™ã‚Œã°é«˜é€Ÿã«ãªã‚Šã¾ã™ãŒã€åˆ¥é€”ç”¨æ„ã‚’ã™ã‚‹ã¨éå¸¸ã«é²ããªã‚Šã¾ã™ã€‚


## lsp-modeã®performanceã«ã¤ã„ã¦

ä»Šå›ã®èµ·å‹•æ™‚ã®é«˜é€ŸåŒ–ã«ã¯é–¢ä¿‚ãªã„ãŒã€ `lsp-mode` ã‚’é«˜é€ŸåŒ–ã™ã‚‹TipsãŒå…¬å¼ã‚µã‚¤ãƒˆã«ã‚ã‚Šã¾ã™ã€‚ ç§ã¯ `lsp-mode` ã‚’ãƒ˜ãƒ“ãƒ¼ãƒ¦ãƒ¼ã‚ºã—ã¦ã‚‹ã®ã§ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå¤§å¹…ã«æ”¹å–„ã•ã‚Œã¦ç”Ÿç”£æ€§ãŒä¸ŠãŒã‚Šã¾ã—ãŸã€‚

[Performance - lsp-mode](https://emacs-lsp.github.io/lsp-mode/page/performance/)


## el-getã®packageã‚‚NativeCompã™ã‚‹

ã“ã‚Œã‚‚ä»Šå›ã®èµ·å‹•æ™‚ã®é«˜é€ŸåŒ–ã«ã¯é–¢ä¿‚ãªã„ãŒã€el-getã§è½ã¨ã—ã¦ããŸpackageã‚‚ä¸€æ‹¬ã§NativeCompã™ã‚‹æ–¹ãŒè‰¯ã„ã§ã—ã‚‡ã†ã€‚ ä»¥ä¸‹ã®ã‚ˆã†ãªé–¢æ•°ã‚’ç”¨æ„ã—ã€ã‚ã‚‰ã‹ã˜ã‚å®Ÿè¡Œã—ã¦ãŠãã¨è‰¯ã„ã§ã™ã€‚

`el-get/**/*.el` ã¨ `elpa/**/*.el` ã®å…¨ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«NativeCompã™ã‚‹ãŸã‚æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

```emacs-lisp
(defun my/native-comp-packages ()
  (interactive)
  (native-compile-async "~/.emacs.d/init.el")
  (native-compile-async "~/.emacs.d/early-init.el")
  (native-compile-async "~/.emacs.d/el-get" 'recursively)
  (native-compile-async "~/.emacs.d/elpa" 'recursively))
```


# ãŠã‚ã‚Šã«

2022å¹´ã¯Emacsã¨ã²ãŸã™ã‚‰å‘ãã‚ã£ãŸ1å¹´ã§ã—ãŸã€‚ ä»Šå¾Œ10ã€œ15å¹´è€ãˆã‚‰ã‚Œã‚‹è¨­å®šã¨ã¯ãªã‚“ãªã®ã‹ã‚’è€ƒãˆãŸçµæœã®1ã¤ã«ã€Œèµ·å‹•æ™‚é–“ã®é«˜é€ŸåŒ–ã€ã¨ã„ã†ã®ãŒã‚ã‚Šã¾ã—ãŸã€‚ 0ã‹ã‚‰è¨­å®šã‚’è¦‹ç›´ã—ã€ã‚ˆã‚Šé«˜é€Ÿã‹ã¤ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã®é«˜ã„è¨˜è¿°æ–¹æ³•ã¯ãªã‚“ãªã®ã‹ã€ `emacs.d` ã¯ã©ã†ã‚ã‚‹ã¹ãã‹ã€ã‚ˆã‚Šå–„ãç”Ÿãã¦ã„ããŸã‚ã«ã¯ã©ã†ã™ã‚Œã°è‰¯ã„ã®ã‹ã‚’è€ƒãˆã¤ãã—ã¾ã—ãŸã€‚

Emacsèµ·å‹•æ™‚é–“ã‚’é«˜é€ŸåŒ–ã™ã‚‹ã«ã‚ãŸã£ã¦ã€Emacsæœ¬ä½“ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª­ã‚€æ©Ÿä¼šãŒå¢—ãˆã¦å¤šãã®çŸ¥è­˜ã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚ æ˜¯éçš†ã•ã‚“ã‚‚è‡ªåˆ†ã®è¨­å®šã‚’ã‚ã‚‰ãŸã‚ã¦è¦‹ç›´ã™ãã£ã‹ã‘ã«ã—ã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ã€‚

ã„ã¤ã‚‚Twitterã§ç–‘å•ã«ç­”ãˆã¦ãã‚Œã‚‹Emacs Hackerã®çš†ã•ã‚“ã®ãŠé™°ã§ã“ã®è¨˜äº‹ã‚’æ›¸ãã“ã¨ãŒã§ãã¾ã—ãŸã€‚ ä»Šå¾Œã¨ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚
