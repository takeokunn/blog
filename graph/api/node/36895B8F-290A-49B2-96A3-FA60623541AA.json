{
  "id": "36895B8F-290A-49B2-96A3-FA60623541AA",
  "title": "flake.nixでポータブルな最小構成のEmacsを作成する",
  "raw": ":PROPERTIES:\n:ID:       36895B8F-290A-49B2-96A3-FA60623541AA\n:END:\n#+TITLE: flake.nixでポータブルな最小構成のEmacsを作成する\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-04-03T13:07:14+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting emacs nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\n「任意のEmacs Packageが動かない」がおま環かバグかというのを切り分けることは非常に重要。\n誰でも同じ環境を整えられるようにすると問題解決が捗るので構築方法をメモしておく。\n\n* 作業手順\n** 1. init.el作成\n\n今回のサンプルは[[https://melpa.org/#/rainbow-delimiters][rainbow-delimiters]]が動作するか確認するものにする。\n\n#+begin_src emacs-lisp\n  (use-package rainbow-delimiters\n    :ensure t\n    :hook\n    (prog-mode-hook . rainbow-delimiters-mode))\n#+end_src\n** 2. flake.nix作成\n\n=alwaysEnsure = true;= にすると =init.el= 内の =:ensure t= を読んでNix Build時によしなにインストールしてくれる。\n\nまた、[[https://github.com/nix-community/emacs-overlay][emacs-overlay]] を使うと =unstable/stable/head= など複数バージョンで実行できるので検証の幅を簡単に広げられる。\nhttps://github.com/nix-community/emacs-overlay/blob/master/overlays/emacs.nix\n\n#+begin_src nix\n  {\n    inputs = {\n      nixpkgs.url = \"github:NixOS/nixpkgs/nixpkgs-unstable\";\n      emacs-overlay = {\n        url = \"github:nix-community/emacs-overlay\";\n        inputs.nixpkgs.follows = \"nixpkgs\";\n      };\n    };\n\n    outputs = { self, nixpkgs, emacs-overlay }:\n      let\n        system = \"aarch64-darwin\";\n        pkgs = import nixpkgs {\n          inherit system;\n          overlays = [ emacs-overlay.overlay ];\n        };\n        emacs = pkgs.emacsWithPackagesFromUsePackage {\n          config = ./init.el;\n          package = pkgs.emacs-unstable;\n          alwaysEnsure = true;\n        };\n      in\n        {\n          packages.${system}.default = emacs;\n        };\n  }\n#+end_src\n** 3. Nix Buildして実行\n\nLocalに一切依存しない形でEmacsをBuildできる。\n\n#+begin_src console\n  $ nix build .#default\n  $ ./result/bin/emacs -nw -Q\n#+end_src\n* 終わりに\n「最小構成を作ってください」の正解は =flake.nix= だと思っている。\n\n余談だが、natsukiumの「一般構築魔法（Nix）のVimへの応用について」の「Nixでプラグインの実行環境を提供する」でも同じことが書かれている。\nhttps://zenn.dev/natsukium/articles/b4899d7b1e6a9a#nix%E3%81%A7%E3%83%97%E3%83%A9%E3%82%B0%E3%82%A4%E3%83%B3%E3%81%AE%E5%AE%9F%E8%A1%8C%E7%92%B0%E5%A2%83%E3%82%92%E6%8F%90%E4%BE%9B%E3%81%99%E3%82%8B\n",
  "backlinks": []
}