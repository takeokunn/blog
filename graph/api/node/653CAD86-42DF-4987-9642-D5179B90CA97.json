{
  "id": "653CAD86-42DF-4987-9642-D5179B90CA97",
  "title": "mcp-servers-nixを導入した",
  "raw": ":PROPERTIES:\n:ID:       653CAD86-42DF-4987-9642-D5179B90CA97\n:END:\n#+TITLE: mcp-servers-nixを導入した\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-04-09T21:09:33+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nix mcp\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\nnatsukium謹製の [[https://github.com/natsukium/mcp-servers-nix][natsukium/mcp-servers-nix]] を [[https://github.com/takeokunn/nixos-configuration][takeokunn/nixos-configuration]] に導入したのでメモしておく。\n\n* 変更点\n** Before\n\n- Orgファイルから =org-babel-tangle= で =~/Library/Application\\ Support/Claude/claude_desktop_config.json= を出力\n- 必要なpackageは [[https://github.com/svanderburg/node2nix][node2nix]] 経由で入れる\n- 秘密鍵はOrgファイルで =org-encrypt= して管理\n  - ref. [[id:C5A797A4-C474-4CFE-96E8-22C12F609A80][org-crypt運用メモ]]\n\n** After\n\n- [[https://github.com/natsukium/mcp-servers-nix][natsukium/mcp-servers-nix]] からMCPに必要なものをjsonを出力\n- 必要なpackageは大体 [[https://github.com/natsukium/mcp-servers-nix][natsukium/mcp-servers-nix]] に同梱されてる\n  - 足りないものは [[https://github.com/svanderburg/node2nix][node2nix]] 経由で入れる\n- 秘密鍵は [[https://github.com/Mic92/sops-nix][sops-nix]] で管理\n\n* 作業内容\n\n[[https://zenn.dev/natsukium/articles/f010c1ec1c51b2][MCPサーバーの設定をセキュアでGit friendlyにする - Zenn]] を事前に読む。\n\n** 1. sops-nixに登録\n\n=sops/password.yml= に以下を登録する。\n\n#+begin_src yaml\n  brave-api-token: BRAVE_API_KEY=xxxx\n#+end_src\n\n=sops/default.nix= で読み込めるようにする。\n\n#+begin_src nix\n  {\n    sops = {\n      defaultSopsFile = ./password.yaml;\n      secrets = {\n        brave-api-token = { };\n      };\n    };\n  }\n#+end_src\n\n** 2. mcp-serversを記述する\n\n~envFile = config.sops.secrets.brave-api-token.path;~ のように環境変数を渡す。\n\n#+begin_src nix\n  {\n    pkgs,\n    config,\n    mcp-servers-nix,\n    nodePkgs,\n  }:\n  let\n    programs = {\n      fetch.enable = true;\n      playwright.enable = true;\n      brave-search = {\n        enable = true;\n        envFile = config.sops.secrets.brave-api-token.path;\n      };\n    };\n  in\n  [\n    {\n      home.file.\"Library/Application\\ Support/Claude/claude_desktop_config.json\" = {\n        source = mcp-servers-nix.lib.mkConfig pkgs {\n          inherit programs;\n        };\n      };\n    }\n  ]\n#+end_src\n\n** 3. home-managerに組込み\n\n=home-manager/advanced.nix= で =imports= で登録すればよい。\n\n#+begin_src nix\n  {\n    config,\n    system,\n    nixpkgs,\n    org-babel,\n    emacs-overlay,\n    mcp-servers-nix,\n    ...\n  }:\n  let\n    # --- 中略 ---\n    pkgs = import nixpkgs {\n      inherit system;\n      config.allowUnfree = true;\n      overlays = basicOverlay ++ advancedOverlay;\n    };\n    nodePkgs = pkgs.callPackage ../node2nix { inherit pkgs; };\n\n    # mcp servers\n    mcpServers = import ./mcp-servers {\n      inherit pkgs nodePkgs;\n      inherit config mcp-servers-nix;\n    };\n  in\n  {\n    imports =  mcpServers;\n  }\n#+end_src\n* 作業結果\n\n正常に動くことを確認できた。\n\n[[file:../../static/images/B895E989-CD33-4A5E-967D-66E6DD2F3401.png]]\n\n[[file:../../static/images/B7AFBD4E-D4F3-49E8-A809-DEA091F5B3B0.png]]\n\n=$ cat ~/Library/Application\\ Support/Claude/claude_desktop_config.json=:\n\n#+begin_src json\n  {\n    \"mcpServers\": {\n      \"brave-search\": {\n        \"args\": [],\n        \"command\": \"/nix/store/ycnnbcc78f826p1qv1ishw51i7kizvpn-mcp-server-brave-search/bin/mcp-server-brave-search\",\n        \"env\": {}\n      },\n      \"fetch\": {\n        \"args\": [],\n        \"command\": \"/nix/store/bygbip4rxvmpyrcccznv69ssvg65985m-mcp-server-fetch-2025.3.28/bin/mcp-server-fetch\",\n        \"env\": {}\n      },\n      \"playwright\": {\n        \"args\": [\n          \"--executable-path\",\n          \"/nix/store/97prd65kac7lms777bigyjq56igmx2jq-google-chrome-135.0.7049.42/bin/google-chrome-stable\"\n        ],\n        \"command\": \"/nix/store/xp3hby1vl5ppf1xpmlnzj9b8lpnf94q1-playwright-mcp-0.0.9/bin/mcp-server-playwright\",\n        \"env\": {}\n      }\n    }\n  }\n#+end_src\n* 終わりに\n\nsopsに雑にパスワードを登録してるのでもう少しオシャレに管理したい。\n\n#+begin_src yaml\n  brave-api-token: BRAVE_API_KEY=xxxx\n#+end_src\n",
  "backlinks": [
    {
      "title": "credential管理をorg-encryptからpassword-storeに移行した",
      "source": "8A0AAFA0-0FDA-4C4C-BDC3-8279A68CE44C"
    },
    {
      "title": "node2nixの使い方",
      "source": "86EA901D-8BF0-4AD8-B9D5-64284E4D1322"
    }
  ]
}