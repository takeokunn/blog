{
  "id": "8F0228EE-D763-4B0E-A229-9AE008A49A21",
  "title": "nix-darwinのlinux-builderでNixOSを動かす",
  "raw": ":PROPERTIES:\n:ID:       8F0228EE-D763-4B0E-A229-9AE008A49A21\n:END:\n#+TITLE: nix-darwinのlinux-builderでNixOSを動かす\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2026-01-10T15:27:34+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\n元々OrbStack VMでNixOSを動かしていたのだが、k8sを動かす時にOrbStackだと動かずDocker for Macだと動くという事象が発生した。\n\n調査をした所、nix-darwinがlinux-builderというものをサポートしてることがわかったのでメモしておく。\n\nhttps://scrapbox.io/kanna/nix_linux-builder\n\n* 試したこと・やったこと\n** 1. linux-builderについて調査\n\nこのあたりに纏まっている。\n\n- [[https://scrapbox.io/kanna/nix_linux-builder][nix linux-builder - scrapbox]]\n- [[https://nixcademy.com/posts/macos-linux-builder/][Build and Deploy Linux Systems from macOS]]\n\nnix-darwinには [[https://github.com/nix-darwin/nix-darwin/blob/master/modules/nix/linux-builder.nix][modules/nix/linux-builder.nix]] が提供されており、 ~enable=true~ するだけで ~launchd.daemons~ に登録されるようだ。\n\n** 2. nix-darwinを導入してみる\n\n現状の設定は以下。\n\nhttps://github.com/takeokunn/nixos-configuration/blob/9b70ffde2c5d0233c0c78b63a1ad36d2638d5268/nix-darwin/config/linux-builder.nix\n\n#+begin_src nix\n  { lib, ... }:\n  {\n    nix.linux-builder = {\n      enable = true;\n      ephemeral = false;\n      systems = [ \"aarch64-linux\" \"x86_64-linux\" ];\n      config = {\n        boot.binfmt.emulatedSystems = [ \"x86_64-linux\" ];\n        virtualisation = {\n          cores = 6;\n          memorySize = lib.mkForce (1024 * 16);\n          diskSize = lib.mkForce (1024 * 200);\n        };\n        nix.settings = {\n          experimental-features = [\n            \"nix-command\"\n            \"flakes\"\n          ];\n        };\n        security.sudo.extraRules = [\n          {\n            users = [ \"builder\" ];\n            commands = [\n              {\n                command = \"ALL\";\n                options = [ \"NOPASSWD\" ];\n              }\n            ];\n          }\n        ];\n      };\n    };\n  }\n#+end_src\n** 3. 動いてることを確認する\n\n=take= 部分はwhoamiに読み替えてください。\n\n#+begin_src console\n  $ sudo chmod 644 /etc/nix/builder_ed25519.pub\n  $ sudo chmod 600 /etc/nix/builder_ed25519\n  $ sudo chown take:staff /etc/nix/builder_ed25519\n#+end_src\n\nあとはsshするだけ。\n\n#+begin_src console\n  $ ssh linux-builder\n#+end_src\n* 得られた結果・所感\n\nsshしてsudoできるようになった。\n\n[[file:../../static/images/455BF273-2F6B-4D49-8179-618E431DE1F6.png]]\n\n* 今後の展開・検討事項\n\ndeploy-rsと組み合わせてnixos-container運用を固めきりたい。\n現状だととりあえず動いただけなのでlinux-builder自体の深堀もしたい。\n",
  "backlinks": []
}