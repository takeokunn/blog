{
  "id": "EC822B0C-8DF4-4AC2-94DE-F460D99A5663",
  "title": "home-managerで自作moduleを作る",
  "raw": ":PROPERTIES:\n:ID:       EC822B0C-8DF4-4AC2-94DE-F460D99A5663\n:END:\n#+TITLE: home-managerで自作moduleを作る\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-06-14T06:29:49+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\nhome-managerには沢山のmoduleが提供されている。\n\nhttps://github.com/nix-community/home-manager/tree/master/modules\n\nhome-manager moduleは自分でも作成可能なので後学のためにメモしておく。\n\nhttps://github.com/takeokunn/nixos-configuration/tree/e2cf7d9df556a56e242b3f44b0957884cd6191dd/home-manager/modules\n\n* 試したこと・やったこと\n** 0. なぜやるのかの整理\n\n大きく分けて3パターンが考えられる。\n\n1. home-managerで自作moduleを作る\n2. ファイルを作成してhome-managerでsymbolic linkを貼る\n3. Nix管理外でメンテする\n\n1とそれ以外で次のようなメリット/デメリットが考えられる。\n可能な限りNix（Nix式）に寄せたいと考えているので今回採用することにした。\n\n*** Pros\n\n| 観点             | 内容                                                 |\n|------------------+------------------------------------------------------|\n| フォーマット抽象化 | 多様なフォーマットを意識せずに Nix 式で統一管理できる      |\n| IDE支援          | Nix LSP の補完・型チェックの恩恵を受けられる              |\n| 統一性           | `nixpkgs` の差し替えなど、構成記述の一貫性・統一性が上がる |\n| 再利用性          | モジュールとして切り出すことで複数環境で再利用しやすくなる   |\n| ライフサイクル     | rebuild switchのライフサイクルで反映できる               |\n| 変数埋込          | Nixから変数を代入できる                                |\n\n*** Cons\n\n| 観点        | 内容                                                         |\n|-------------+--------------------------------------------------------------|\n| 表現力の制限 | tmux.confのようなフォーマットは文字列での管理が必要                |\n| LSPの範囲   | LSP は Nix に対してしか効かず、生成対象の構文チェックは別途必要     |\n| 保守性      | 作り込むと構造が複雑化し、メンテナンスコストが上がる可能性がある      |\n| 依存性      | home-manager に構成が強く依存し、他ツールへの移行が難しくなることも |\n| デバッグ性   | モジュール解決や展開の追跡が難しく、デバッグの難易度が多少上がる      |\n\n** 1. 自作home-manager moduleを作成する\n\nhome-mnaagerのobjectでimportするだけで使える。\n\nhttps://github.com/takeokunn/nixos-configuration/blob/e2cf7d9df556a56e242b3f44b0957884cd6191dd/home-manager/advanced.nix#L71\n\n*** 1.1. tigの場合\n\n=~/.tigrc= に文字列をそのまま出力する運用にしている。\n\n[[https://github.com/takeokunn/nixos-configuration/blob/e2cf7d9df556a56e242b3f44b0957884cd6191dd/home-manager/modules/tig/default.nix][home-manager/modules/tig/default.nix]]\n\n#+begin_src nix\n  {\n    pkgs,\n    lib,\n    config,\n    ...\n  }:\n  let\n    cfg = config.programs.tig;\n  in\n  with lib;\n  {\n    options.programs.tig = {\n      enable = mkEnableOption \"Text-mode interface for git\";\n      package = mkPackageOption pkgs \"tig\" { };\n      config = mkOption {\n        type = types.lines;\n        default = \"\";\n      };\n    };\n\n    config = mkIf cfg.enable {\n      home.packages = [ cfg.package ];\n      home.file.\".tigrc\".text = cfg.config;\n    };\n  }\n#+end_src\n\n*** 1.2. lnavの場合\n\n=~/.config/lnav/config.json= にNix式をJsonに変換して出力するようにしている。\n\n[[https://github.com/takeokunn/nixos-configuration/blob/e2cf7d9df556a56e242b3f44b0957884cd6191dd/home-manager/modules/lnav/default.nix][home-manager/modules/lnav/default.nix]]\n\n#+begin_src nix\n  {\n    pkgs,\n    lib,\n    config,\n    ...\n  }:\n  let\n    cfg = config.programs.lnav;\n    jsonFormat = pkgs.formats.json { };\n  in\n  with lib;\n  {\n    options.programs.lnav = {\n      enable = mkEnableOption \"Log file navigator\";\n      package = mkPackageOption pkgs \"lnav\" { };\n      config = mkOption { type = jsonFormat.type; };\n    };\n\n    config = mkIf cfg.enable {\n      home.packages = [ cfg.package ];\n      xdg.configFile = {\n        \"lnav/config.json\".source = jsonFormat.generate \"config.json\" cfg.config;\n      };\n    };\n  }\n#+end_src\n** 2. 自作home-manager moduleを利用する\n*** 2.1. tigの場合\n\n通常とおり =programs.tig= に記述すればよい。（以下抜粋）\n\n[[https://github.com/takeokunn/nixos-configuration/blob/e2cf7d9df556a56e242b3f44b0957884cd6191dd/home-manager/programs/tig/default.nix][home-manager/programs/tig/default.nix]]\n\n#+begin_src nix\n  {\n    programs.tig = {\n      enable = true;\n      config = ''\n        # config\n        set main-view = id date author:email-user commit-title:graph=yes,refs=yes\n        set blame-view = date:default author:email-user id:yes,color line-number:yes,interval=1 text\n      '';\n    };\n\n  }\n#+end_src\n*** 2.2. lnavの場合\n\n通常とおり =programs.lnav= に記述すればよい。（以下抜粋）\n\n[[https://github.com/takeokunn/nixos-configuration/blob/e2cf7d9df556a56e242b3f44b0957884cd6191dd/home-manager/programs/lnav/default.nix][home-manager/programs/lnav/default.nix]]\n\n#+begin_src nix\n  { pkgs }:\n  {\n    programs.lnav = {\n      enable = true;\n      package = pkgs.lnav;\n      config = {\n        ui.theme = \"dracula\";\n        format-repos = [\n          \"https://github.com/hagfelsh/lnav_formats.git\"\n          \"https://github.com/PaulWay/lnav-formats.git\"\n          \"https://github.com/penntaylor/lnav-ruby-logger-format.git\"\n          \"https://github.com/aspiers/lnav-formats.git\"\n        ];\n      };\n    };\n  }\n#+end_src\n* 得られた結果・所感\n\nNix式で一元管理できるようになって統一的な記述ができるようになって嬉しい。\nまた、home-managerの仕組みの理解が進んで個人的には大満足。\n\n* 今後の展開・検討事項\n\n手元の運用で安定してきたらhome-manager本体にPRを出していきたい。\n",
  "backlinks": []
}