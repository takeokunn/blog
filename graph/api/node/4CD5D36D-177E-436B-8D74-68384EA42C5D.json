{
  "id": "4CD5D36D-177E-436B-8D74-68384EA42C5D",
  "title": "tcardgenをnixでパッケージ化する方法",
  "raw": ":PROPERTIES:\n:ID:       4CD5D36D-177E-436B-8D74-68384EA42C5D\n:END:\n#+TITLE: tcardgenをnixでパッケージ化する方法\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2024-11-22T09:11:24+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景\n\nHugoからOGPを動的に吐き出すツールとして [[https://github.com/Ladicle/tcardgen][Ladicle/tcardgen]] がある。\n2024/11/22 現在当ブログでも利用していて、 [[https://github.com/takeokunn/blog][takeokunn/blog]] のNix化に伴い tcardgen もNixでパッケージングする必要があった。\n\n* 流れ\n** 1. 自作nur-packages に登録\n\n[[https://github.com/takeokunn/nur-packages][takeokunn/nur-packages]] に雑に次のようにパッケージングをした。\n\n#+begin_src nix\n  { buildGoModule, fetchFromGitHub }:\n  buildGoModule {\n    pname = \"tcardgen\";\n    version = \"0.0.1\";\n    src = fetchFromGitHub {\n      owner = \"Ladicle\";\n      repo = \"tcardgen\";\n      rev = \"2222547ac37c2d6e1961b00acef3771f48ac8220\";\n      hash = \"sha256-6Z4SWpjdPMMCC6xm+xjSNAWQpO2FD91p+Mk9Y+Hh7AY=\";\n    };\n    vendorHash = \"\";\n\n    doCheck = false;\n\n    meta = {\n      description = \"Generate a TwitterCard(OGP) image for your Hugo posts.\";\n      homepage = \"https://github.com/Ladicle/tcardgen\";\n      mainProgram = \"tcardgen\";\n    };\n  }\n#+end_src\n\n=src= 部分は [[https://github.com/seppeljordan/nix-prefetch-github][seppeljordan/nix-prefetch-github]] を利用して取得。\n\n#+begin_src bash\n  $ nix-shell -p nix-prefetch-github\n  $ nix-prefetch-github-latest-release --nix Ladicle tcardgen\n  let\n    pkgs = import <nixpkgs> {};\n  in\n    pkgs.fetchFromGitHub {\n      owner = \"Ladicle\";\n      repo = \"tcardgen\";\n      rev = \"2222547ac37c2d6e1961b00acef3771f48ac8220\";\n      hash = \"sha256-6Z4SWpjdPMMCC6xm+xjSNAWQpO2FD91p+Mk9Y+Hh7AY=\";\n    }\n\n#+end_src\n\n** 2. 手元のBuildが通ることを確認\n\n=vendorHash= は空文字にしてbuildをするとエラーメッセージに書いてあるのでそれを埋める。\n\n#+begin_src bash\n  $ nix build .#tcardgen\n  $ ./result/bin/tcardgen --help\n  Generate TwitterCard(OGP) images for your Hugo posts.\n  Supported front-matters are title, author, categories, tags, and date.\n\n  Usage:\n    tcardgen [-f <FONTDIR>] [-o <OUTPUT>] [-t <TEMPLATE>] [-c <CONFIG>] <FILE>...\n\n  Examples:\n  # Generate a image and output to the example directory.\n  tcardgen --fontDir=font --output=example --template=example/template.png example/blog-post.md\n\n  # Generate a image and output to the example directory as \"featured.png\".\n  tcardgen --fontDir=font --output=example/featured.png --template=example/template.png example/blog-post.md\n\n  # Generate multiple images.\n  tcardgen --template=example/template.png example/*.md\n\n  # Genrate an image based on the drawing configuration.\n  tcardgen --config=config.yaml example/*.md\n\n  Flags:\n    -c, --config string     Set a drawing configuration file.\n    -f, --fontDir string    Set a font directory. (default \"font\")\n    -h, --help              help for tcardgen\n        --outDir string     (DEPRECATED) Set an output directory.\n    -o, --output string     Set an output directory or filename (only png format). (default \"out/\")\n    -t, --template string   Set a template image file. (default example/template.png)\n\n#+end_src\n\n** 3. CIでコケたものを修正\n\ngoのversionが合わないというエラーだった。\n\n#+begin_example\n  ---- 中略 ----\n  error: builder for '/nix/store/9i29mz8v8dwc6jyy2kxpfbay0sy1xf8r-tcardgen-0.0.1-go-modules.drv' failed with exit code 1;\n         last 8 log lines:\n         > Running phase: unpackPhase\n         > unpacking source archive /nix/store/skjfli0fscc0mqhlagkfjna0x2v1kgq7-source\n         > source root is source\n         > Running phase: patchPhase\n         > Running phase: updateAutotoolsGnuConfigScriptsPhase\n         > Running phase: configurePhase\n         > Running phase: buildPhase\n         > go: go.mod requires go >= 1.23 (running go 1.22.8; GOTOOLCHAIN=local)\n         For full logs, run 'nix log /nix/store/9i29mz8v8dwc6jyy2kxpfbay0sy1xf8r-tcardgen-0.0.1-go-modules.drv'.\n  error: builder for '/nix/store/9i29mz8v8dwc6jyy2kxpfbay0sy1xf8r-tcardgen-0.0.1-go-modules.drv' failed with exit code 1;\n         last 8 log lines:\n         > Running phase: unpackPhase\n         > unpacking source archive /nix/store/skjfli0fscc0mqhlagkfjna0x2v1kgq7-source\n         > source root is source\n         > Running phase: patchPhase\n         > Running phase: updateAutotoolsGnuConfigScriptsPhase\n         > Running phase: configurePhase\n         > Running phase: buildPhase\n         > go: go.mod requires go >= 1.23 (running go 1.22.8; GOTOOLCHAIN=local)\n         For full logs, run 'nix log /nix/store/9i29mz8v8dwc6jyy2kxpfbay0sy1xf8r-tcardgen-0.0.1-go-modules.drv'.\n  error: build of '/nix/store/43rfsfzxs6vlvcy146bz58qapig5lqab-tcardgen-0.0.1.drv^*', '/nix/store/4xfqycxxn4hi5m0xnzvxjwjr11n5nqg1-textlint-rule-preset-jtf-style-2.3.14.drv^*', '/nix/store/7dh43zziij61js5jjcv43b9qp4fc060f-textlint-rule-preset-japanese-10.0.3.drv^*', '/nix/store/9i29mz8v8dwc6jyy2kxpfbay0sy1xf8r-tcardgen-0.0.1-go-modules.drv^*', '/nix/store/acmw7z8i6wk9mqy95gn38mliz6jvyg2z-offline.drv^*', '/nix/store/lvcpa0lck54hbwv46bjjmy8385xivgny-offline.drv^*', '/nix/store/rlxzz85xybhcwb3dvnx6z4a7cw7v6lnj-offline.drv^*', '/nix/store/zmfi7bz7is5d5spiqljqnz0q7f0y3ps0-textlint-rule-preset-ja-spacing-2.4.3.drv^*', '/nix/store/zw27xgidmlcwsvrl6l7j6f5xagpvwy84-isucrud-1.2.2.drv^*' failed\n#+end_example\n\n2024/11/22 時点ではGo versionが =1.22.8= なので明示的に =1.23= を使ってbuildするように変更しなければならない。\n\n[[https://github.com/takeokunn/nur-packages/commit/2c08f7d8b69b6dec04c4f902fae956b5c20354d0][2c08f7d8b69b6dec04c4f902fae956b5c20354d0]] のように =buildGoModule= を =buildGo123Module= に差し替えたらエラーが解消された。\n\n** 4. devenvで利用\n\n次のように記述すると[[https://devenv.sh/][ devenv]] でも利用することが可能。\n\ndevenv.yaml:\n\n#+begin_src yaml\n  inputs:\n    nur-packages:\n      url: github:takeokunn/nur-packages\n#+end_src\n\ndevenv.nix:\n\n#+begin_src nix\n  { pkgs, config, inputs, ... }:\n  let\n    pkgs-unstable = import inputs.nixpkgs-unstable { system = pkgs.stdenv.system; };\n  in\n  {\n    packages = with pkgs; [\n      inputs.nur-packages.packages.\"${pkgs.stdenv.system}\".tcardgen\n    ];\n  }\n#+end_src\n\n* 終わりに\n\nnur-packagesで自作packageを簡単に作成できるのは便利だし、将来的にはnixpkgs本体にコントリビュートしたい。\n",
  "backlinks": []
}