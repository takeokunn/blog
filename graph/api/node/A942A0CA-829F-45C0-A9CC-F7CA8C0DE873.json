{
  "id": "A942A0CA-829F-45C0-A9CC-F7CA8C0DE873",
  "title": "Terraform GitHub Providerを導入した",
  "raw": ":PROPERTIES:\n:ID:       A942A0CA-829F-45C0-A9CC-F7CA8C0DE873\n:END:\n#+TITLE: Terraform GitHub Providerを導入した\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-04-02T00:12:35+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting terraform\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\n個人の運用でTerraform GitHub Providerを導入したのでメモしておく。\n\n* Motiviation\n\n長年ソフトウェアエンジニアをやってたらリポジトリが増えていく。特に最近のLLMの流行で検証用に作るリポジトリが顕著に増えている。\n「Automatically delete head branchesは必ず有効にする」など、統一的な環境を宣言的にしたいという欲求があった。\n\nまた、SSH keysの設定など個人の設定も可能な限り宣言的に記述したい。\n\n* 作業手順\n\nこちらのproviderを使って導入する。\nhttps://registry.terraform.io/providers/integrations/github/latest\n\n** 0. Access Tokenを用意する\n\n「Personal access tokens > Fine-grained personal access tokens」で必要に応じて権限を付与してTokenを発行する。\n\n** 1. provider定義\n\n[[https://github.com/getsops/sops][sops]] にGitHub API Tokenを保存して [[https://github.com/carlpett/terraform-provider-sops][terraform-provider-sops]] 経由で入れる。\n\n#+begin_src terraform\n  terraform {\n    required_providers {\n      sops = {\n        source  = \"carlpett/sops\"\n        version = \"~> 0.5\"\n      }\n      github = {\n        source  = \"integrations/github\"\n        version = \"~> 6.0\"\n      }\n    }\n  }\n\n  provider \"sops\" {}\n\n  data \"sops_file\" \"secret\" {\n    source_file = \"./secrets.yaml\"\n  }\n\n  provider \"github\" {\n    token = data.sops_file.secret.data.github\n  }\n#+end_src\n\n** 2. ssh key定義\n\n[[https://registry.terraform.io/providers/integrations/github/latest/docs/resources/user_ssh_key][github_user_ssh_key]] で定義できる。\n\n#+begin_src terraform\n  resource \"github_user_ssh_key\" \"main\" {\n    title = \"main\"\n    key   = \"ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG9NCQp8KbNmdCQohUKzAJsNKe+Rz4IYDdthVX9Hzymi\"\n  }\n#+end_src\n\nここで確認できる。\nhttps://github.com/takeokunn.keys\n\n** 3. gpg key定義\n\n[[https://registry.terraform.io/providers/integrations/github/latest/docs/resources/user_gpg_key][github_user_gpg_key]] で定義できる。\n\n#+begin_src terraform\n  resource \"github_user_gpg_key\" \"main\" {\n    armored_public_key = <<EOT\n  -----BEGIN PGP PUBLIC KEY BLOCK-----\n\n  mQINBGCPIQMBEAC+pajm1AKxI+aUdEgyDnJk4KZzz9G92sE/BqEr4pru4VGGuIZ8\n  L54olQLbbI6Epz8U8gRd6sfqf6ku4HmLWAtrtTNBwCqPpI7JDcLdKZM8w8HcI3/1\n  rdK3ZjCi1UTnkMHoKqKzYyIuum3qAQM8qEJIrW6miYfepT9KgitdpLY4jmCCeqv6\n\n  中略\n\n  -----END PGP PUBLIC KEY BLOCK-----\n  EOT\n  }\n#+end_src\n\nここで確認できる。\nhttps://github.com/takeokunn.gpg\n\n** 4. repository定義\n\n[[https://registry.terraform.io/providers/integrations/github/latest/docs/resources/repository][github_repository]] や [[https://registry.terraform.io/providers/integrations/github/latest/docs/resources/repository_topics][github_repository_topics]] あたりで定義できる。\n\n#+begin_src terraform\n  resource \"github_repository\" \"blog\" {\n    name                   = \"blog\"\n    description            = \"This is a Zettelkasten blog generated by org-roam and ox-hugo.\"\n    visibility             = \"public\"\n    has_issues             = true\n    homepage_url           = \"https://www.takeokunn.org/\"\n    delete_branch_on_merge = true\n\n    pages {\n      build_type = \"workflow\"\n      cname      = \"www.takeokunn.org\"\n    }\n  }\n\n  resource \"github_repository_topics\" \"blog\" {\n    repository = github_repository.blog.name\n    topics     = [\"blog\", \"hugo\", \"org-mode\", \"zettelkasten\", \"org-roam\"]\n  }\n#+end_src\n\n上記の設定をすると [[https://github.com/takeokunn/blog][takeokunn/blog]] のようにtopicが反映される。\n\n既存のリポジトリは =terraform import= で帳尻を合わせればよい\n\n#+begin_src console\n  $ erraform import module.github.github_repository.blog blog\n#+end_src\n\nCI構築しているなら =sops= で秘密鍵を管理しつつ、 [[https://registry.terraform.io/providers/integrations/github/latest/docs/resources/actions_environment_secret][github_actions_environment_secret]] などで流すのも良さそう。\n\n* 作業結果\n\nメインで使っている個人リポジトリはすべてTerraform管理に移行した。\nまた、新規リポジトリもTerraform経由で宣言的に作成できることを確認した。\n\n* 終わりに\n使用感は非常に良く、移行も一晩で終わったので良かった。\n\nTerraformはPrivateリポジトリで管理しており、ほかにも[[https://registry.terraform.io/providers/cloudflare/cloudflare/latest/docs][ Cloudflare Provider ]]や [[https://registry.terraform.io/providers/carbans/nextdns/latest][NextDNS Provider]] を管理している。\n外部サービスは可能な限りTerraformで管理できるようにしていきたい。\n",
  "backlinks": [
    {
      "title": "GPG KeyのYubiKey運用をはじめた",
      "source": "B3ECD5FA-DFCE-447B-AAB0-72BEAAA28AEF"
    },
    {
      "title": "GPG KeyのYubiKey運用をはじめた",
      "source": "B3ECD5FA-DFCE-447B-AAB0-72BEAAA28AEF"
    },
    {
      "title": "private-terraformをHCP Terraformに移行した",
      "source": "FFA7027E-161A-498C-AD36-C0033C7A9CD6"
    },
    {
      "title": "個人的Local環境のGit Branch運用について",
      "source": "57E8F735-BD82-49F9-BE50-6740DAF4F603"
    },
    {
      "title": "Typstで履歴書と職務経歴書をBuildする",
      "source": "22C11682-3405-48C4-A720-5FF3080480DD"
    },
    {
      "title": "お名前comからCloudflareにドメイン移管してTerraformで管理する",
      "source": "861C8003-2791-4BF3-8126-489838D804F9"
    },
    {
      "title": "GitHub Actions内で署名付きCommitをする",
      "source": "4492D4DB-0A17-459A-96E6-5663121602E1"
    }
  ]
}