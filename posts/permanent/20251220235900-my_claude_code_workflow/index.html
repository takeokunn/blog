<!doctype html><html lang=ja-jp dir=ltr prefix="og: https://ogp.me/ns#"><head><meta charset=utf-8><meta http-equiv=content-type content="text/html"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=Hatena::Bookmark content="nocomment"><title itemprop=name>2025年12月 個人的claude codeワークフロー | takeokunn's blog</title><meta property="og:title" content="2025年12月 個人的claude codeワークフロー | takeokunn's blog"><meta name=twitter:title content="2025年12月 個人的claude codeワークフロー | takeokunn's blog"><meta itemprop=name content="2025年12月 個人的claude codeワークフロー | takeokunn's blog"><meta name=application-name content="2025年12月 個人的claude codeワークフロー | takeokunn's blog"><meta property="og:site_name" content><meta name=description content="1. はじめに Claude Codeを本格的に使い始めました。
最初はGitHub Copilotと同じ感覚で、コード生成ツールの延長として使っていたのですが、あるとき気づきました。「セキュリティレビューをお願いしたら、コードスタイルの指摘ばかり返ってきた」「昨日と同じ質問をしたのに、まったく違うフォーマットで回答された」「プロジェクトの規約を毎回説明するのが面倒」。これ、Claude Codeの問題じゃなくて、自分の使い方の問題でした。
試行錯誤を重ねるうちに、Claude Codeは単なるコード補完ツールではなく、適切に設定すればマルチエージェントシステムとして機能することに気づきました"><meta itemprop=description content="1. はじめに Claude Codeを本格的に使い始めました。
最初はGitHub Copilotと同じ感覚で、コード生成ツールの延長として使っていたのですが、あるとき気づきました。「セキュリティレビューをお願いしたら、コードスタイルの指摘ばかり返ってきた」「昨日と同じ質問をしたのに、まったく違うフォーマットで回答された」「プロジェクトの規約を毎回説明するのが面倒」。これ、Claude Codeの問題じゃなくて、自分の使い方の問題でした。
試行錯誤を重ねるうちに、Claude Codeは単なるコード補完ツールではなく、適切に設定すればマルチエージェントシステムとして機能することに気づきました"><meta property="og:description" content="1. はじめに Claude Codeを本格的に使い始めました。
最初はGitHub Copilotと同じ感覚で、コード生成ツールの延長として使っていたのですが、あるとき気づきました。「セキュリティレビューをお願いしたら、コードスタイルの指摘ばかり返ってきた」「昨日と同じ質問をしたのに、まったく違うフォーマットで回答された」「プロジェクトの規約を毎回説明するのが面倒」。これ、Claude Codeの問題じゃなくて、自分の使い方の問題でした。
試行錯誤を重ねるうちに、Claude Codeは単なるコード補完ツールではなく、適切に設定すればマルチエージェントシステムとして機能することに気づきました"><meta name=twitter:description content="1. はじめに Claude Codeを本格的に使い始めました。
最初はGitHub Copilotと同じ感覚で、コード生成ツールの延長として使っていたのですが、あるとき気づきました。「セキュリティレビューをお願いしたら、コードスタイルの指摘ばかり返ってきた」「昨日と同じ質問をしたのに、まったく違うフォーマットで回答された」「プロジェクトの規約を毎回説明するのが面倒」。これ、Claude Codeの問題じゃなくて、自分の使い方の問題でした。
試行錯誤を重ねるうちに、Claude Codeは単なるコード補完ツールではなく、適切に設定すればマルチエージェントシステムとして機能することに気づきました"><meta property="og:locale" content="ja-jp"><meta name=language content="ja-jp"><link rel=alternate hreflang=ja-jp href=https://www.takeokunn.org/posts/permanent/20251220235900-my_claude_code_workflow/ title=Japanese><meta property="og:type" content="article"><meta property="og:article:published_time" content="2025-12-30T00:00:00+00:00"><meta property="article:published_time" content="2025-12-30T00:00:00+00:00"><meta property="og:url" content="https://www.takeokunn.org/posts/permanent/20251220235900-my_claude_code_workflow/"><meta itemprop=image content="https://www.takeokunn.org/ogp/20251220235900-my_claude_code_workflow.png"><meta property="og:image" content="https://www.takeokunn.org/ogp/20251220235900-my_claude_code_workflow.png"><meta name=twitter:image content="https://www.takeokunn.org/ogp/20251220235900-my_claude_code_workflow.png"><meta name=twitter:image:src content="https://www.takeokunn.org/ogp/20251220235900-my_claude_code_workflow.png"><meta name=twitter:card content="summary_large_image"><script defer type=application/ld+json>{"@context":"http://schema.org","@type":"Article","headline":"2025年12月 個人的claude codeワークフロー","author":{"@type":"Person","name":""},"datePublished":"2025-12-30T00:00:00\u002b00:00","description":"1. はじめに Claude Codeを本格的に使い始めました。\n最初はGitHub Copilotと同じ感覚で、コード生成ツールの延長として使っていたのですが、あるとき気づきました。「セキュリティレビューをお願いしたら、コードスタイルの指摘ばかり返ってきた」「昨日と同じ質問をしたのに、まったく違うフォーマットで回答された」「プロジェクトの規約を毎回説明するのが面倒」。これ、Claude Codeの問題じゃなくて、自分の使い方の問題でした。\n試行錯誤を重ねるうちに、Claude Codeは単なるコード補完ツールではなく、適切に設定すればマルチエージェントシステムとして機能することに気づきました","wordCount":1479,"mainEntityOfPage":"True","dateModified":"2025-12-30T00:00:00\u002b00:00","image":{"@type":"imageObject","url":""},"publisher":{"@type":"Organization","name":"takeokunn\u0027s blog"}}</script><link rel=canonical href=https://www.takeokunn.org/posts/permanent/20251220235900-my_claude_code_workflow/><link href=/posts/permanent/20251220235900-my_claude_code_workflow/ rel=alternate type=application/rss+xml title="takeokunn's blog"><link href=/posts/permanent/20251220235900-my_claude_code_workflow/ rel=feed type=application/rss+xml title="takeokunn's blog"><link href=/style.min.71c11b16c107f1031ce1f17c8e2fef21394bb486a285ca4d0a69d5c311e607d5.css rel=stylesheet><link href=/code-highlight.min.ca0d5ee203390cf1a8d6b0b0204024fa2424a020fd6554c7df0c2a572e19c583.css rel=stylesheet><link rel="shortcut icon" href=/favicon.ico></head><body class=notransition aria-live=polite><div class=navbar role=navigation><nav class=menu aria-label="Main Navigation"><a href=https://www.takeokunn.org/ class=logo aria-label=Home><svg width="25" height="25" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home" aria-hidden="true" focusable="false"><title>Home</title><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
</a><input type=checkbox id=menu-trigger class=menu-trigger aria-expanded=false aria-controls=site-menu>
<label for=menu-trigger aria-label="Toggle menu"><span class=menu-icon aria-hidden=true><svg width="25" height="25" stroke="currentColor" fill="none" viewBox="0 0 14 14" aria-hidden="true" focusable="false"><title>Menu</title><path stroke-linecap="round" stroke-linejoin="round" d="M10.595 7H3.40726"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 3.51488H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M10.5096 10.4851H3.49301"/><path stroke-linecap="round" stroke-linejoin="round" d="M.5 12.5V1.5c0-.552285.447715-1 1-1h11C13.0523.5 13.5.947715 13.5 1.5v11C13.5 13.0523 13.0523 13.5 12.5 13.5H1.5C.947715 13.5.5 13.0523.5 12.5z"/></svg></span></label><div class=trigger id=site-menu><label for=menu-trigger class=menu-close-button aria-label="Close menu">&#215;</label><ul class=trigger-container role=menu><li role=none><a class=menu-link href=/ role=menuitem>Home</a></li><li role=none><a class="menu-link active" href=/posts/ role=menuitem aria-current=page>Posts</a></li><li role=none><a class=menu-link href=/graph/ role=menuitem>Graph</a></li></ul></div></nav></div><div class="wrapper post"><main class=page-content aria-label=Content><article role=article><header class=header><h1 class=header-title>2025年12月 個人的claude codeワークフロー</h1><div class=post-meta><time datetime=2025.12.30 itemprop=datePublished aria-label="Published on 2025.12.30">2025.12.30</time></div><ul class=tags aria-label="Post tags"><li><a href=/tags/permanent aria-label="View all posts with tag: permanent">permanent</a></li><li><a href=/tags/ai aria-label="View all posts with tag: ai">ai</a></li></ul></header><details class=toc><summary aria-label="Toggle Table of Contents"><b>Table of Contents</b></summary><nav id=TableOfContents><ul><li><a href=#1-dot-はじめに>1. はじめに</a></li><li><a href=#2-dot-背景と設計哲学>2. 背景と設計哲学</a><ul><li><a href=#2-dot-1-dot-感じていた課題>2.1. 感じていた課題</a></li><li><a href=#2-dot-2-dot-5つのルール>2.2. 5つのルール</a></li></ul></li><li><a href=#3-dot-プロンプト設計の基盤>3. プロンプト設計の基盤</a><ul><li><a href=#3-dot-1-dot-xmlによる構造化プロンプト>3.1. XMLによる構造化プロンプト</a><ul><li><a href=#3-dot-1-dot-1-dot-なぜxmlなのか>3.1.1. なぜXMLなのか</a></li><li><a href=#3-dot-1-dot-2-dot-xmlコア要素>3.1.2. XMLコア要素</a></li><li><a href=#3-dot-1-dot-3-dot-yamlフロントマター>3.1.3. YAMLフロントマター</a></li></ul></li><li><a href=#3-dot-2-dot-claude-dot-mdによるグローバル設定>3.2. CLAUDE.mdによるグローバル設定</a><ul><li><a href=#3-dot-2-dot-1-dot-グローバル-vs-プロジェクト>3.2.1. グローバル vs プロジェクト</a></li><li><a href=#3-dot-2-dot-2-dot-デフォルト動作との比較>3.2.2. デフォルト動作との比較</a></li></ul></li></ul></li><li><a href=#4-dot-マルチエージェント構成の実践>4. マルチエージェント構成の実践</a><ul><li><a href=#4-dot-1-dot-階層構造の概要>4.1. 階層構造の概要</a></li><li><a href=#4-dot-2-dot-コマンドによるワークフロー定義>4.2. コマンドによるワークフロー定義</a><ul><li><a href=#4-dot-2-dot-1-dot-readonlyファースト哲学>4.2.1. Readonlyファースト哲学</a></li><li><a href=#4-dot-2-dot-2-dot-コマンド一覧>4.2.2. コマンド一覧</a></li><li><a href=#4-dot-2-dot-3-dot-ワークフロー>4.2.3. ワークフロー</a></li><li><a href=#4-dot-2-dot-4-dot-代表的なコマンド-define>4.2.4. 代表的なコマンド: /define</a></li></ul></li><li><a href=#4-dot-3-dot-専門エージェントの設計>4.3. 専門エージェントの設計</a><ul><li><a href=#4-dot-3-dot-1-dot-設計思想>4.3.1. 設計思想</a></li><li><a href=#4-dot-3-dot-2-dot-エージェント例>4.3.2. エージェント例</a></li><li><a href=#4-dot-3-dot-3-dot-代表的なエージェント-security-agent>4.3.3. 代表的なエージェント: security agent</a></li></ul></li><li><a href=#4-dot-4-dot-スキルによる知識ベース構築>4.4. スキルによる知識ベース構築</a><ul><li><a href=#4-dot-4-dot-1-dot-skillの役割と位置づけ>4.4.1. Skillの役割と位置づけ</a></li><li><a href=#4-dot-4-dot-2-dot-スキルカテゴリ一覧>4.4.2. スキルカテゴリ一覧</a></li><li><a href=#4-dot-4-dot-3-dot-スキルの構造例-investigation-patterns>4.4.3. スキルの構造例: investigation-patterns</a></li></ul></li></ul></li><li><a href=#5-dot-mcpによる機能拡張>5. MCPによる機能拡張</a><ul><li><a href=#5-dot-1-dot-なぜ3つのmcpサーバなのか>5.1. なぜ3つのMCPサーバなのか</a><ul><li><a href=#5-dot-1-dot-1-dot-各サーバが埋めるギャップ>5.1.1. 各サーバが埋めるギャップ</a></li><li><a href=#5-dot-1-dot-2-dot-ツール優先度の階層>5.1.2. ツール優先度の階層</a></li><li><a href=#5-dot-1-dot-3-dot-nix設定例>5.1.3. Nix設定例</a></li></ul></li><li><a href=#5-dot-2-dot-統合ワークフロー>5.2. 統合ワークフロー</a><ul><li><a href=#5-dot-2-dot-1-dot-phase-1-外部知識取得-context7>5.2.1. Phase 1: 外部知識取得（Context7）</a></li><li><a href=#5-dot-2-dot-2-dot-phase-2-内部知識取得-serena>5.2.2. Phase 2: 内部知識取得（Serena）</a></li><li><a href=#5-dot-2-dot-3-dot-phase-3-実装-codex>5.2.3. Phase 3: 実装（Codex）</a></li><li><a href=#5-dot-2-dot-4-dot-phase-4-知識永続化-serena>5.2.4. Phase 4: 知識永続化（Serena）</a></li></ul></li></ul></li><li><a href=#6-dot-運用と安全性>6. 運用と安全性</a><ul><li><a href=#6-dot-1-dot-home-managerによる宣言的管理>6.1. home-managerによる宣言的管理</a></li><li><a href=#6-dot-2-dot-hooksによるポリシー強制>6.2. hooksによるポリシー強制</a><ul><li><a href=#6-dot-2-dot-1-dot-hooksの種類>6.2.1. hooksの種類</a></li><li><a href=#6-dot-2-dot-2-dot-enforce-perl-hook-コマンドバリデーション>6.2.2. enforce-perl hook: コマンドバリデーション</a></li></ul></li><li><a href=#6-dot-3-dot-permissions-と-statusline>6.3. permissions と statusline</a><ul><li><a href=#6-dot-3-dot-1-dot-permissions-多層防御>6.3.1. permissions: 多層防御</a></li><li><a href=#6-dot-3-dot-2-dot-statusline-セッション状態の可視化>6.3.2. statusline: セッション状態の可視化</a></li></ul></li></ul></li><li><a href=#7-dot-得られた結果-所感>7. 得られた結果・所感</a></li><li><a href=#8-dot-おわりに>8. おわりに</a></li></ul></nav></details><div class=page-content><h2 id=1-dot-はじめに>1. はじめに</h2><p>Claude Codeを本格的に使い始めました。</p><p>最初はGitHub Copilotと同じ感覚で、コード生成ツールの延長として使っていたのですが、あるとき気づきました。「セキュリティレビューをお願いしたら、コードスタイルの指摘ばかり返ってきた」「昨日と同じ質問をしたのに、まったく違うフォーマットで回答された」「プロジェクトの規約を毎回説明するのが面倒」。これ、Claude Codeの問題じゃなくて、自分の使い方の問題でした。</p><p>試行錯誤を重ねるうちに、Claude Codeは単なるコード補完ツールではなく、適切に設定すればマルチエージェントシステムとして機能することに気づきました。</p><p>この記事では、構築したワークフローを共有します。</p><p>ちなみに、この記事も大半はClaude Codeに書いてもらいました。</p><h2 id=2-dot-背景と設計哲学>2. 背景と設計哲学</h2><h3 id=2-dot-1-dot-感じていた課題>2.1. 感じていた課題</h3><p>Claude Codeを本格的に使い始める前、いくつかの課題を感じていました。</p><p>一番大きかったのは専門性の欠如です。単一のAIエージェントでは、コード品質・セキュリティ・テスト・ドキュメントなど複数のドメインにまたがるタスクをうまく処理できませんでした。セキュリティの観点でレビューをお願いしても、コードスタイルの指摘が混在して、本当に確認したいポイントが埋もれてしまいます。</p><p>出力の不安定性も悩みの種でした。構造化されたプロンプトなしでは、AIの応答品質やフォーマットが毎回異なります。昨日と同じ質問をしても、回答の形式がまったく違うということがよくありました。</p><p>繰り返しの説明にも時間を取られていました。同じパターンや好みを何度もAIに説明する必要があり、徒労感がありました。</p><h3 id=2-dot-2-dot-5つのルール>2.2. 5つのルール</h3><p>CLAUDE.mdには5つの <code>critical</code> ルールを定義しています。この5つが私のワークフローの根幹になっています。</p><ol><li>サブエージェントへの委譲 : 親エージェントは方針決定とオーケストレーションに集中し、詳細な作業は専門エージェントに任せる</li><li>Serenaメモリの事前確認 : 実装前に必ず <code>list_memories</code> と <code>read_memory</code> でプロジェクトの規約やパターンを確認する</li><li>シンボルレベルの操作 : ファイル全体を読み込むのではなく、Serenaの <code>find_symbol</code> などでシンボル単位で操作する</li><li>perlでテキスト処理 : sed/awkは使わない。 <code>perl -pe 's/foo/bar/g'</code> で統一</li><li>英語で出力 : 出力は常に英語に統一</li></ol><p>なぜこの5つなのか。1と2はマルチエージェント構成の核心、3はトークン効率の改善、4と5は出力の一貫性を担保するためです。</p><h2 id=3-dot-プロンプト設計の基盤>3. プロンプト設計の基盤</h2><p>ここで紹介するプロンプトの多くは、Claude Code自身に生成させました。「こういう形式で書いて」と伝えて、その出力を調整しながら現在の形に至りました。</p><p>Claude Codeのプロンプトは構造化されたXMLで記述しています。</p><h3 id=3-dot-1-dot-xmlによる構造化プロンプト>3.1. XMLによる構造化プロンプト</h3><h4 id=3-dot-1-dot-1-dot-なぜxmlなのか>3.1.1. なぜXMLなのか</h4><p>Markdownやプレーンテキストではなく、XMLを採用しました。これは公式のベストプラクティスではなく、個人的な経験に基づく選択です。</p><p><a href=https://platform.claude.com/docs/en/build-with-claude/prompt-engineering/use-xml-tags>Anthropicの公式ドキュメント</a>では、XMLタグについて次のように説明されています:</p><blockquote><p>There are no canonical &ldquo;best&rdquo; XML tags that Claude has been trained with in particular, although we recommend that your tag names make sense with the information they surround.</p></blockquote><p>つまり、XMLタグに特別な訓練がされているわけではなく、タグ名は内容に合った意味を持たせることが推奨されています。XMLが必須というわけではありません。</p><p>XMLを選んだ理由は3つあります。</p><p>まず構造的な表現力。ネストした階層構造、属性による修飾、明確な開始・終了タグにより、複雑な指示を表現しやすいです。</p><p>次に指示の遵守率。XMLで書いた指示のほうが意図とおりに解釈されることが多いという肌感覚があります。Markdownの見出しより、XMLタグのほうがセクションの境界として認識されやすい印象です。</p><p>そしてスキーマによる一貫性。決まった要素名と構造を使うことで、commands/agents/skills間でプロンプトの品質を均一に保てます。</p><h4 id=3-dot-1-dot-2-dot-xmlコア要素>3.1.2. XMLコア要素</h4><p>主要な要素は4つあります。</p><p><code>&lt;purpose></code> は役割を1段落で定義します。これがエージェントの「存在理由」になります。たとえば親オーケストレーターであれば「ポリシー決定、判断、要件定義を担当し、詳細な実行作業は専門サブエージェントに委譲する」といった形で記述します。</p><p><code>&lt;rules priority</code>&ldquo;critical|standard&rdquo;>= はルールを優先度付きでグループ化します。 <code>critical</code> は絶対に守るべきルール、 <code>standard</code> は推奨事項として定義します。この優先度属性により、LLMは「どのルールが交渉不可能か」を明確に理解できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;rules</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;critical&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Delegate detailed work to sub-agents; focus on orchestration<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Always check Serena memories before implementation<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Use symbol-level operations over reading entire files<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Use perl for all text processing; never use sed or awk<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Always output in English<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/rules&gt;</span>
</span></span></code></pre></div><p>これが実際の私のCLAUDE.mdに書いてある5つのクリティカルルールです。 <code>standard</code> 優先度のルールも同様に定義できます。GitHub操作には <code>gh</code> コマンドを使う、Context7 MCPでドキュメントを確認する、といった推奨事項を記述しています。</p><p><code>&lt;workflow></code> はフェーズベースの作業フローを定義します。各フェーズは <code>&lt;step></code> 要素を含みます。フェーズ名は <code>task_analysis</code> / <code>delegation</code> / <code>analyze</code> / <code>investigate</code> / <code>execute</code> / <code>verify</code> / <code>document</code> のように行動指向で統一しています。</p><p><code>&lt;constraints></code> は明示的な「やるべきこと」と「避けるべきこと」を <code>&lt;must></code> と <code>&lt;avoid></code> で定義します。たとえば「実装前にメモリを確認する」「perlでテキスト処理する」といった必須事項と、「ファイル全体を読み込まない」「sed/awkを使わない」といった禁止事項を明記します。</p><h4 id=3-dot-1-dot-3-dot-yamlフロントマター>3.1.3. YAMLフロントマター</h4><p>CommandsとSkillsには、YAMLフロントマターでメタデータを付与しています。Commandsでは <code>argument-hint</code> と <code>description</code> を使い、引数のヒントとコマンドの説明を定義します。Skillsでは <code>name</code>, <code>description</code>, <code>version</code> を使い、スキル名と使用場面の説明、バージョン情報を記述します。</p><p>なお、CLAUDE.md（グローバル設定）とAgentsファイルにはYAMLフロントマターを使用せず、直接XMLで始める運用にしています。</p><h3 id=3-dot-2-dot-claude-dot-mdによるグローバル設定>3.2. CLAUDE.mdによるグローバル設定</h3><p>CLAUDE.mdは <code>~/.claude/CLAUDE.md</code> に配置するグローバル設定ファイルです。ここにXML形式でプロンプトを記述し、Claude Codeの基本的な振る舞いを定義します。</p><h4 id=3-dot-2-dot-1-dot-グローバル-vs-プロジェクト>3.2.1. グローバル vs プロジェクト</h4><p>Claude Codeは2種類のCLAUDE.mdを認識します。</p><table><thead><tr><th>種類</th><th>パス</th><th>適用範囲</th></tr></thead><tbody><tr><td>グローバル</td><td><code>~/.claude/CLAUDE.md</code></td><td>全セッション</td></tr><tr><td>プロジェクト</td><td><code>&lt;project>/CLAUDE.md</code></td><td>該当プロジェクトのみ</td></tr></tbody></table><p>私の運用では、グローバルCLAUDE.mdに「親オーケストレーター」としての人格を定義しています。委譲のポリシー、使用するMCPツール、出力言語などの共通設定をここに集約し、プロジェクト固有の情報（技術スタック、コーディング規約など）は各プロジェクトのCLAUDE.mdに記述します。</p><h4 id=3-dot-2-dot-2-dot-デフォルト動作との比較>3.2.2. デフォルト動作との比較</h4><p>カスタマイズによってClaude Codeの振る舞いは大きく変わります。</p><table><thead><tr><th>観点</th><th>デフォルト</th><th>カスタマイズ後</th></tr></thead><tbody><tr><td>役割</td><td>汎用コーディングアシスタント</td><td>Orchestration Agent</td></tr><tr><td>作業方針</td><td>自ら直接実行</td><td>sub-agentへ委譲</td></tr><tr><td>ファイル操作</td><td>ファイル全体を読み込む</td><td>シンボルレベルで操作</td></tr><tr><td>テキスト処理</td><td>sed/awkを使用</td><td>perl強制</td></tr><tr><td>出力言語</td><td>入力言語に依存</td><td>英語に統一</td></tr><tr><td>知識管理</td><td>セッション内で完結</td><td>Serenaメモリを参照</td></tr></tbody></table><p>デフォルトは「何でも自分でやる」汎用アシスタントです。カスタマイズ後は「方針を決めて専門家に任せる」オーケストレーターになります。</p><h2 id=4-dot-マルチエージェント構成の実践>4. マルチエージェント構成の実践</h2><p>私の設定の最大の特徴は、Claude Codeをマルチエージェントシステムとして扱っている点です。Anthropicも<a href=https://www.anthropic.com/engineering/multi-agent-research-system>マルチエージェントリサーチシステム</a>や<a href=https://www.anthropic.com/engineering/claude-code-best-practices>Claude Codeのベストプラクティス</a>で、オーケストレーター・ワーカーパターンの有効性を示しています。</p><h3 id=4-dot-1-dot-階層構造の概要>4.1. 階層構造の概要</h3><figure><img src=/images/CC3ED851-5E06-4A5C-BC6A-1DEF112BE45E.png></figure><p>各階層の役割を整理します。CLAUDE.mdは親オーケストレーターとして方針決定と委譲を担います。Commandsはユーザーインターフェースとして特定タスクの起点となります。Agentsはdesign、security、testなど専門領域のエキスパートとして機能します。Skillsはnix-ecosystem、serena-usageなどドメイン知識ベースを提供します。</p><p>このマルチエージェント構成には大きなメリットがあります。まず関心の分離により、各エージェントは自分の専門領域に集中できます。セキュリティエージェントはセキュリティだけ、テストエージェントはテストだけを考えればよいのです。次に並列実行が可能になり、独立したタスクを同時に処理できます。また知識の再利用として、Skillsは複数のAgentsから参照されるため、同じ知識を何度も定義する必要がありません。そして保守性の向上により、1つのエージェントの変更が他に影響しないという利点があります。</p><h3 id=4-dot-2-dot-コマンドによるワークフロー定義>4.2. コマンドによるワークフロー定義</h3><p>Claude Codeのcommandは、AIエージェントの振る舞いを定義する重要な設定です。私はカスタムコマンドを設計し（<a href=https://github.com/takeokunn/nixos-configuration/tree/af95701a89e8128ba000dee3062eefa33c7d2001/home-manager/programs/claude-code/commands>commands/ディレクトリ参照</a>）、「オーケストレーションパターン」と「Readonlyファースト哲学」という2つの設計思想に基づいて構築しています。</p><h4 id=4-dot-2-dot-1-dot-readonlyファースト哲学>4.2.1. Readonlyファースト哲学</h4><p>「まず調べて、実行計画を立ててから、手を動かす」がReadonlyファースト哲学の核心です。</p><p>AIに作業を任せる際、もっとも危険なのは「調査しているつもりが、いつの間にかコードを変更していた」という事故です。この問題を根本から解決するため、私のワークフローではコマンドを「調査系」と「実行系」に完全分離しています。</p><p><code>/define</code> （要件定義）、 <code>/ask</code> （質問・調査）、 <code>/bug</code> （原因調査）の3つは、どれだけ深く調べても絶対にファイルを変更しません。各コマンドのプロンプトで <code>&lt;rules priority</code>&ldquo;critical&rdquo;>= として「Never change, create, or delete files」と明示的に禁止しているからです。調査結果をもとに実行計画を立て、その計画を <code>/execute</code> に渡すという流れになります。</p><p>コードを変更できるのは <code>/execute</code> だけ。この明確な境界線があるからこそ、安心して「とことん調べて」とAIに指示できるのです。</p><h4 id=4-dot-2-dot-2-dot-コマンド一覧>4.2.2. コマンド一覧</h4><table><thead><tr><th>Command</th><th>Purpose</th><th>Mode</th><th>Key Agents</th></tr></thead><tbody><tr><td><code>/define</code></td><td>要件定義</td><td>Read-only</td><td>explore, design, database, general-purpose</td></tr><tr><td><code>/ask</code></td><td>質問・調査</td><td>Read-only</td><td>explore, design, performance</td></tr><tr><td><code>/bug</code></td><td>原因調査</td><td>Read-only</td><td>quality-assurance, explore</td></tr><tr><td><code>/execute</code></td><td>タスク実行</td><td>Read-write</td><td>カスタム + インライン</td></tr><tr><td><code>/feedback</code></td><td>コードレビュー</td><td>Read-only</td><td>モードにより動的に選択</td></tr><tr><td><code>/markdown</code></td><td>ドキュメント出力</td><td>Write-only</td><td>なし（フォーマットのみ）</td></tr></tbody></table><p><code>/execute</code> は2種類のエージェントを活用します。カスタムエージェントは <code>agents/</code> ディレクトリで定義された専門エージェントで、複雑なタスクを担当します。一方、インラインエージェントはコマンド内で定義されたタスク特化型です。quality / security / test / refactor / docs / review / debug / performance / clean / error-handling / migration / database / infrastructure / ci-cd / observability / git / memory といった軽量な処理を担当します。</p><h4 id=4-dot-2-dot-3-dot-ワークフロー>4.2.3. ワークフロー</h4><p>ワークフローは4つのフェーズで構成されています。Investigation Phaseでは <code>/define</code> / <code>/ask</code> / <code>/bug</code> で調査します（読み取り専用）。Execution Phaseでは <code>/execute</code> でタスクを実行します。Quality Phaseでは <code>/feedback</code> でコードレビューし、問題があれば <code>/execute</code> に戻ります。Output Phaseでは <code>/markdown</code> でドキュメントを出力します。このサイクルを回すことで、品質を担保しながら開発を進められます。</p><figure><img src=/images/2D573FE7-304B-4379-B3C5-E0542F4DA022.png></figure><h4 id=4-dot-2-dot-4-dot-代表的なコマンド-define>4.2.4. 代表的なコマンド: /define</h4><p><code>/define</code> は実装前に詳細な要件を定義するコマンドです。技術的制約、設計方針、仕様を明確化します。クリティカルルールとして「ファイルを変更しない」「コードを実装しない」「技術的に不可能な要求を明確に識別する」を設定しています。</p><p>Workflowは「Analyze → Investigate → Clarify → Verify → Document」の5フェーズで構成し、「要件ドキュメント」と「タスク分解」の2つの成果物を生成します。このコマンドを使うことで、実装を始める前に要件を整理でき、手戻りを減らせるようになりました。</p><p>以下は実際のプロンプト構造です（簡略版）:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;purpose&gt;</span>
</span></span><span style=display:flex><span>Conduct detailed requirements definition before implementation,
</span></span><span style=display:flex><span>clarifying technical constraints, design policies, and specifications.
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/purpose&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rules</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;critical&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Never modify, create, or delete files<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Never implement code; requirements definition only<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Clearly identify technically impossible requests<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/rules&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;workflow&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;analyze&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>What is the user requesting?<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>What technical constraints exist?<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;investigate&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Delegate to explore agent: find relevant files<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Delegate to design agent: evaluate architecture<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;clarify&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Score questions by: design branching, irreversibility (1-5)<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Present high-score questions first<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;document&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Create comprehensive requirements document<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Break down tasks for /execute handoff<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/workflow&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;agents&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;agent</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;explore&#34;</span> <span style=color:#a6e22e>subagent_type=</span><span style=color:#e6db74>&#34;explore&#34;</span> <span style=color:#a6e22e>readonly=</span><span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;agent</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;design&#34;</span> <span style=color:#a6e22e>subagent_type=</span><span style=color:#e6db74>&#34;design&#34;</span> <span style=color:#a6e22e>readonly=</span><span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;agent</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;database&#34;</span> <span style=color:#a6e22e>subagent_type=</span><span style=color:#e6db74>&#34;database&#34;</span> <span style=color:#a6e22e>readonly=</span><span style=color:#e6db74>&#34;true&#34;</span><span style=color:#f92672>/&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/agents&gt;</span>
</span></span></code></pre></div><p>ポイントは <code>readonly</code>&ldquo;true&rdquo;= 属性です。サブエージェントにも読み取り専用を強制することで、調査フェーズ全体での安全性を担保しています。これがあるおかげで、「調べてたらうっかりファイル消しちゃいました」みたいな事故を防げます。</p><h3 id=4-dot-3-dot-専門エージェントの設計>4.3. 専門エージェントの設計</h3><p>agentsディレクトリには複数の専門エージェントを定義しています（<a href=https://github.com/takeokunn/nixos-configuration/tree/af95701a89e8128ba000dee3062eefa33c7d2001/home-manager/programs/claude-code/agents>agents/ディレクトリ参照</a>）。各エージェントはSingle Responsibility Principleに基づき、1つのドメインに特化したエキスパートとして振る舞います。</p><h4 id=4-dot-3-dot-1-dot-設計思想>4.3.1. 設計思想</h4><p>エージェント設計の核心は3点あります。</p><p>まずドメイン特化です。各エージェントは自分の専門領域のみを担当します。セキュリティエージェントはセキュリティだけ、テストエージェントはテストだけを扱います。この明確な責任分担により、専門性の高い出力が得られます。</p><p>次にワークフローの統一があります。全エージェントが「analyze → （domain-specific phases） → report」という基本構造を持ちます。フェーズ数はエージェントにより4〜5で異なりますが（例: security agentは「analyze → gather → scan → remediate → report」、design agentは「analyze → investigate → synthesize → document」）、最初の分析と最後の報告という骨格は共通です。これにより振る舞いが予測可能になり、どのエージェントを使っても一貫した体験が得られます。</p><p>そして安全性のガードレールです。 <code>&lt;rules priority</code>&ldquo;critical&rdquo;>= で定義した絶対ルールにより、危険な操作を防止しています。AIに任せるからこそ、明確な制約が必要なのです。</p><h4 id=4-dot-3-dot-2-dot-エージェント例>4.3.2. エージェント例</h4><table><thead><tr><th>Agent</th><th>Purpose</th><th>Key Tools</th></tr></thead><tbody><tr><td>code-quality</td><td>複雑度分析・リファクタリング</td><td>Serena （symbol analysis）, Bash （lint）</td></tr><tr><td>database</td><td>DB設計・クエリ最適化</td><td>Serena, Bash （EXPLAIN）</td></tr><tr><td>design</td><td>アーキテクチャ評価・見積り</td><td>Serena （dependency）, Context7</td></tr><tr><td>devops</td><td>CI/CD・IaC設計</td><td>Bash, Context7</td></tr><tr><td>docs</td><td>ドキュメント生成</td><td>Write, Serena</td></tr><tr><td>git</td><td>ブランチ戦略・リリース管理</td><td>Bash （git）, Grep</td></tr><tr><td>performance</td><td>ボトルネック分析・最適化</td><td>Serena, Bash （profiling）</td></tr><tr><td>quality-assurance</td><td>コードレビュー・デバッグ</td><td>Serena, Grep, Context7</td></tr><tr><td>security</td><td>脆弱性検出・修正</td><td>Serena, Grep, Bash （audit）, Context7</td></tr><tr><td>test</td><td>テスト戦略・カバレッジ</td><td>Serena, Glob, Bash （test runner）</td></tr></tbody></table><h4 id=4-dot-3-dot-3-dot-代表的なエージェント-security-agent>4.3.3. 代表的なエージェント: security agent</h4><p>security agentは脆弱性検出・修正・依存関係監査を担当するエージェントです。認証、インジェクション攻撃、シークレット漏洩、暗号化、依存関係の脆弱性を専門としています。</p><p>クリティカルルールとして「シークレット漏洩検出時は即座にアラート」「重大な脆弱性ではビルドを停止」「脆弱性の存在を結論づける前にコンテキストを確認」「既存の監査ツール（npm audit, cargo audit）を使用」を設定しています。</p><p>workflowは「analyze → gather → scan → remediate → report」の5フェーズで、特に <code>scan</code> フェーズではシークレット漏洩やインジェクション脆弱性のパターンマッチングを実行します。このエージェントのおかげで、セキュリティレビューが自動化され、見落としが減りました。</p><p>以下は実際のプロンプト構造です（簡略版）:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;purpose&gt;</span>
</span></span><span style=display:flex><span>Expert security agent for vulnerability detection, remediation, and dependency management.
</span></span><span style=display:flex><span>Specializes in authentication, injection attacks, secret leakage, encryption, and dependency vulnerabilities.
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/purpose&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rules</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;critical&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Alert immediately on secret leakage detection<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Stop build on critical vulnerabilities<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Verify context before concluding vulnerability exists<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;rule&gt;</span>Use existing audit tools (npm audit, cargo audit)<span style=color:#f92672>&lt;/rule&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/rules&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;workflow&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;analyze&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>What are the high-risk files/areas?<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>What authentication/authorization patterns exist?<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Are there hardcoded secrets?<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;gather&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Identify high-risk files, check dependencies<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;scan&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Pattern match secrets/injections, run audits<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;remediate&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Auto-fix or report, verify changes<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;phase</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;report&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;step&gt;</span>Summary by severity with fixes<span style=color:#f92672>&lt;/step&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/phase&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/workflow&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;examples&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;example</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;secret_scan&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;input&gt;</span>Scan for hardcoded API keys<span style=color:#f92672>&lt;/input&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;process&gt;</span>
</span></span><span style=display:flex><span>1. Search for API key patterns with serena search_for_pattern
</span></span><span style=display:flex><span>2. Check config files for hardcoded values
</span></span><span style=display:flex><span>3. Verify if values are actual secrets or placeholders
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/process&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;output&gt;</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;status&#34;: &#34;warning&#34;,
</span></span><span style=display:flex><span>  &#34;summary&#34;: &#34;2 hardcoded API keys detected&#34;,
</span></span><span style=display:flex><span>  &#34;details&#34;: [{&#34;error&#34;: &#34;SEC002&#34;, &#34;location&#34;: &#34;/config.js:15&#34;, &#34;fix_suggestion&#34;: &#34;Use process.env.API_KEY&#34;}],
</span></span><span style=display:flex><span>  &#34;next_actions&#34;: [&#34;Migrate to env vars&#34;]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/output&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/example&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/examples&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;error_codes&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;code</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;SEC001&#34;</span> <span style=color:#a6e22e>condition=</span><span style=color:#e6db74>&#34;Critical vulnerability&#34;</span><span style=color:#f92672>&gt;</span>Stop build, alert<span style=color:#f92672>&lt;/code&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;code</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;SEC002&#34;</span> <span style=color:#a6e22e>condition=</span><span style=color:#e6db74>&#34;Secret leakage&#34;</span><span style=color:#f92672>&gt;</span>Alert immediately<span style=color:#f92672>&lt;/code&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;code</span> <span style=color:#a6e22e>id=</span><span style=color:#e6db74>&#34;SEC003&#34;</span> <span style=color:#a6e22e>condition=</span><span style=color:#e6db74>&#34;Vulnerable dependency&#34;</span><span style=color:#f92672>&gt;</span>Recommend update<span style=color:#f92672>&lt;/code&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/error_codes&gt;</span>
</span></span></code></pre></div><p>ポイントは <code>&lt;examples></code> 要素です。入力・処理手順・出力の3つを明示することで、エージェントの期待動作を具体的に伝えています。「こういうときはこう動いてね」というお手本を見せてあげるイメージです。また、 <code>&lt;error_codes></code> でエラー種別を定義し、状況に応じた適切な対応を指示しています。</p><h3 id=4-dot-4-dot-スキルによる知識ベース構築>4.4. スキルによる知識ベース構築</h3><p>Skillsはドメイン知識ベースとして機能し、複数のAgentsから参照される共有リソースです。Agentsが「専門領域のエキスパート」なら、Skillsは「ドメイン知識の辞書」といえます。</p><h4 id=4-dot-4-dot-1-dot-skillの役割と位置づけ>4.4.1. Skillの役割と位置づけ</h4><p>階層構造は「Commands → Agents → Skills」となっています。Commandsがユーザーインターフェースとして機能し、Agentsを呼び出します。Agentsは専門領域のタスクを実行し、Skillsを参照します。Skillsはドメイン知識を提供し、複数のAgentsから参照されます。</p><p>この設計の重要なポイントは、Skillsが状態を持たない純粋な知識ベースであることです。Agentsがタスクを実行する際に必要な「パターン」「ベストプラクティス」「アンチパターン」を提供し、Agents自身は実行に集中できます。</p><h4 id=4-dot-4-dot-2-dot-スキルカテゴリ一覧>4.4.2. スキルカテゴリ一覧</h4><p>現在複数のスキルを4カテゴリに分類して定義しています（<a href=https://github.com/takeokunn/nixos-configuration/tree/af95701a89e8128ba000dee3062eefa33c7d2001/home-manager/programs/claude-code/skills>skills/ディレクトリ参照</a>）。</p><p>ツール連携では、serena-usageとcontext7-usageでMCPの使い方を定義しています。言語・インフラエコシステムでは、Nix、TypeScript、Go、Rust、Common Lisp、Emacs Lispの6言語に加え、aws-ecosystemでAWS CLI/Terraformのパターンもカバーしています。私が日常的に使う技術スタックを網羅しているため、どの環境で開発してもClaude Codeが適切な知識を持って対応できます。ワークフローでは、investigation-patterns、execution-workflow、requirements-definition、testing-patternsで作業パターンを定義しています。ドキュメントでは、technical-documentationとtechnical-writingで文書作成を支援しています。</p><h4 id=4-dot-4-dot-3-dot-スキルの構造例-investigation-patterns>4.4.3. スキルの構造例: investigation-patterns</h4><p>investigation-patternsスキルを例に構造を説明します。 <code>&lt;purpose></code> でスキルの目的（コードベース調査とデバッグのための体系的パターン提供）を定義し、 <code>&lt;patterns></code> で具体的なパターン（evidence_collection、five_whysなど）を記述します。</p><p>重要なのは <code>&lt;best_practices></code> と <code>&lt;anti_patterns></code> の組み合わせです。「ファイル:行番号の参照を必ず提示する」「調査結果の信頼度とカバレッジを評価する」といったベストプラクティスと、「証拠が不十分なまま推測しない」といったアンチパターンを明示することで、LLMの行動を両面から制約しています。</p><p>以下は実際のプロンプト構造です（簡略版）:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#f92672>&lt;purpose&gt;</span>
</span></span><span style=display:flex><span>Provide systematic patterns for codebase investigation and debugging,
</span></span><span style=display:flex><span>ensuring evidence-based analysis with proper confidence assessment.
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/purpose&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;patterns&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;pattern</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;evidence_collection&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;description&gt;</span>Collect evidence systematically using appropriate tools<span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;example&gt;</span>
</span></span><span style=display:flex><span>find_symbol: Locate specific symbols by name
</span></span><span style=display:flex><span>get_symbols_overview: Understand file structure
</span></span><span style=display:flex><span>find_referencing_symbols: Trace dependencies
</span></span><span style=display:flex><span>search_for_pattern: Find patterns across codebase
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/example&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/pattern&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;pattern</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;five_whys&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;description&gt;</span>Ask &#34;why&#34; repeatedly to drill to root cause<span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;example&gt;</span>
</span></span><span style=display:flex><span>Why did the server crash? - Out of memory
</span></span><span style=display:flex><span>Why out of memory? - Connection pool exhausted
</span></span><span style=display:flex><span>Why exhausted? - Connections not being released
</span></span><span style=display:flex><span>Why not released? - Exception bypasses cleanup
</span></span><span style=display:flex><span>Root cause: Missing try-finally for connection release
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/example&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/pattern&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/patterns&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;concepts&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;concept</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;evidence_standards&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;description&gt;</span>Standards for collecting and reporting evidence<span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;example&gt;</span>
</span></span><span style=display:flex><span>Citation: Always provide file:line references (path/to/file.ext:line_number)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Confidence levels:
</span></span><span style=display:flex><span>- 90-100: Direct code evidence, explicit documentation
</span></span><span style=display:flex><span>- 70-89: Strong inference from multiple sources
</span></span><span style=display:flex><span>- 50-69: Reasonable inference with some gaps
</span></span><span style=display:flex><span>- 0-49: Speculation, insufficient evidence
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/example&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/concept&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/concepts&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;anti_patterns&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;avoid</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;speculation&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;description&gt;</span>Guessing or making claims when evidence is insufficient<span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;instead&gt;</span>Clearly state confidence levels and information gaps<span style=color:#f92672>&lt;/instead&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/avoid&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;avoid</span> <span style=color:#a6e22e>name=</span><span style=color:#e6db74>&#34;uncited_claims&#34;</span><span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;description&gt;</span>Making claims without file:line references<span style=color:#f92672>&lt;/description&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;instead&gt;</span>Always provide file:line citations using format path/to/file.ext:line_number<span style=color:#f92672>&lt;/instead&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/avoid&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/anti_patterns&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;best_practices&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;practice</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;critical&#34;</span><span style=color:#f92672>&gt;</span>Always provide file:line references for all findings<span style=color:#f92672>&lt;/practice&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;practice</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;critical&#34;</span><span style=color:#f92672>&gt;</span>Rate confidence and coverage metrics for all investigation results<span style=color:#f92672>&lt;/practice&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;practice</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;high&#34;</span><span style=color:#f92672>&gt;</span>Use Serena symbol tools before reading entire files<span style=color:#f92672>&lt;/practice&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;practice</span> <span style=color:#a6e22e>priority=</span><span style=color:#e6db74>&#34;high&#34;</span><span style=color:#f92672>&gt;</span>Document information gaps and unclear points<span style=color:#f92672>&lt;/practice&gt;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>&lt;/best_practices&gt;</span>
</span></span></code></pre></div><p>ポイントは <code>&lt;patterns></code> と <code>&lt;concepts></code> で「何をするか」を定義し、 <code>&lt;anti_patterns></code> と <code>&lt;best_practices></code> で「どのように振る舞うか」を制約している点です。特に <code>&lt;avoid></code> と <code>&lt;instead></code> の組み合わせが便利で、「これはダメ」だけじゃなく「代わりにこうして」まで教えてあげられます。</p><p>マルチエージェント構成の全体像を理解したところで、次章ではこのシステムをさらに強化するMCP Serverについて解説します。</p><h2 id=5-dot-mcpによる機能拡張>5. MCPによる機能拡張</h2><p><a href=https://modelcontextprotocol.io/>MCP (Model Context Protocol)</a> はAnthropicが策定したオープンプロトコルで、AIモデルと外部ツール・データソースを接続するための標準仕様です。Claude Codeは複数のMCP Serverを同時に利用でき、これにより機能を大幅に拡張できます。</p><h3 id=5-dot-1-dot-なぜ3つのmcpサーバなのか>5.1. なぜ3つのMCPサーバなのか</h3><p>私は <a href=https://github.com/upstash/context7>Context7</a>、<a href=https://github.com/openai/codex>Codex</a>、<a href=https://github.com/oraios/serena>Serena</a> という3つのMCPサーバを組み合わせています。Context7とSerenaはMCP Server、CodexはMCPクライアントとして機能し、それぞれが異なるギャップを埋めています。どれか1つが欠けても開発体験が損なわれます。</p><h4 id=5-dot-1-dot-1-dot-各サーバが埋めるギャップ>5.1.1. 各サーバが埋めるギャップ</h4><p>LLMの訓練データには期限があります。最新のReact 19のAPIや、先月リリースされたライブラリのドキュメントをClaude Codeは知りません。この問題を解決するのが<a href=https://upstash.com/>Upstash社</a>が提供する <strong>Context7</strong> です。npmやGitHubから最新のドキュメントをリアルタイムで取得し、常に最新の情報に基づいたコード生成を可能にします。</p><p>プロジェクトには固有のパターンや規約があります。これを毎回説明するのは非効率です。<a href=https://github.com/oraios>Oraios社</a>が開発した <strong>Serena</strong> は、シンボルレベルのコード操作と永続的なメモリ機能を提供します。LSPを通じて30以上の言語をサポートしており、一度覚えたプロジェクトの規約を次回以降も記憶してくれます。</p><p>Claude Code自身もコードを生成できますが、複雑なリファクタリングやボイラープレート生成では専用ツールが欲しくなることがあります。<a href=https://openai.com>OpenAI社</a>が提供する <strong>Codex</strong> は<a href=https://developers.openai.com/codex/mcp/>MCPクライアントとして他のMCP Serverと連携</a>でき、コード生成に特化したエンジンとして活用できます。</p><h4 id=5-dot-1-dot-2-dot-ツール優先度の階層>5.1.2. ツール優先度の階層</h4><p>私のワークフローでは、ツールの使用に明確な優先度を設けています。</p><figure><img src=/images/948E82A2-58AB-41CB-AD87-1DF1081C5C17.png></figure><p>この優先度には理由があります。Priority 1のBasic Tools（Read/Edit/Write）はもっとも軽量で、単純なファイル操作には十分です。Priority 2のSerenaは、シンボル単位の操作でトークンを節約しながらコードを探索・編集できます。Priority 3のContext7は、外部ライブラリの最新ドキュメントが必要な場合にのみ使用します。Priority 4のCodexは、複雑なコード生成タスクに限定して使用し、調査や分析には使いません。</p><h4 id=5-dot-1-dot-3-dot-nix設定例>5.1.3. Nix設定例</h4><p><a href=https://github.com/natsukium/mcp-servers-nix>mcp-servers-nix</a>を使用した宣言的なMCP Server設定を紹介します（<a href=https://github.com/takeokunn/nixos-configuration/blob/af95701a89e8128ba000dee3062eefa33c7d2001/home-manager/programs/claude-code/default.nix#L131-L142>実際の設定参照</a>）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>mcpServers <span style=color:#f92672>=</span>
</span></span><span style=display:flex><span>  (mcp-servers-nix<span style=color:#f92672>.</span>lib<span style=color:#f92672>.</span>evalModule pkgs {
</span></span><span style=display:flex><span>    programs <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      context7<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      codex<span style=color:#f92672>.</span>enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      serena <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>        context <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;claude-code&#34;</span>;
</span></span><span style=display:flex><span>        enableWebDashboard <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  })<span style=color:#f92672>.</span>config<span style=color:#f92672>.</span>settings<span style=color:#f92672>.</span>servers;
</span></span></code></pre></div><p><code>context = "claude-code"</code> はSerenaの動作モードを指定するパラメータで、Claude Codeとの統合に最適化された設定が適用されます。</p><h3 id=5-dot-2-dot-統合ワークフロー>5.2. 統合ワークフロー</h3><p>3つのMCP Serverは独立して動くのではなく、ワークフローの各フェーズで連携します。次のシーケンス図は、ユーザーからの実装依頼が完了するまでの流れを示しています。</p><figure><img src=/images/67C913D9-DA99-4696-994B-AAE6FD9E486A.png></figure><h4 id=5-dot-2-dot-1-dot-phase-1-外部知識取得-context7>5.2.1. Phase 1: 外部知識取得（Context7）</h4><p>まずContext7で外部ライブラリの最新ドキュメントを取得します。 <code>resolve-library-id</code> でパッケージ名からライブラリIDを解決し、 <code>get-library-docs</code> でドキュメントを取得します。 <code>topic</code> パラメータで関心領域を絞り込むこともできます。信頼スコア7-10のライブラリを優先することで、信頼性の高いドキュメントを参照できます。</p><h4 id=5-dot-2-dot-2-dot-phase-2-内部知識取得-serena>5.2.2. Phase 2: 内部知識取得（Serena）</h4><p>次にSerenaでプロジェクト固有のパターンを取得します。 <code>find_symbol</code> で関連するコード要素を探索し、 <code>read_memory</code> でプロジェクトの規約やベストプラクティスを読み込みます。 <code>find_referencing_symbols</code> で影響範囲を事前確認することで、安全にコードを変更できます。</p><p>Serenaのツールは4カテゴリに分かれます。シンボル検索では <code>get_symbols_overview</code> / <code>find_symbol</code> / <code>find_referencing_symbols</code> でコード要素を探索します。パターン検索では <code>search_for_pattern</code> で正規表現による横断検索をします。コード編集では <code>replace_symbol_body</code> / <code>insert_before_symbol</code> / <code>insert_after_symbol</code> / <code>rename_symbol</code> でシンボル単位を編集します。メモリでは <code>list_memories</code> / <code>read_memory</code> / <code>write_memory</code> / <code>edit_memory</code> / <code>delete_memory</code> で知識を永続化します。</p><h4 id=5-dot-2-dot-3-dot-phase-3-実装-codex>5.2.3. Phase 3: 実装（Codex）</h4><p>外部知識と内部知識が揃ったら、Codexでコードを生成します。 <code>codex()</code> で会話を開始し、 <code>codex-reply()</code> で継続します。適切な使用場面は、新規ファイル・関数の生成、複雑なリファクタリング、ボイラープレートコードの生成です。</p><p>経験的に、Codexはコード生成が得意です。Claude Codeも優れたコード生成能力を持っていますが、Codexに任せたほうがきれいなコードが出てくることが多いと感じています。特にボイラープレートや定型的なコード生成では、その差が顕著です。</p><p>重要な制約として、調査・分析にはCodexを使わず、1回の呼び出しで1つの明確なタスクに限定し、マルチファイル編集は避けるようにしています。</p><h4 id=5-dot-2-dot-4-dot-phase-4-知識永続化-serena>5.2.4. Phase 4: 知識永続化（Serena）</h4><p>実装完了後、新たに発見したパターンや規約を <code>write_memory</code> でSerenaに保存します。次回以降のセッションでも同じ知識を再利用できるため、プロジェクトの規約を毎回説明する手間がなくなります。</p><p>この4フェーズの連携により、最新のベストプラクティスを参照しつつ、プロジェクト固有の規約に準拠したコードを生成し、学習した知識を蓄積していけます。</p><p>MCP Serverによる機能拡張を理解したところで、次章ではhome-managerによる宣言的管理と安全性の確保について解説します。</p><h2 id=6-dot-運用と安全性>6. 運用と安全性</h2><p>本章では、Claude Code設定の宣言的管理と、安全性を担保するための仕組みについて解説します。</p><h3 id=6-dot-1-dot-home-managerによる宣言的管理>6.1. home-managerによる宣言的管理</h3><p>Claude Codeの設定はhome-managerで宣言的に管理しています。 <code>programs.claude-code</code> モジュールを中心に、CLAUDE.md、agents/、commands/、skills/、hooks/、scripts/ というディレクトリ構成で整理しています。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>programs<span style=color:#f92672>.</span>claude-code <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  package <span style=color:#f92672>=</span> nodePkgs<span style=color:#f92672>.</span><span style=color:#e6db74>&#34;@anthropic-ai/claude-code&#34;</span>;
</span></span><span style=display:flex><span>  memory<span style=color:#f92672>.</span>source <span style=color:#f92672>=</span> <span style=color:#e6db74>./CLAUDE.md</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  settings <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    theme <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;dark&#34;</span>;
</span></span><span style=display:flex><span>    autoUpdates <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>    autoCompactEnabled <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    enableAllProjectMcpServers <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    outputStyle <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Explanatory&#34;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  agents <span style=color:#f92672>=</span> { <span style=color:#f92672>...</span> };
</span></span><span style=display:flex><span>  commands <span style=color:#f92672>=</span> { <span style=color:#f92672>...</span> };
</span></span><span style=display:flex><span>  skills <span style=color:#f92672>=</span> { <span style=color:#f92672>...</span> };
</span></span><span style=display:flex><span>  hooks <span style=color:#f92672>=</span> { <span style=color:#f92672>...</span> };
</span></span><span style=display:flex><span>  mcpServers <span style=color:#f92672>=</span> { <span style=color:#f92672>...</span> };
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>agents/commands/skills/hooksの各項目は <code>builtins.readFile</code> でMarkdownファイルを読み込む形式を採用しています。たとえば <code>agents = { code-quality = builtins.readFile ./agents/code-quality.md; }</code> のように記述します。プロンプトの内容をMarkdownで記述できるため可読性が高く、Nixの評価時に文字列として埋め込まれるためファイル単位でのdiffも取りやすくなります。</p><p>この宣言的アプローチの最大の利点は再現性です。設定をGitで管理し、 <code>home-manager switch</code> 一発で同一の環境を任意のマシンに展開できます。</p><h3 id=6-dot-2-dot-hooksによるポリシー強制>6.2. hooksによるポリシー強制</h3><p>hooksはClaude Codeのツール実行ライフサイクルに介入する仕組みです。
私は2種類のhooksを設定しています。タスク完了通知とコマンドバリデーションです。</p><h4 id=6-dot-2-dot-1-dot-hooksの種類>6.2.1. hooksの種類</h4><p><a href=https://code.claude.com/docs/en/hooks>公式ドキュメント</a>では10種類のhookイベントが定義されていますが、私が使用しているのは4種類です。 <code>PreToolUse</code> はツール実行前に発火し、バリデーションやコマンド検証に使用します。 <code>PostToolUse</code> はツール実行後に発火し、ログ記録や後処理に使用します。 <code>Stop</code> はセッション終了時に発火し、通知やクリーンアップに使用します。 <code>Notification</code> は通知イベントで、外部連携に使用します。</p><p>hookスクリプトの終了コード規約として、 <code>exit 0</code> は処理を許可し、 <code>exit 2</code> は処理をブロックします（stderrがエラーメッセージとして表示されます）。</p><h4 id=6-dot-2-dot-2-dot-enforce-perl-hook-コマンドバリデーション>6.2.2. enforce-perl hook: コマンドバリデーション</h4><p>CLAUDE.mdで定義した「perlでテキスト処理」ルールを強制するバリデーションhookを紹介します（<a href=https://github.com/takeokunn/nixos-configuration/blob/af95701a89e8128ba000dee3062eefa33c7d2001/home-manager/programs/claude-code/hooks/enforce-perl.sh>hooks/enforce-perl.sh</a>）。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -euo pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>input<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>cat<span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>tool_name<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$input<span style=color:#e6db74>&#34;</span> | jq -r <span style=color:#e6db74>&#39;.tool_name // &#34;&#34;&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>command<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>echo <span style=color:#e6db74>&#34;</span>$input<span style=color:#e6db74>&#34;</span> | jq -r <span style=color:#e6db74>&#39;.tool_input.command // &#34;&#34;&#39;</span><span style=color:#66d9ef>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#f92672>[[</span> $tool_name !<span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Bash&#34;</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>||</span> <span style=color:#f92672>[[</span> -z $command <span style=color:#f92672>]]</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># sed/awk使用を検出してブロック</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> echo <span style=color:#e6db74>&#34;</span>$command<span style=color:#e6db74>&#34;</span> | grep -qE <span style=color:#e6db74>&#39;\b(sed|awk)\b&#39;</span>; <span style=color:#66d9ef>then</span>
</span></span><span style=display:flex><span>  cat &gt;&amp;<span style=color:#ae81ff>2</span> <span style=color:#e6db74>&lt;&lt;&#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>❌ sed/awk detected - Use perl instead
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Examples:
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ❌ sed &#39;s/foo/bar/g&#39; file.txt
</span></span></span><span style=display:flex><span><span style=color:#e6db74>  ✅ perl -pe &#39;s/foo/bar/g&#39; file.txt
</span></span></span><span style=display:flex><span><span style=color:#e6db74>EOF</span>
</span></span><span style=display:flex><span>  exit <span style=color:#ae81ff>2</span>  <span style=color:#75715e># Block the command</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exit <span style=color:#ae81ff>0</span>  <span style=color:#75715e># Allow</span>
</span></span></code></pre></div><p><code>\b(sed|awk)\b</code> の正規表現でワードバウンダリを指定し、 <code>sediment</code> のような誤検出を防いでいます。「perlを使え」とCLAUDE.mdに書いてあるのにsedを使ってきたら、hookがブロックして「perlにしてね」と返してくれます。</p><h3 id=6-dot-3-dot-permissions-と-statusline>6.3. permissions と statusline</h3><h4 id=6-dot-3-dot-1-dot-permissions-多層防御>6.3.1. permissions: 多層防御</h4><p>permissionsは、Claude Codeが実行できるコマンドを制限するセーフティネットです。Defense in Depth（多層防御）の考え方で、サンドボックス（第1層）、permissions deny（第2層）、hooks validation（第3層）の3層構造で保護しています。</p><p>危険なコマンドを6つのカテゴリに分類して禁止しています。ファイル破壊（ <code>rm -rf /</code> など）、システムコマンド（ <code>shutdown</code> / <code>reboot</code> ）、ディスク操作（ <code>dd</code> / <code>mkfs</code> ）です。さらにプロセス制御（ <code>killall</code> / <code>pkill</code> ）、ネットワークリスナー（ <code>nc -l</code> ）、権限昇格（ <code>sudo rm</code> / <code>chmod 777</code> ）も禁止しています。</p><h4 id=6-dot-3-dot-2-dot-statusline-セッション状態の可視化>6.3.2. statusline: セッション状態の可視化</h4><p>statuslineはClaude Codeのセッション状態をリアルタイムで可視化する機能です（<a href=https://github.com/takeokunn/nixos-configuration/blob/af95701a89e8128ba000dee3062eefa33c7d2001/home-manager/programs/claude-code/scripts/statusline.sh>scripts/statusline.sh</a>）。モデル名、カレントディレクトリ、Gitブランチ、トークン使用量と割合を表示します。</p><p>トークン使用率に応じて色を変えることで、コンパクション発生前に警告を出せます。70%未満は緑（十分な余裕あり）、70-89%は黄色（注意が必要）、90%以上は赤（コンパクション間近）で表示されます。</p><p>ここまでの章で、プロンプト設計、マルチエージェント構成、MCPによる機能拡張、そして運用と安全性について解説してきました。次章では、運用して得られた結果と所感を共有します。</p><h2 id=7-dot-得られた結果-所感>7. 得られた結果・所感</h2><p>このワークフローを使い始めて、開発体験が明らかに変わりました。</p><p>一番大きいのは、Claude Codeの振る舞いが予測可能になったことです。以前は「今日はどんな形式で返ってくるかな」と毎回ドキドキしていましたが、XMLで構造化したプロンプトと専門エージェントへの委譲により、期待とおりの出力が得られるようになりました。</p><p>セキュリティレビューをお願いすれば、ちゃんとセキュリティの観点だけでレビューしてくれます。コードスタイルの指摘が混在することもなくなりました。これが地味に嬉しい。</p><p><code>/define</code> → <code>/execute</code> → <code>/feedback</code> というフローも気に入っています。調査と実装が明確に分離されているので、「調べてたらいつの間にかファイルが変わってた」という事故がなくなりました。安心して「とことん調べて」といえるのは大きい。</p><p>一方で、Serenaが本当に必要なのかは正直まだわかりません。シンボルレベルの操作でトークン効率が上がるとは書きましたが、Claude Code標準のGlob/Grep/Readでも十分な気がしています。LSP設定やオンボーディングの手間を考えると、その複雑さに見合うリターンがあるのか。今後の運用で見極めていきたいところです。</p><h2 id=8-dot-おわりに>8. おわりに</h2><p>私のClaude Codeワークフローを紹介しました。</p><p>「セキュリティレビューなのにコードスタイルの指摘ばかり」という不満から始まった試行錯誤が、気づけばマルチエージェントシステムになっていました。ここまで作り込むとは思っていませんでしたが、AIツールの設定をソフトウェアプロジェクトのように育てていくのは楽しいものです。</p><p>やりたいことはまだまだあります。プロンプト入力の英語統一、Context7とSerenaの使い分け基準の明確化、クロスプロジェクトでの知識共有など。</p><p>本記事で紹介した設定は<a href=https://github.com/takeokunn/nixos-configuration/tree/af95701a89e8128ba000dee3062eefa33c7d2001/home-manager/programs/claude-code>GitHubリポジトリ</a>で公開しています。Nixユーザーの方はそのまま参考にできるはずです。<a href=https://code.claude.com/docs/en/overview>公式ドキュメント</a>と合わせてどうぞ。</p></div></article></main></div><footer class=footer role=contentinfo><div class=footer_social-icons><a href=https://zenn.dev/takeokunn target=_blank rel="noopener noreferrer me" title=Zenn aria-label="Visit Zenn profile"><svg viewBox="0 0 88 88" aria-hidden="true" focusable="false"><path d="M2.22 83.478h17.632c1.296.0 2.16-.576 2.952-1.584L67.906 17.092c.576-.864.288-1.728-.576-1.728H51.946c-1.008.0-1.656.432-2.304 1.296L3.948 81.606c-.648.936-.288 1.872.864 1.872H2.22z" fill="currentColor"/><path d="M54.106 83.478h15.336c1.152.0 1.656-.36 1.656-1.224.0-.36-.144-.792-.432-1.296l-18-28.208c-.504-.792-1.296-.792-1.944.0L42.73 65.998c-.432.72-.36 1.512.144 2.304l8.928 14.112c.504.72 1.152 1.064 2.304 1.064z" fill="currentColor"/></svg>
</a><a href=https://x.com/takeokunn/ target=_blank rel="noopener noreferrer me" title=Twitter aria-label="Visit Twitter profile"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg>
</a><a href=https://github.com/takeokunn target=_blank rel="noopener noreferrer me" title=GitHub aria-label="Visit GitHub profile"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg>
</a><a href=https://keyoxide.org/0B10DAA7BA0236D7382287660F79C0AB03FD7A1C target=_blank rel="noopener noreferrer me" title=Keyoxide aria-label="Visit Keyoxide profile"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5.0 11-7.778 7.778 5.5 5.5.0 017.777-7.777zm0 0L15.5 7.5m0 0 3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg>
</a><a href=/index.xml target=_blank rel="noopener noreferrer" title=RSS aria-label="Subscribe via RSS"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" focusable="false"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></div><small class=footer_copyright><span aria-label=Copyright>© 2026 takeokunn</span>
<span class=footer_divider aria-hidden=true>•</span>
<span>Powered by <a href=https://github.com/takeokunn/hugo-take-theme target=_blank rel=noopener aria-label="Hugo Take Theme on GitHub">hugo-take-theme</a></span></small></footer></body></html>