{
  "id": "0BFC86EF-E8FF-40A7-9C02-838BDE2E8D7D",
  "title": "PHP Exceptionのpropertyにあるcodeはuser-defined error code",
  "raw": ":PROPERTIES:\n:ID:       0BFC86EF-E8FF-40A7-9C02-838BDE2E8D7D\n:mtime:    20231217114822\n:ctime:    20230801135235\n:END:\n#+TITLE: PHP Exceptionのpropertyにあるcodeはuser-defined error code\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2023-08-01T09:00:00+09:00\n#+HUGO_BASE_DIR: ../../\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_TAGS: php\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\n仕事でPHPStanの修正をしている時、 =Exception= classのconstructorでcodeを指定しているコードに出くわした。\n=Exception= におけるcodeの扱いについて記述している記事がなかったので [[https://github.com/php/php-src][php/php-src]] のコードにあたってみた。\n\n* 簡易的な調査\n** Interface定義\nphp.netのUser Contributed Notesに次のような記述がある。\nhttps://www.php.net/manual/en/language.exceptions.php#91159\n\n#+begin_src php\n  <?php\n\n  interface IException\n  {\n      /* Protected methods inherited from Exception class */\n      public function getMessage();                 // Exception message\n      public function getCode();                    // User-defined Exception code\n      public function getFile();                    // Source filename\n      public function getLine();                    // Source line\n      public function getTrace();                   // An array of the backtrace()\n      public function getTraceAsString();           // Formated string of trace\n\n      /* Overrideable methods inherited from Exception class */\n      public function __toString();                 // formated string for display\n      public function __construct($message = null, $code = 0);\n  }\n#+end_src\n\n=code= とは =User-defined Exception code= と書いてあるとおり、ユーザー側が任意の数値を入れられる。\n\nPHPStanを実行すると次のような型として認識されているようだ。\n\n#+begin_src php\n  public function __construct(string $message = null, int $code = 0);\n#+end_src\n\n** php-srcコードリーディング\n\nExceptionの定義は以下。\n\n[[https://github.com/php/php-src/blob/3d5f2394741815ab2166bddd25f31f3958dc2895/Zend/zend_exceptions.c#L303-L330][Zend/zend_exceptions.c#L303-L330]]:\n\n#+begin_src c\n  /* {{{ Exception constructor */\n  ZEND_METHOD(Exception, __construct)\n  {\n          zend_string *message = NULL;\n          zend_long   code = 0;\n          zval  tmp, *object, *previous = NULL;\n          zend_class_entry *base_ce;\n\n          object = ZEND_THIS;\n          base_ce = i_get_exception_base(Z_OBJ_P(object));\n\n          if (zend_parse_parameters(ZEND_NUM_ARGS(), \"|SlO!\", &message, &code, &previous, zend_ce_throwable) == FAILURE) {\n                  RETURN_THROWS();\n          }\n\n          if (message) {\n                  ZVAL_STR(&tmp, message);\n                  zend_update_property_ex(base_ce, Z_OBJ_P(object), ZSTR_KNOWN(ZEND_STR_MESSAGE), &tmp);\n          }\n\n          if (code) {\n                  ZVAL_LONG(&tmp, code);\n                  zend_update_property_ex(base_ce, Z_OBJ_P(object), ZSTR_KNOWN(ZEND_STR_CODE), &tmp);\n          }\n\n          if (previous) {\n                  zend_update_property_ex(base_ce, Z_OBJ_P(object), ZSTR_KNOWN(ZEND_STR_PREVIOUS), previous);\n          }\n  }\n  /* }}} */\n#+end_src\n\nC言語的には =code= は =long long= で定義されている。\n\n[[https://github.com/php/php-src/blob/3d5f2394741815ab2166bddd25f31f3958dc2895/Zend/zend_long.h#L32][Zend/zend_long.h#L32]]:\n\n#+begin_src c\n  typedef int64_t zend_long;\n#+end_src\n\nExceptionが提供しているmethodは =getCode= のみ。\n\n[[https://github.com/php/php-src/blob/3d5f2394741815ab2166bddd25f31f3958dc2895/Zend/zend_exceptions.c#L441-L452][Zend/zend_exceptions.c#L441-L452]]:\n\n#+begin_src c\n  /* {{{ Get the exception code */\n  ZEND_METHOD(Exception, getCode)\n  {\n          zval *prop, rv;\n\n          ZEND_PARSE_PARAMETERS_NONE();\n\n          prop = GET_PROPERTY(ZEND_THIS, ZEND_STR_CODE);\n          ZVAL_DEREF(prop);\n          ZVAL_COPY(return_value, prop);\n  }\n  /* }}} */\n#+end_src\n\n* 使用例\n\n次のように取得できる。\nプロジェクト内でエラーコードをintegerで統一できているなら使い道がありそう。\n\n#+begin_src php :exports both\n  const ERROR_CODE = 10;\n\n  try {\n      throw new \\Exception(null, ERROR_CODE);\n  } catch (\\Exception $e) {\n      var_dump($e->getCode());\n  }\n#+end_src\n\n#+RESULTS:\n: int（10）\n\nPHPUnitでcodeを元にexcepionする関数 =TestCase#expectExceptionCode= が生えているのでテスト時に使えそう。\nhttps://github.com/sebastianbergmann/PHPUnit/blob/main/src/Framework/TestCase.php#L430-L433\n",
  "backlinks": []
}