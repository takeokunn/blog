<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Fluent-Bit on takeokunn's blog</title><link>https://www.takeokunn.org/tags/fluent-bit/</link><description>Recent content in Fluent-Bit on takeokunn's blog</description><generator>Hugo -- gohugo.io</generator><language>ja-jp</language><lastBuildDate>Wed, 07 Dec 2022 09:00:00 +0900</lastBuildDate><atom:link href="https://www.takeokunn.org/tags/fluent-bit/index.xml" rel="self" type="application/rss+xml"/><item><title>fluent-bitに入門する</title><link>https://www.takeokunn.org/posts/permanent/20221207214034-about_fluent_bit/</link><pubDate>Wed, 07 Dec 2022 09:00:00 +0900</pubDate><guid>https://www.takeokunn.org/posts/permanent/20221207214034-about_fluent_bit/</guid><description>&lt;h2 id="始めに"&gt;始めに&lt;/h2&gt;
&lt;p&gt;複数のサーバを管理すればする程、loggingの重要性が高まります。
特に2022年はコンテナ最盛期と言っても過言ではないくらいコンテナ化が進んでいています。&lt;/p&gt;
&lt;p&gt;logを適切に扱うことができればできるほど、運用の質を上げることができます。&lt;/p&gt;
&lt;h2 id="fluent-bitとは"&gt;fluent-bitとは&lt;/h2&gt;
&lt;p&gt;fluent-bitは高速なlogging libraryです。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://github.com/fluent/fluent-bit"&gt;https://github.com/fluent/fluent-bit&lt;/a&gt;&lt;/p&gt;
&lt;figure&gt;&lt;img src="https://www.takeokunn.org/images/A53EA3D4-B9C5-4885-9E28-A36801B82581.png"&gt;
&lt;/figure&gt;
&lt;p&gt;FluentdはRuby実装で、fluent-bitはC実装です。
シングルバイナリで提供できるので、Dockerではfluent-bitの方を用いられることが多いです。&lt;/p&gt;
&lt;p&gt;fluent-bitと調べてもあまりまとまった情報がなく、非常にとっつきにくいので後学のためにまとめておく。&lt;/p&gt;
&lt;h2 id="環境構築"&gt;環境構築&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://www.takeokunn.org/posts/fleeting/20221207173426-run_fluent_bit_docker/"&gt;fluent-bitをDockerで動かす&lt;/a&gt; を参考に作るとよい。&lt;/p&gt;
&lt;h2 id="どうやって詳しくなっていけばよいか"&gt;どうやって詳しくなっていけばよいか&lt;/h2&gt;
&lt;p&gt;fluent-bitは &lt;code&gt;input&lt;/code&gt; &lt;code&gt;parser&lt;/code&gt; &lt;code&gt;filter&lt;/code&gt; &lt;code&gt;routing&lt;/code&gt; 部分を弄ることになる。&lt;/p&gt;
&lt;p&gt;それぞれ次のドキュメントに細かく書いてある。
&lt;a href="https://docs.fluentbit.io/manual/pipeline/pipeline-monitoring"&gt;https://docs.fluentbit.io/manual/pipeline/pipeline-monitoring&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;input値挟まざまな値を取ることができる。&lt;/p&gt;
&lt;p&gt;&lt;a href="https://docs.fluentbit.io/manual/pipeline/inputs/dummy"&gt;https://docs.fluentbit.io/manual/pipeline/inputs/dummy&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;input値を変えてみたり、filterやoutput（routing）を変えながらどのように風に変化するか弄ってみるとよい。&lt;/p&gt;</description></item><item><title>fluent-bitをDockerで動かす</title><link>https://www.takeokunn.org/posts/fleeting/20221207173426-run_fluent_bit_docker/</link><pubDate>Wed, 07 Dec 2022 09:00:00 +0900</pubDate><guid>https://www.takeokunn.org/posts/fleeting/20221207173426-run_fluent_bit_docker/</guid><description>&lt;h2 id="プロジェクト構成"&gt;プロジェクト構成&lt;/h2&gt;
&lt;p&gt;次のように適当なディレクトリを作成する。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ tree .
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;.
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;├── Dockerfile
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;├── application.conf
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;└── docker-compose.yml
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ae81ff"&gt;0&lt;/span&gt; directories, &lt;span style="color:#ae81ff"&gt;3&lt;/span&gt; files
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;Dockerfile&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-dockerfile" data-lang="dockerfile"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;FROM&lt;/span&gt; &lt;span style="color:#e6db74"&gt;public.ecr.aws/aws-observability/aws-for-fluent-bit:2.21.3&lt;/span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#960050;background-color:#1e0010"&gt;&lt;/span&gt;&lt;span style="color:#66d9ef"&gt;COPY&lt;/span&gt; application.conf /fluent-bit/etc/application.conf&lt;span style="color:#960050;background-color:#1e0010"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;docker-compose.yml&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;version&lt;/span&gt;: &lt;span style="color:#e6db74"&gt;&amp;#34;3.8&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f92672"&gt;services&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;fluentbit&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;build&lt;/span&gt;: &lt;span style="color:#ae81ff"&gt;.&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;command&lt;/span&gt;: [&lt;span style="color:#e6db74"&gt;&amp;#34;/fluent-bit/bin/fluent-bit&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;-c&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;/fluent-bit/etc/application.conf&amp;#34;&lt;/span&gt;]
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#f92672"&gt;volumes&lt;/span&gt;:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - &lt;span style="color:#ae81ff"&gt;./application.conf:/fluent-bit/etc/application.conf&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;application.conf&lt;/code&gt;:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-cfg" data-lang="cfg"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;[SERVICE]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;Flush 5&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;Log_Level info&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;[INPUT]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;Name dummy&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;Tag *-firelens-*&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;Dummy {&amp;#34;date&amp;#34;:&amp;#34;2022-01-23T03:10:33.317817Z&amp;#34;,&amp;#34;source&amp;#34;:&amp;#34;stdout&amp;#34;,&amp;#34;log&amp;#34;:&amp;#34;time:2022-01-23T03:10:33+00:00\tprotocol:HTTP/1.1\tstatus:200\tsize:1450\treqsize:150\treferer:-\tvhost:10.10.18.102\treqtime:0.176\tcache:-\truntime:-\t&amp;#34;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#66d9ef"&gt;[OUTPUT]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;Name stdout&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#a6e22e"&gt;Match *&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="実行方法"&gt;実行方法&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;docker compose up&lt;/code&gt; を立ち上げると上記の &lt;code&gt;[INPUT]&lt;/code&gt; に記述したdummyのinputが出力される。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-shell" data-lang="shell"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ docker compose up
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;fluent-bit-sandbox-fluentbit-1 | &lt;span style="color:#f92672"&gt;[&lt;/span&gt;0&lt;span style="color:#f92672"&gt;]&lt;/span&gt; *-firelens-*: &lt;span style="color:#f92672"&gt;[&lt;/span&gt;1668664184.902488203, &lt;span style="color:#f92672"&gt;{&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;date&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;2022-01-23T03:10:33.317817Z&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;source&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;log&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;time:2022-01-23T03:10:33+00:00 protocol:HTTP/1.1 status:200 size:1450 reqsize:150 referer:- vhost:10.10.18.102 reqtime:0.176 cache:- runtime:- &amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;}]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;fluent-bit-sandbox-fluentbit-1 | &lt;span style="color:#f92672"&gt;[&lt;/span&gt;1&lt;span style="color:#f92672"&gt;]&lt;/span&gt; *-firelens-*: &lt;span style="color:#f92672"&gt;[&lt;/span&gt;1668664185.900364801, &lt;span style="color:#f92672"&gt;{&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;date&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;2022-01-23T03:10:33.317817Z&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;source&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;log&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;time:2022-01-23T03:10:33+00:00 protocol:HTTP/1.1 status:200 size:1450 reqsize:150 referer:- vhost:10.10.18.102 reqtime:0.176 cache:- runtime:- &amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;}]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;fluent-bit-sandbox-fluentbit-1 | &lt;span style="color:#f92672"&gt;[&lt;/span&gt;2&lt;span style="color:#f92672"&gt;]&lt;/span&gt; *-firelens-*: &lt;span style="color:#f92672"&gt;[&lt;/span&gt;1668664186.900453923, &lt;span style="color:#f92672"&gt;{&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;date&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;2022-01-23T03:10:33.317817Z&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;source&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;log&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;time:2022-01-23T03:10:33+00:00 protocol:HTTP/1.1 status:200 size:1450 reqsize:150 referer:- vhost:10.10.18.102 reqtime:0.176 cache:- runtime:- &amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;}]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;fluent-bit-sandbox-fluentbit-1 | &lt;span style="color:#f92672"&gt;[&lt;/span&gt;3&lt;span style="color:#f92672"&gt;]&lt;/span&gt; *-firelens-*: &lt;span style="color:#f92672"&gt;[&lt;/span&gt;1668664187.900391678, &lt;span style="color:#f92672"&gt;{&lt;/span&gt;&lt;span style="color:#e6db74"&gt;&amp;#34;date&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;2022-01-23T03:10:33.317817Z&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;source&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;stdout&amp;#34;&lt;/span&gt;, &lt;span style="color:#e6db74"&gt;&amp;#34;log&amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;=&lt;/span&gt;&amp;gt;&lt;span style="color:#e6db74"&gt;&amp;#34;time:2022-01-23T03:10:33+00:00 protocol:HTTP/1.1 status:200 size:1450 reqsize:150 referer:- vhost:10.10.18.102 reqtime:0.176 cache:- runtime:- &amp;#34;&lt;/span&gt;&lt;span style="color:#f92672"&gt;}]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="解説"&gt;解説&lt;/h2&gt;
&lt;p&gt;特に何も指定せずに &lt;code&gt;docker compose up&lt;/code&gt; をすると &lt;code&gt;/fluent-bit/bin/fluent-bit -c /fluent-bit/etc/fluent-bit.conf&lt;/code&gt; で起動をしている。&lt;/p&gt;</description></item></channel></rss>