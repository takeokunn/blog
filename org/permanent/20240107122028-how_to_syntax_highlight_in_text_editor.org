:PROPERTIES:
:ID:       3249F27E-9CE1-4ADC-9B34-607C7DCEC60D
:END:
#+TITLE: テキストエディタがPHPをシンタックスハイライトする仕組みとモダンテキストエディタ事情について
#+AUTHOR: takeokunn
#+DESCRIPTION: description
#+DATE: 2024-01-07T12:20:39+0900
#+HUGO_BASE_DIR: ../../
#+HUGO_CATEGORIES: permanent
#+HUGO_SECTION: posts/permanent
#+HUGO_TAGS: fleeting
#+HUGO_DRAFT: true
#+STARTUP: content
#+STARTUP: nohideblocks
* 注意

この記事はPHPerKaigi 2024のパンフレット記事です。
書面での掲載につきハイパーリンクがないことをご了承ください。

https://fortee.jp/phperkaigi-2024/proposal/161b2ec9-c279-4336-8e17-1aa054dacae9

* Introduction

- ソフトウェアは日進月歩で進化し続けている
- プログラミング言語の進化に追従するようにテキストエディタも進化している
  - php8.0以降に追加されたmatch式やenum構文なども問題なくハイライトしてくれている
- OSSだろうと商用だろうと誰かが対応してくれているので成り立っている
- そもそもテキストエディタはどのように構文を解釈してハイライトしてくれているのか、tree-sitterなどの最近のテキストエディタ事情も踏まえて解説する
- 筆者は熱狂的なEmacsユーザでありPHP Pluginであるphp-modeのメンテナでもあるので、Emacs贔屓な解説になってしまうのはご了承いただきたい

* シンタックスハイライトとは

- シンタックスハイライトとは
  - 構文に色をつけてくれるもの
    - 変数やnewのようなキーワード、functionやclassなど
  - Wikipediaによるとシンタックスカラーリング・構文着色とも言うらしい
- メリット
  - テキストの可読性を向上させ文脈をより明瞭にする
  - 記述ミスや括弧の対応のミスなどを防ぐことができる
- デメリット
  - 流し読みがしやすくなるので、プログラマはコード全体を理解しようとはしなくなる(by wikipedia)
- カラーテーマごとに配色が違う
  - 世の中には無数のカラーテーマがある
  - 筆者はDraculaやSublime Textのdefault themeのmonokaiが好き
- 言語の数だけシンタックスハイライトがある
  - 言語ごとに構文が違う
  - 似ている言語は上書きするように記述している
    - PHPはC言語に似ている
    - 昔php-modeはjava-modeを継承して実装していた

* シンタックスハイライトの大まかな仕組み

- テキストエディタによって実装が違う
- 凡そ2つに大別できる
  - 正規表現ベース
  - ASTベース
- 正規表現ベースは古いテキストエディタでよく使われている
  - EmacsやVimはそう
  - それぞれのテキストエディタごとに実装されている
- ASTベースは比較的新しいテキストエディタで実装されている
  - 今は亡きAtomが発祥
  - VSCodeがそう
  - NeoVimやEmacsは最近本体に組込まれた
- ASTベースのツールはほぼTree-Sitterが一強
  - Rust製で非常に高速で挙動する
  - テキストエディタに依存しない形で実装されている
- 難しいところ
  - 常にユーザが入力し続けるので構文が確定しない
  - 1入力ごとにハイライトする必要がある
    - 高速で動かす必要がある
  - 1言語で複数言語を

* 正規表現によるシンタックスハイライト

- キーワードは直接色を付ける
- 正規表現によって構文を定義する
  - =$= の後は確実に変数
  - =function= の後は確実に関数名になり、その後の括弧は関数の引数になる
  - =//= 直後は全てコメントになる
- メリット
  - 低メモリで高速で動く
    - 1990年代のPCでも動く
  - 構文を確定しなくてもハイライトすることができる
- デメリット
  - 正規表現の難易度が高い
  - 正規表現エンジンの実装依存になる
    - Emacsの場合は正規表現の先読みが使えない
    - しょうがないからカーソルを擬似的に動かすことによって先読みを実現している
  - 各テキストエディタごとに実装する必要がある
    - PHPのような比較的シンプルな構文の言語はまだ良い
    - C++のような複雑怪奇な構文をハイライトするには正規表現では厳しい
      - EmacsのCっぽい構文をハイライトするcc-modeは明かに天才が作ったが凡人の我々には到底理解できない実装になっている
    - 世の中にプログラミング言語は増えているのにEmacsのようなユーザ数が減っているエディタは全ての言語に対応するのは厳しい
      - PHPに関しては私やtadsanが対応しているので我々の目が黒いうちは対応していくつもり

* ASTベースによるシンタックスハイライト

- Tree-Sitterが一強なのでTree-Sitterを元に書く
- Tree-SitterはRust/Cで書かれていて特定のエディタに依存しない実装になっている
- それぞれの言語ごとにgrammarが提供されている
  - phpの場合はtree-sitter-php
- 各エディタはTree-SitterのC部分のwrapperを作りエディタ内で使えるようにしている
- キーワードは直接色を付ける
- 構文はJavaScriptベースの独自DSLで記述している
  - yaccのような記述
  - https://github.com/tree-sitter/tree-sitter-php/blob/master/common/define-grammar.js
- 構文エラーの場合の処理がはっきりしてる
  - 構文の優先準備を記述できる
  - エラーになった箇所のみエラーという判定になる
- メリット
  - メジャーな言語は大体サポートされている
  - エディタごとの実装をする必要ないのでメンテされる可能性が高い
- デメリット
  - 構文が確定するまで色がつかない
  - 毎回ASTを作る必要があるので正規表現と比べて低速
    - とはいえTree-Sitterは高速で動くし、2024年の標準的なコンピュータでは気にならない程度
  - テキストエディタ本体はTree-Sitterのサポートをし続けないといけない
    - 普通のユーザが触れない部分なので何かあった時に対応し辛い
