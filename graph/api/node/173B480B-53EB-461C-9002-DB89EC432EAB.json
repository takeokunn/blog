{
  "id": "173B480B-53EB-461C-9002-DB89EC432EAB",
  "title": "Nixでdap-modeがエラーになった時のメモ",
  "raw": ":PROPERTIES:\n:ID:       173B480B-53EB-461C-9002-DB89EC432EAB\n:END:\n#+TITLE: Nixでdap-modeがエラーになった時のメモ\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-02-03T13:15:02+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\n2025/02/02（Sun）に =nix flake update= で最新にしてBuildしたらエラーで落ちるようになったのでメモ。\n\n* 現象\n\n1. 2025/01/31に [[https://github.com/emacs-lsp/dap-mode/commit/438679755e880f2a662a63bc04da9e843257e248][dapui.elがdap-ui.elにrename]] される\n2. [[https://melpa.org/#/dap-mode][dap-mode 20250131.1624]] に反映される\n3. 2025/02/02の [[https://github.com/NixOS/nixpkgs/blob/master/pkgs/applications/editors/emacs/elisp-packages/melpa-packages.nix#L984-L991][nix flake update nixpkgsのdap-modeのpreBuild]] でdapui.elがなくて落ちるようになった\n\n* 最小構成と解決策\n\n次のように =preBuild= をoverlaysに追加すればBuildできるようになった。\n\n#+begin_src nix\n  {\n    inputs = {\n      nixpkgs.url = \"github:NixOS/nixpkgs/nixpkgs-unstable\";\n      emacs-overlay.url = \"github:nix-community/emacs-overlay\";\n    };\n\n    outputs = { self, nixpkgs, emacs-overlay, ... }:\n      let\n        system = \"aarch64-darwin\";\n        pkgs = import nixpkgs {\n          inherit system;\n          overlays = [\n            # ここを追加\n            (self: super: {\n              emacsPackages = super.emacsPackages // {\n                dap-mode = super.emacsPackages.dap-mode.overrideAttrs (old: {\n                  preBuild = null;\n                });\n              };\n            })\n            emacs-overlay.overlay\n          ];\n        };\n      in {\n        defaultPackage.${system} = pkgs.emacsPackages.dap-mode;\n      };\n  }\n#+end_src\n\nまた、 =emacs-overlay= 使う場合は =pkgs.emacsWithPackagesFromPackageRequires= にoverlayを追加すればBuildできるようになる。\nhttps://github.com/nix-community/Emacs-overlay/blob/a7f332f6e0813c9d0f53fe6539be1e7a65fff2e4/packreq.nix#L13\n\n#+begin_src nix\n  {\n    inputs = {\n      nixpkgs.url = \"github:NixOS/nixpkgs/nixpkgs-unstable\";\n      emacs-overlay.url = \"github:nix-community/emacs-overlay\";\n    };\n    outputs = { self, nixpkgs, emacs-overlay, ... }:\n      let\n        system = \"aarch64-darwin\";\n        pkgs = import nixpkgs {\n          inherit system;\n          overlays = [ emacs-overlay.overlay ];\n        };\n      in\n        {\n          defaultPackage.${system} = pkgs.emacsWithPackagesFromPackageRequires {\n            packageElisp = builtins.toFile \"empty.el\" \"\";\n            extraEmacsPackages = epkgs: with epkgs; [ dap-mode ];\n            override = final: prev: {\n              dap-mode = prev.melpaPackages.dap-mode.overrideAttrs (old: {\n                preBuild = null;\n              });\n            };\n          };\n        };\n  }\n#+end_src\n\n自分のhome-managerには次のように追記した。\n\nhttps://github.com/takeokunn/nixos-configuration/commit/16c55223327058cd184aa189b2b324dd1f823463\n\n* 終わりに\n\n調査に協力してくれたnatsukiumに感謝。\n",
  "backlinks": []
}