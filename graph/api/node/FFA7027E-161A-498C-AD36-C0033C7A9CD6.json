{
  "id": "FFA7027E-161A-498C-AD36-C0033C7A9CD6",
  "title": "private-terraformをHCP Terraformに移行した",
  "raw": ":PROPERTIES:\n:ID:       FFA7027E-161A-498C-AD36-C0033C7A9CD6\n:END:\n#+TITLE: private-terraformをHCP Terraformに移行した\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-05-07T23:00:55+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting terraform\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\n個人用のTerraformプロジェクトを用意して、GitHubとCloudflareとNextDNSの管理をしている。\n\n- [[id:A942A0CA-829F-45C0-A9CC-F7CA8C0DE873][Terraform GitHub Providerを導入した]]\n- [[id:861C8003-2791-4BF3-8126-489838D804F9][お名前comからCloudflareにドメイン移管してTerraformで管理する]]\n- [[id:4E845C70-F095-47B3-BF75-F6872164BD43][NextDNSを導入した]]\n\ntfstateのファイルをLocalマシンで雑に管理をしていたのだが、PCの引越し作業が発生したので管理方法を検討する必要があったので対応したことを纏めておく。\n\n* 試したこと・やったこと\n** 1. tfstate管理方法を検討\n\n- MUST\n  - 料金が無料\n  - セキュリティリスクが低い\n  - 安全なterraform実行環境の保証\n- SHOULD\n  - バージョン管理\n  - 実行結果の可視性\n- OPTIONAL\n  - CI統合\n\nHCP Terraform（旧terraform cloud）はHashiCorp謹製のCloudサービス。\nhttps://www.hashicorp.com/ja/cloud\n\n500 resourcesまでは無料なので個人利用なら無料で完結する。\nhttps://www.hashicorp.com/en/pricing\n\n候補としてはさくらインターネットやCloudflareのストレージに上げることも検討していたが、そもそも各サービスを利用しなくなることも考えられるので却下した。\n\n** 2. HCP Terraform自体のTerraformを書く\n\n以下を参考にterraformを書いた。\nhttps://registry.terraform.io/providers/hashicorp/tfe/latest/docs\n\n=TF_API_TOKEN= は管理画面から手ぽちで入力している。\n\n#+begin_src terraform\n  terraform {\n    required_version = \"1.11.4\"\n\n    cloud {\n      organization = \"takeokunn-private\"\n      workspaces {\n        name = \"tfe\"\n      }\n    }\n\n    required_providers {\n      tfe = {\n        source  = \"hashicorp/tfe\"\n        version = \"0.65.2\"\n      }\n    }\n  }\n\n  variable \"TF_API_TOKEN\" {\n    type = string\n  }\n\n  provider \"tfe\" {\n    token = var.TF_API_TOKEN\n  }\n\n  resource \"tfe_organization\" \"private\" {\n    name                     = \"takeokunn-private\"\n    email                    = \"bararararatty@gmail.com\"\n    collaborator_auth_policy = \"two_factor_mandatory\"\n  }\n\n  resource \"tfe_project\" \"default\" {\n    organization = tfe_organization.private.name\n    name         = \"private\"\n  }\n\n  resource \"tfe_workspace\" \"tfe\" {\n    name         = \"tfe\"\n    organization = tfe_organization.private.name\n    project_id   = tfe_project.default.id\n  }\n\n  resource \"tfe_workspace\" \"nextdns\" {\n    name         = \"nextdns\"\n    organization = tfe_organization.private.name\n    project_id   = tfe_project.default.id\n  }\n\n  resource \"tfe_workspace\" \"cloudflare\" {\n    name         = \"cloudflare\"\n    organization = tfe_organization.private.name\n    project_id   = tfe_project.default.id\n  }\n\n  resource \"tfe_workspace\" \"github\" {\n    name         = \"github\"\n    organization = tfe_organization.private.name\n    project_id   = tfe_project.default.id\n  }\n#+end_src\n** 3. ディレクトリ構成変更\n\n元々はentrypoint1つですべてを流せるようにしていたが、次のようにサービスごとに分け、 =cd= で移動してからterraformを実行する運用に変更した。\nこの対応によって他サービスの変更に依存せずにversionを上げられるようになった。\n\n#+begin_src console\n  $ nix run nixpkgs#tree .\n  .\n  ├── projects\n  │   ├── cloudflare\n  │   │   └── main.tf\n  │   ├── github\n  │   │   ├── archive_repo.tf\n  │   │   ├── main.tf\n  │   │   ├── private_repo.tf\n  │   │   ├── public_repo.tf\n  │   │   └── user_settings.tf\n  │   ├── nextdns\n  │   │   └── main.tf\n  │   └── tfe\n  │       └── main.tf\n  └── README.org\n#+end_src\n** 4. 既存リソースの移行\n\n=terraform import= を気合で入力して既存リソースの移行作業をした。\n\nディレクトリ構成変更が功を奏して小さく移行できた。\n\n* 得られた結果・所感\n\nterraformの安全な実行環境を手に入れたので非常に満足している。\n特に難易度の高い所はなかったのですんなり導入できた。\n\n* 今後の展開・検討事項\n\n現状管理画面に手ぽちで直接秘密鍵を入れているので、sops経由で登録できるようにしたい。\n",
  "backlinks": [
    {
      "title": "Typstで履歴書と職務経歴書をBuildする",
      "source": "22C11682-3405-48C4-A720-5FF3080480DD"
    }
  ]
}