{
  "id": "7622D819-68E9-4265-83D5-40E1AC66F930",
  "title": "fluent-bitをDockerで動かす",
  "raw": ":PROPERTIES:\n:ID:       7622D819-68E9-4265-83D5-40E1AC66F930\n:mtime:    20231204002859\n:ctime:    20221214165044\n:END:\n#+TITLE: fluent-bitをDockerで動かす\n#+AUTHOR: takeokunn\n#+DESCRIPTION: fluent-bitをDockerで動かす方法のメモ\n#+DATE: 2022-12-07T09:00:00+09:00\n#+HUGO_BASE_DIR: ../../\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_TAGS: fluent-bit docker\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* プロジェクト構成\n\n次のように適当なディレクトリを作成する。\n\n#+begin_src shell\n  $ tree .\n  .\n  ├── Dockerfile\n  ├── application.conf\n  └── docker-compose.yml\n\n  0 directories, 3 files\n#+end_src\n\n~Dockerfile~:\n\n#+begin_src dockerfile\n  FROM public.ecr.aws/aws-observability/aws-for-fluent-bit:2.21.3\n\n  COPY application.conf /fluent-bit/etc/application.conf\n#+end_src\n\n~docker-compose.yml~:\n\n#+begin_src yaml\n  version: \"3.8\"\n  services:\n    fluentbit:\n      build: .\n      command: [\"/fluent-bit/bin/fluent-bit\", \"-c\", \"/fluent-bit/etc/application.conf\"]\n      volumes:\n        - ./application.conf:/fluent-bit/etc/application.conf\n#+end_src\n\n~application.conf~:\n\n#+begin_src conf\n  [SERVICE]\n      Flush 5\n      Log_Level info\n\n  [INPUT]\n      Name dummy\n      Tag  *-firelens-*\n      Dummy {\"date\":\"2022-01-23T03:10:33.317817Z\",\"source\":\"stdout\",\"log\":\"time:2022-01-23T03:10:33+00:00\\tprotocol:HTTP/1.1\\tstatus:200\\tsize:1450\\treqsize:150\\treferer:-\\tvhost:10.10.18.102\\treqtime:0.176\\tcache:-\\truntime:-\\t\"}\n\n  [OUTPUT]\n      Name stdout\n      Match *\n#+end_src\n* 実行方法\n\n~docker compose up~ を立ち上げると上記の ~[INPUT]~ に記述したdummyのinputが出力される。\n\n#+begin_src shell\n  $ docker compose up\n\n  fluent-bit-sandbox-fluentbit-1  | [0] *-firelens-*: [1668664184.902488203, {\"date\"=>\"2022-01-23T03:10:33.317817Z\", \"source\"=>\"stdout\", \"log\"=>\"time:2022-01-23T03:10:33+00:00   protocol:HTTP/1.1       status:200      size:1450       reqsize:150     referer:-     vhost:10.10.18.102      reqtime:0.176   cache:- runtime:-       \"}]\n  fluent-bit-sandbox-fluentbit-1  | [1] *-firelens-*: [1668664185.900364801, {\"date\"=>\"2022-01-23T03:10:33.317817Z\", \"source\"=>\"stdout\", \"log\"=>\"time:2022-01-23T03:10:33+00:00   protocol:HTTP/1.1       status:200      size:1450       reqsize:150     referer:-     vhost:10.10.18.102      reqtime:0.176   cache:- runtime:-       \"}]\n  fluent-bit-sandbox-fluentbit-1  | [2] *-firelens-*: [1668664186.900453923, {\"date\"=>\"2022-01-23T03:10:33.317817Z\", \"source\"=>\"stdout\", \"log\"=>\"time:2022-01-23T03:10:33+00:00   protocol:HTTP/1.1       status:200      size:1450       reqsize:150     referer:-     vhost:10.10.18.102      reqtime:0.176   cache:- runtime:-       \"}]\n  fluent-bit-sandbox-fluentbit-1  | [3] *-firelens-*: [1668664187.900391678, {\"date\"=>\"2022-01-23T03:10:33.317817Z\", \"source\"=>\"stdout\", \"log\"=>\"time:2022-01-23T03:10:33+00:00   protocol:HTTP/1.1       status:200      size:1450       reqsize:150     referer:-     vhost:10.10.18.102      reqtime:0.176   cache:- runtime:-       \"}]\n#+end_src\n\n* 解説\n\n特に何も指定せずに ~docker compose up~ をすると ~/fluent-bit/bin/fluent-bit -c /fluent-bit/etc/fluent-bit.conf~ で起動をしている。\n\n#+begin_src shell\n  $ docker compose exec fluentbit /bin/bash\n  bash-4.2# ps aux | grep fluent-bit\n  root         1  0.2  0.5 2442384 46640 ?       Ssl  05:50   0:00 /fluent-bit/bin/fluent-bit -e /fluent-bit/firehose.so -e /fluent-bit/cloudwatch.so -e /fluent-bit/kinesis.so -c /fluent-bit/etc/fluent-bit.conf\n  root        41  0.0  0.0   8996   932 pts/1    S+   05:51   0:00 grep fluent-bit\n#+end_src\n\nデフォルトのconfigである ~/fluent-bit/etc/fluent-bit.conf~ はserverが立っており、tcpでやりとりができるようになっている。\n\n#+begin_src shell\n  $ docker compose exec fluentbit /bin/bash\n  bash-4.2# cat /fluent-bit/etc/fluent-bit.conf\n  [INPUT]\n      Name        forward\n      Listen      0.0.0.0\n      Port        24224\n\n  [OUTPUT]\n      Name cloudwatch\n      Match   **\n      region us-east-1\n      log_group_name fluent-bit-cloudwatch\n      log_stream_prefix from-fluent-bit-\n      auto_create_group true\n#+end_src\n",
  "backlinks": [
    {
      "title": "fluent-bitに入門する",
      "source": "E4B1AA1E-52C0-4A8F-91F3-F4119ACE2BC6"
    }
  ]
}