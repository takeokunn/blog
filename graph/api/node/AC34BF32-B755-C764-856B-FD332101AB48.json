{
  "id": "AC34BF32-B755-C764-856B-FD332101AB48",
  "title": "個人的devenv運用",
  "raw": ":PROPERTIES:\n:ID:       AC34BF32-B755-C764-856B-FD332101AB48\n:END:\n#+TITLE: 個人的devenv運用\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-01-27T23:30:00+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\ndevenvをヘビーユーズしているので、個人的なdevenv運用についてやTipsについてまとめる。\n\n* devenvとは\n\ndevenvはcachix社が作っているflake.nixラッパ。\nhttps://devenv.sh/\n\nflake.nixよりも圧倒的に高級に書ける割に柔軟性がかなり高いのでプロジェクトに必要なツールを入れる場合に便利。\n\n類似ールにdevboxがありますが、devboxはjsonでのみ記述できるので個人的にはNixで書けるdevenvの方が好み。\n\n* devevnの個人的な期待役割\n\n自分のローカル環境でNixが担っている役割は以下。\n自分の手元にはNixOSとMacとAndroidのマシンがありますが、環境ごとの役割の差異は特にないです。\n\n1. システム設定\n  - e.g. network, font, daemon\n2. システムグローバルのパッケージ管理\n  - e.g. fish, Git, Emacs\n3. プロジェクト固有のパッケージ管理+α\n  - e.g. php, language-server, pre-commit\n4. プロジェクト固有のビルドツール\n\n=1. システム設定= と =2. システムグローバルのパッケージ管理= は [[https://github.com/takeokunn/nixos-configuration][takeokunn/nixos-configuration]] が担っている。\n=4. ビルドツール= は [[id:0D13FCEA-F8EC-4729-B700-9A88FD1D5EB9][NixでTypstをBuildしGitHub Pagesでホスティングする]] のように =flake.nix= を定義して使っている。\n\n=3. プロジェクト固有のパッケージ管理+α= をdevenvが担っており、 =2. システムグローバルのパッケージ管理= は必要最小限に抑えているので都度インストールする必要がある。\n\n自分は普通の人よりも幅広い言語やフレームワークのリポジトリを扱うので、逐次必要なツールを明示的に入れている。\n自分の為に用意しているので、プロジェクトには =git push= せず、自分用プライベートリポジトリで管理している。\n\nまた Emacsからもよい感じにpackageを実行できるようにする必要があるので工夫が必要。\n\n* 実運用\n** Laravelプロジェク用devenvのサンプルコード\n\n実際に会社のLaravelプロジェクトで使っているコードは以下。\n\n- language serverやawscliなどプロジェクで必要なものは都度入れている\n- 言語のバージョンを大まかに定義する\n  - phpなら =8.2= という定義をして、 =8.2.x= レベルの細かい指定まではしない\n- php.iniはdevenv内で定義する\n- pre-commitをストレスのない範囲で可能な限り設定する\n  - ref. https://devenv.sh/reference/options/#pre-commit\n\n#+begin_src nix\n  { pkgs, config, inputs, ... }: {\n    cachix.enable = false;\n\n    dotenv.disableHint = true;\n\n    env.COMPOSER_MEMORY_LIMIT = \"4G\";\n\n    packages = with pkgs; [ gh hub nodePackages_latest.intelephense ssm-session-manager-plugin tbls rain mariadb awscli ];\n\n    languages.javascript = {\n      enable = true;\n      package = pkgs.nodejs_20;\n      yarn.enable = true;\n    };\n\n    languages.php = {\n      enable = true;\n      package = pkgs.php82.buildEnv {\n        extensions = { all, enabled }: with all; enabled ++ [ xdebug ];\n        extraConfig = ''\n          memory_limit=-1\n        '';\n      };\n    };\n\n    pre-commit.hooks = {\n      actionlint.enable = true;\n      editorconfig-checker.enable = true;\n      check-json.enable = true;\n      check-merge-conflicts.enable = true;\n      check-yaml.enable = true;\n      check-case-conflicts.enable = true;\n    };\n  }\n#+end_src\n\n** org-tangleして各プロジェクトに配置\n\n[[https://github.com/emacs-mirror/emacs][emacs-mirror/emacs]] の場合は次のようなOrgファイルを定義して =org-babel-tangle= する。\n=devenv.lock= は管理運用方法は現状思いついてないので諦めている。\n\n#+begin_src org\n  ,*** emacs\n  ,**** .git/info/exclude\n  ,#+begin_src fundamental :mkdirp yes :noweb yes :tangle (if (file-directory-p \"~/.ghq/github.com/emacs-mirror/emacs/\") (expand-file-name \"~/.ghq/github.com/emacs-mirror/emacs/.git/info/exclude\") \"no\")\n    .envrc\n    devenv.nix\n    devenv.lock\n    .devenv.flake.nix\n    .devenv/\n    .direnv/\n  ,#+end_src\n  ,**** .envrc\n  ,#+begin_src dotenv :noweb yes :tangle (if (file-directory-p \"~/.ghq/github.com/emacs-mirror/emacs\") (expand-file-name \"~/.ghq/github.com/emacs-mirror/emacs/.envrc\") \"no\")\n    source_url \"https://raw.githubusercontent.com/cachix/devenv/95f329d49a8a5289d31e0982652f7058a189bfca/direnvrc\" \"sha256-d+8cBpDfDBj41inrADaJt+bDWhOktwslgoP5YiGJ1v0=\"\n    use devenv\n  ,#+end_src\n  ,**** devenv.nix\n  ,#+begin_src nix :noweb yes :tangle (if (file-directory-p \"~/.ghq/github.com/emacs-mirror/emacs\") (expand-file-name \"~/.ghq/github.com/emacs-mirror/emacs/devenv.nix\") \"no\")\n    { pkgs, config, inputs, ... }:\n    {\n      cachix.enable = false;\n\n      dotenv.disableHint = true;\n\n      packages = with pkgs; [\n        autoconf\n        texinfo\n        gnutls\n        libgccjit\n        zlib\n        libxml2\n        ncurses\n      ];\n    }\n  ,#+end_src\n\n#+end_src\n** direnvで起動\n\nproject rootに発行したらdevenv shellに入るようにdirenvを設定している。\nhttps://devenv.sh/automatic-shell-activation/\n\n** .dir-locals2.elでPATHを通す\n\n次のような =.dir-locals2.el= を =org-babel-tangle= で出力してEmacsにパスを通している。\n\n#+begin_src emacs-lisp\n  ((nil . ((eval . (add-to-list 'exec-path \"~/ghq/github.com/org-name/project-name/.devenv/profile/bin/\"))))\n   (php-mode . ((eval lsp))))\n#+end_src\n* 所感\ndevenvめちゃくちゃよい。\nServicesやTestsなどの機能も試していきたい。\n",
  "backlinks": [
    {
      "title": "巨大なLaravelレポジトリでphpactorを使うTips",
      "source": "B223A868-6C69-4642-ACE7-A0E49CE572CC"
    }
  ]
}