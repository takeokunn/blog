{
  "id": "0D13FCEA-F8EC-4729-B700-9A88FD1D5EB9",
  "title": "NixでTypstをBuildしGitHub Pagesでホスティングする",
  "raw": ":PROPERTIES:\n:ID:       0D13FCEA-F8EC-4729-B700-9A88FD1D5EB9\n:END:\n#+TITLE: NixでTypstをBuildしGitHub Pagesでホスティングする\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-01-26T11:42:26+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nix typst org-mode\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景\n\nスライドや組版記事を生成する為にTypstを採用することにした。\n工数を最小限に安定的に量産できるようなしくみを整える必要が迫られていたので、今回対応したことをメモしておく。\n\nソースコードは[[https://github.com/takeokunn/blog/tree/11609d8503ffd9b9eb8a3e2a5d19f3f51ee5b579/typst][takeokunn/blogのtypstディレクトリ下]]に置いている。\n\n* 条件\n\n- MUST\n  - Localに一切依存しない再現性の高いBuild環境構築\n  - org-modeで記述できる\n  - Typstのエコシステムを使う\n  - スライド生成と組版記事両方に対応する\n- SHOULD\n  - takeokunn.orgから配信できる\n  - リリースまでのリードタイムが短い\n  - org-roamなど周辺のエコシステムとの親和性を高める\n\n* 方針\n\n次の3ステップで実現した。\n\n- org-modeで記述したファイルをTypstに変換\n- NixでTypstをBuildできるようにする\n- GitHub ActionsでBuildしてGitHub Pagesで配信できる\n\n[[file:../../static/images/D91F417B-0FFC-4C67-A814-A267565ADE63.png]]\n\n#+begin_src mermaid :exports none\n  graph TD\n      A[human] -->|git push| B[org-mode]\n      subgraph GitHub Actions\n          direction TB\n          B -->|ox-typst| C[typ file]\n          C -->|nix build| D[PDF]\n      end\n      D -->|Deploy| Ep[GitHub Pages]\n#+end_src\n* 作業ステップ\n** 0. どこに置くか検討\n\n以下を理由に [[https://github.com/takeokunn/blog][takeokunn/blog]] 上に構築することにした。\n\n- [[https://www.takeokunn.org/][takeokunn.org]] から配信できる\n- 既存のorg-roam上に相乗りできる\n- 新しいリポジトリを作ると関心ことが増える\n- すでにあるGitHub Actions上に構築することによって実装コストとメンテナンスコストを抑えられる\n- 今回の用途だと作業途中でもパブリックにして問題がない\n\n商業誌のような公開制限をかける必要のあるものは都度プライベートリポジトリを作って対応することにした。\n\n** 1. org-modeで記述したファイルをTypstに変換\n\n組版記事の場合、[[https://github.com/jmpunkt/ox-typst][jmpunkt/ox-typst]] を用いて通常とおりOrgファイルをTypstに変換する。(=M-x org-typst-export-to-typst= を実行)\n\n[[https://github.com/takeokunn/blog/blob/11609d8503ffd9b9eb8a3e2a5d19f3f51ee5b579/typst/phperkaigi-2025-pamphlet/article.org][PHPerKaigi2025のパンフ記事]]の場合、次のようにTypstの設定をExportしている。\n\n#+begin_src org\n  ,#+BEGIN_EXPORT typst\n  #set text(lang: \"ja\", font: \"Migu\", size: 8pt)\n\n  #set page(\n    width: 210mm,\n    height: 297mm,\n    margin: 20mm,\n    columns: 1\n  )\n\n  #import \"@preview/codly:1.2.0\": *\n  #import \"@preview/codly-languages:0.1.1\": *\n  #show: codly-init.with()\n  #codly(languages: codly-languages)\n\n  #align(center)[\n    #set text(size: 18pt)\n    Phpactorから学ぶLanguage Server Protocolの仕組み\n\n    #set text(size: 12pt)\n    たけてぃ \\@takeokunn\n  ]\n  ,#+END_EXPORT\n#+end_src\n\nスライドの場合、 Orgファイルには登壇メモをしつつ、 =#+BEGIN_EXPORT typst= のみ出力してほしかったので次のようなElispを書いた。\n\n#+begin_src emacs-lisp\n  (require 'ox-typst)\n\n  (setq org-export-with-toc nil)\n\n  (org-export-define-backend 'typst-slide\n    '((export-block . org-typst-export-block)\n      (headline . org-typst-headline)\n      (item . org-typst-item)\n      (keyword . org-typst-keyword)\n      (section . org-typst-section)\n      (src-block . org-typst-src-block))\n    :menu-entry\n    '(?y \"Export to Typst\"\n         ((?F \"As Typst buffer\" org-typst-export-as-typst)\n          (?f \"As Typst file\" org-typst-export-to-typst)\n          (?p \"As PDF file\" org-typst-export-to-pdf)))\n    :options-alist\n    '((:typst-format-drawer-function nil nil #'(lambda (_ contents) contents))\n      (:typst-format-inlinetask-function nil\n                                         nil\n                                         #'(lambda (_ contents) contents))))\n\n  (defun org-typst-slide-export-as-typst (&optional async subtreep visible-only body-only ext-plist)\n    (interactive)\n    (org-export-to-buffer 'typst-slide \"*Org Typst Slide Export*\"\n      async subtreep visible-only body-only ext-plist))\n\n  (defun org-typst-slide-export-to-typst (&optional async subtreep visible-only body-only ext-plist)\n    (interactive)\n    (let ((outfile (org-export-output-file-name \".typ\" subtreep)))\n      (org-export-to-file 'typst-slide outfile\n        async subtreep visible-only body-only ext-plist)))\n#+end_src\n\n** 2. NixでTypstをBuildできるようにする\n\n組版記事とスライドの場合で実行したいElisp関数が違うので、引数に =type= を渡すことで条件分岐をした。\nNix経由でインストールしたものを =TYPST_FONT_PATHS= =TYPST_PACKAGE_PATH= でPATHを通して =typst compile= を実行するDerivationを作った。\n\noutput抜粋:\n\n#+begin_src nix\n  buildTypstProject = { name, type }:\n    let\n      _ = assert builtins.elem; type [ \"article\" \"slide\" ];\n      emacsBuildPhase = name: if type == \"article\"\n                              then\n                                \"emacs --batch --load ox-typst.el --file ${name}/article.org --funcall org-typst-export-to-typst\"\n                              else\n                                \"emacs --batch --load ox-typst.el --file ${name}/article.org --funcall org-typst-slide-export-to-typst\";\n    in\n      pkgs.stdenv.mkDerivation {\n        inherit name;\n        src = ./.;\n        nativeBuildInputs = with pkgs; [\n          typst\n          migu\n          (emacs.pkgs.withPackages (epkgs: with epkgs; [ org ox-typst ]))\n        ];\n        buildPhase = ''\n          ${emacsBuildPhase name}\n          export TYPST_FONT_PATHS=\"${pkgs.migu}/share/fonts/truetype/migu\"\n          export TYPST_PACKAGE_PATH=\"${typstPackagesCache}/typst/packages\"\n          typst compile ${name}/article.typ\n        '';\n        installPhase = ''\n          mkdir -p $out\n          cp ${name}/article.pdf $out/${name}.pdf\n        '';\n      };\n#+end_src\n\n呼び出し方はシンプルで、次のように =packages.*= で定義するとBuildできるようになった。\n\n#+begin_src nix\n  packages = {\n    example-slide = buildTypstProject {\n      name = \"example-slide\";\n      type = \"slide\";\n    };\n    phperkaigi-2025-pamphlet = buildTypstProject {\n      name = \"phperkaigi-2025-pamphlet\";\n      type = \"article\";\n    };\n  };\n#+end_src\n\n=#import \"@preview/codly:1.2.0\": *= のようにインポート記述のみすると、Nix Sandbox環境だとうまくインストールできなかった。(参考: [[https://zenn.dev/omochice/articles/reproducible-compilation-of-typst-by-typix][Typixを使って複数環境でtypstでスライドをコンパイルする - Zenn]])\n\ninputsに [[https://github.com/typst/packages][typst-packages]] を定義してPATHを通すとうまくBuildできた。\nTypstのNixラッパである [[https://github.com/loqusion/typix][loqusion/typix]] のコードも読んだが、自分の用途だと自前で書けばよいという結論に至ったので採用しなかった。\n\ninputs抜粋:\n\n#+begin_src nix\n  inputs = {\n    typst-packages = {\n      url = \"github:typst/packages\";\n      flake = false;\n    };\n  };\n#+end_src\n** 3. GitHub ActionsでBuildしてGitHub Pagesで配信できる\n\nHugoのデプロイフローの最後に =nix build= して生成したPDFを =public/pdf/= にコピーする処理を追加した。\nhttps://github.com/takeokunn/blog/blob/main/.github/workflows/main.yml\n\n#+begin_src yaml\n  - name: Generate example-slide\n    run: |\n      nix build ./typst#example-slide\n      cp result/example-slide.pdf public/pdf/\n  - name: Generate phperkaigi-2025-pamphlet\n    run: |\n      nix build ./typst#phperkaigi-2025-pamphlet\n      cp result/phperkaigi-2025-pamphlet.pdf public/pdf/\n#+end_src\n\n生成されたPDFは以下。\n\n- https://www.takeokunn.org/pdf/phperkaigi-2025-pamphlet.pdf\n- https://www.takeokunn.org/pdf/example-slide.pdf\n\n* Next Step\n\n安定的にBuildできるようになったので、Typst自体の記述に慣れつつスライドや記事を量産していきたい。\nまた、現状[[https://itouhiro.github.io/mixfont-mplus-ipa/migu/][Miguフォント]]を使っているが個人的には納得していなく、テーブル表示にするとなぜかずれてしまう問題が発生している。\nnixpkgs内にある日本語フォント選定に時間を割きたい。\n\n* 雑感\n\n当初掲げていた条件をすべて満たせたので満足。\n[[https://zenn.dev/omochice/articles/reproducible-compilation-of-typst-by-typix][Typixを使って複数環境でtypstでスライドをコンパイルする - Zenn]] 記事に助けられたのでOmochiceに大感謝。\n",
  "backlinks": [
    {
      "title": "2025年2月名古屋旅行",
      "source": "8519D7FF-9185-4CA5-86D0-2B55710FD38E"
    },
    {
      "title": "AIを駆使してTypstスライドを生成する",
      "source": "A442DBE9-559A-4B75-AAF3-4A925F5BA5E4"
    },
    {
      "title": "個人的devenv運用",
      "source": "AC34BF32-B755-C764-856B-FD332101AB48"
    },
    {
      "title": "Typstテーマを自作した",
      "source": "C6F8F599-5F2A-4C8C-8148-0DF03644CE35"
    },
    {
      "title": "Typst自作テーマで登壇スライドを作成した",
      "source": "9A373386-769A-4152-BDED-20931CA588BC"
    },
    {
      "title": "技術イベントのパンフレット記事をTypstでBuildする",
      "source": "4D6415D6-B7ED-4C3C-BBDB-CA0931DC4E20"
    },
    {
      "title": "技術イベントのパンフレット記事をTypstでBuildする",
      "source": "4D6415D6-B7ED-4C3C-BBDB-CA0931DC4E20"
    },
    {
      "title": "技術イベントのパンフレット記事をTypstでBuildする",
      "source": "4D6415D6-B7ED-4C3C-BBDB-CA0931DC4E20"
    },
    {
      "title": "Typstとpdfpcでプレゼン機能を実現する",
      "source": "B046C3A9-62E8-4DD7-BC71-4DF4FFA34664"
    }
  ]
}