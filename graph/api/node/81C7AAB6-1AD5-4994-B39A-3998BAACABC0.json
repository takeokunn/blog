{
  "id": "81C7AAB6-1AD5-4994-B39A-3998BAACABC0",
  "title": "org-roam-ui-liteでblogの関係性を可視化する",
  "raw": ":PROPERTIES:\n:ID:       81C7AAB6-1AD5-4994-B39A-3998BAACABC0\n:END:\n#+TITLE: org-roam-ui-liteでblogの関係性を可視化する\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-05-10T23:58:43+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting org-mode\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\n[[id:E6243AE2-CFE4-4D21-B9B7-E076B13CF486][org-roamで記事を管理しGitHub Actionsで適切に公開する]] に書いたとおり [[https://www.takeokunn.org/][takeokunn.org]] は [[https://www.orgroam.com/][org-roam]] で管理している。\n\norg-roamの可視化ツールに [[https://github.com/org-roam/org-roam-ui][org-roam-ui]] があるが、次のような問題を抱えていた。\n\n- Next.jsでリッチに作られすぎてる\n  - NixでPackagingするのが大変\n- GitHub ActionsでBuildするのが大変\n- GitHub PagesでHostingするのが大変\n\nGitHub Pagesに継続的にHostingする仕組みを作りたいと考えて早n年経っていたが、taniさんが [[https://github.com/tani/org-roam-ui-lite][org-roam-ui-lite]] という軽量なorg-roam-uiを作ってくれたので今回導入してみた。\n\n* 試したこと・やったこと\n\n変更はここに纏まっている。\n\nhttps://github.com/takeokunn/blog/commit/5703949e2212fa0e5f23d23869d61ea2b74b8dad\n\n** 1. flake.nixでBuildできるようにする\n\n=scripts/org-roam-ui.el= を用意した。\n\n#+begin_src emacs-lisp\n  (require 'org-roam)\n\n  (setq org-roam-db-location \"./org-roam.db\")\n  (setq org-id-locations-file \"./.org-id-locations\")\n  (setq org-roam-directory default-directory)\n#+end_src\n\nflake.nixでorg-roam-ui-liteをimportして =stdenv.mkDerivation= でpackageを作成した。\n\n#+begin_src diff\n  diff --git a/hugo/flake.nix b/hugo/flake.nix\n  index c35c860..155c924 100644\n  --- a/hugo/flake.nix\n  +++ b/hugo/flake.nix\n  @@ -3,9 +3,10 @@\n       nixpkgs.url = \"github:NixOS/nixpkgs\";\n       nur-packages.url = \"github:takeokunn/nur-packages\";\n       flake-utils.url = \"github:numtide/flake-utils\";\n  +    org-roam-ui-lite.url = \"github:tani/org-roam-ui-lite\";\n     };\n\n  -  outputs = { self, nixpkgs, nur-packages, flake-utils }:\n  +  outputs = { self, nixpkgs, nur-packages, flake-utils, org-roam-ui-lite }:\n       flake-utils.lib.eachDefaultSystem (\n         system:\n         let\n  @@ -85,6 +86,22 @@\n                   cp -r ./public $out/\n                 '';\n               };\n  +            build-org-roam-ui-lite = pkgs.stdenv.mkDerivation {\n  +              name = \"build-org-roam-ui-lite\";\n  +              src = ./.;\n  +              nativeBuildInputs = with pkgs; [\n  +                org-roam-ui-lite.packages.${system}.export\n  +                (emacsPkg.pkgs.withPackages (epkgs: (with epkgs.melpaPackages; [ org-roam ])))\n  +              ];\n  +              buildPhase = ''\n  +                rm -fr org/private/\n  +                emacs --batch --load scripts/org-roam-ui.el --funcall org-roam-db-sync\n  +                org-roam-ui-lite-export -d org-roam.db -o ./public\n  +              '';\n  +              installPhase = ''\n  +                cp -r ./public $out/\n  +              '';\n  +            };\n             };\n           }\n       );\n#+end_src\n\n=nix build= でbuildできることを確認する。\n\n#+begin_src bash\n  $ nix build .#build-org-roam-ui-lite\n#+end_src\n** 2. GitHub Actionsに組み込む\n\nGitHub Actionsで =nix build= するだけ。\n\n#+begin_src yaml\n    build-hugo-org-roam-ui-lite:\n      runs-on: ubuntu-latest\n      needs: ci\n      defaults:\n        run:\n          working-directory: ./hugo\n      steps:\n        - name: Checkout\n          uses: actions/checkout@v4\n        - name: Setup nix\n          uses: ./.github/actions/setup-nix\n          with:\n            cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}\n        - name: Build build-org-roam-ui-lite\n          run: nix build .#build-org-roam-ui-lite\n        - name: Upload coverage report to artifacts\n          uses: actions/upload-artifact@v4\n          with:\n            name: build-hugo-org-roam-ui-lite\n            path: ./hugo/result\n#+end_src\n\nURLは =/graph= だけどリクエストは =/api/graphql.json= なのでディレクトリを移動させた。\n\n#+begin_src yaml\n  - name: Download org-roam-ui-lite artifacts\n    uses: actions/download-artifact@v4\n    with:\n      name: build-hugo-org-roam-ui-lite\n      path: ./public/graph\n      merge-multiple: true\n  - name: Move api directory\n    run: mv ./public/graph/api ./public/api\n#+end_src\n* 得られた結果・所感\n\nGitHub Pagesで確認できるようになった。\n\nhttps://www.takeokunn.org/graph/\n\n[[file:../../static/images/A6299E02-E405-40F8-B357-890C10B93105.png]]\n\nCI Workflowが充実してきたが実行速度は3分程度に抑えられている。\n\n[[file:../../static/images/5906E4D3-CCAC-4BB6-B733-F0146814FE74.png]]\n\n* 今後の展開・検討事項\n\norg-roam-ui-liteが普及してほしいので別途紹介記事をZennに書く。\n",
  "backlinks": []
}