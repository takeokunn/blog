{
  "id": "D411A179-B5A7-4F1C-A4D6-94AADB8DF2F9",
  "title": "Denoで簡易的なCLIツールを作る",
  "raw": ":PROPERTIES:\n:ID:       D411A179-B5A7-4F1C-A4D6-94AADB8DF2F9\n:END:\n#+TITLE: Denoで簡易的なCLIツールを作る\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-04-03T21:23:45+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting deno cliffy\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\nDenoでCLIツールを試験的に作ったのでメモしておく。\n\n* 方針\n\n- [[https://cliffy.io/][cliffy]] で作成\n- =cat= と =grep= をSub Commandで簡易的に作成\n\n* ディレクトリ構造\n#+begin_src console\n  $ nix run nixpkgs#tree .\n  .\n  ├── deno.json\n  ├── deno.lock\n  └── src\n      ├── commands\n      │   ├── cat.ts\n      │   └── grep.ts\n      ├── deps.ts\n      └── main.ts\n\n  3 directories, 6 files\n#+end_src\n* 作業手順\n** 1. 依存関係をインストール\n\n=$ deno install= で入れて使い易いように =src/deps.ts= を用意する\n\n=deno.json=:\n\n#+begin_src json\n  {\n    \"imports\": {\n      \"@cliffy/command\": \"jsr:@cliffy/command@^1.0.0-rc.7\"\n    }\n  }\n#+end_src\n\n=src/deps.ts=:\n\n#+begin_src typescript\n  export { Command } from '@cliffy/command';\n#+end_src\n** 2. Command作成\n#+begin_src typescript\n  import { Command } from './deps.ts';\n  import { catCommand } from './commands/cat.ts';\n  import { grepCommand } from './commands/grep.ts';\n\n  await new Command()\n    .name('mycli')\n    .version('0.1.0')\n    .description('My CLI tool')\n    .command('cat', catCommand)\n    .command('grep', grepCommand)\n    .parse(Deno.args);\n#+end_src\n** 3. Sub Command\n*** 3.1 cat\n#+begin_src typescript\n  import { Command } from '../deps.ts';\n\n  const displayFiles = async (files: string[]): Promise<void> => {\n    for (const file of files) {\n      try {\n        const content = await Deno.readTextFile(file);\n        console.log(`--- ${file} ---`);\n        console.log(content);\n      } catch (err) {\n        if (err instanceof Error) {\n          console.error(`Error reading ${file}: ${err.message}`);\n        } else {\n          console.error(`Unknown error:`, err);\n        }\n      }\n    }\n  };\n\n  export const catCommand = new Command()\n    .name('cat')\n    .description('Display content of files')\n    .arguments('<files...>')\n    .action(async (_, ...files: string[]) => await displayFiles(files));\n#+end_src\n*** 3.2 grep\n#+begin_src typescript\n  import { Command } from '../deps.ts';\n\n  const grepFiles = async (pattern: string, files: string[]): Promise<void> => {\n    const regex = new RegExp(pattern, 'g');\n\n    for (const file of files) {\n      try {\n        const content = await Deno.readTextFile(file);\n        const lines = content.split('\\n');\n        let matchFound = false;\n\n        for (let i = 0; i < lines.length; i++) {\n          if (regex.test(lines[i])) {\n            if (!matchFound) {\n              console.log(`\\n--- ${file} ---`);\n              matchFound = true;\n            }\n            console.log(`${i + 1}: ${lines[i]}`);\n            regex.lastIndex = 0; // Reset regex for next test\n          }\n        }\n      } catch (err) {\n        if (err instanceof Error) {\n          console.error(`Error reading ${file}: ${err.message}`);\n        } else {\n          console.error(`Unknown error:`, err);\n        }\n      }\n    }\n  };\n\n  export const grepCommand = new Command()\n    .name('grep')\n    .description('Search for pattern in files')\n    .arguments('<pattern> <files...>')\n    .action(async (_, pattern: string, ...files: string[]) =>\n      await grepFiles(pattern, files)\n    );\n#+end_src\n** 4. Command実行\n*** 4.1 cat\n#+begin_src console\n  $ deno run --allow-read src/main.ts cat deno.json src/deps.ts\n  --- deno.json ---\n  {\n    \"imports\": {\n      \"@cliffy/command\": \"jsr:@cliffy/command@^1.0.0-rc.7\"\n    }\n  }\n\n  --- src/deps.ts ---\n  export { Command } from '@cliffy/command';\n#+end_src\n*** 4.2 grep\n#+begin_src console\n  $ deno run --allow-read src/main.ts grep \"command\" deno.json src/main.ts\n\n  --- deno.json ---\n  3:     \"@cliffy/command\": \"jsr:@cliffy/command@^1.0.0-rc.7\"\n\n  --- src/main.ts ---\n  2: import { catCommand } from './commands/cat.ts';\n  3: import { grepCommand } from './commands/grep.ts';\n  9:   .command('cat', catCommand)\n  10:   .command('grep', grepCommand)\n#+end_src\n* 終わりに\nTypeScriptで記述できるのはnpmの資産が使えて便利だし、cliffyも使い勝手が非常によい。\n",
  "backlinks": []
}