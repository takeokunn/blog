{
  "id": "B8EE3DB1-3A8C-4773-85E4-F8CF326260F7",
  "title": "Excelファイルをtxtファイルに変換してNotebookLMに食わせる",
  "raw": ":PROPERTIES:\n:ID:       B8EE3DB1-3A8C-4773-85E4-F8CF326260F7\n:END:\n#+TITLE: Excelファイルをtxtファイルに変換してNotebookLMに食わせる\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-05-23T22:12:39+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting excel\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\n利用規約の関係で明確に言及できないが、某ECプラットフォーム（以下 A社）とのAPI連携を実装していた。\n\nA社のAPI含む全体的なドキュメントの管理方法は次のようになっている。\n\n- APIの情報がWeb上に公開されていない\n  - 技術ブログに書いている人がいない\n- 管理画面を使うには申請が必要\n- 管理画面の奥の方にAPIドキュメントがある\n- APIドキュメントをzipでダウンロードする方式\n  - EndpointごとにExcelファイルが入っている\n  - セルの結合などを駆使して見易いように書かれている\n  - Excelのシートが複数枚ある\n- エラーメッセージなどは別のダウンロードリンクに纏まっている\n\n開発する上で次のような問題を抱えていた。\n\n- 今回の対応で必要なEndpointの取捨選択を効率的にしたい\n- ひとつずつExcelファイルを開いて確認するのが面倒\n- 横断した情報の整合性を確認するのが大変\n\n今回のようにExcelファイルが与えられた時にどう対応するべきなのか後学の為にメモしておく。\n\n* 試したこと・やったこと\n** 1. ExcelファイルをGoogle Driveにアップロードする\n\nExcelファイルをGoogle DriveにアップロードするとSpreadSheetから閲覧できる。\nこうすることで、ExcelファイルにURL Linkからアクセスすることが可能になるのがよい。\n\n** 2. Excelファイルを文字列に起こす\n\n=xlsx2csv= を使ってcsvファイルに変換する。\n\n#+begin_src console\n  $ xlsx2csv -s 2 tmp.xlsx > tmp.csv\n#+end_src\n\n=-s= オプションでシート番号を指定できる。\n\n#+begin_src console\n  usage: xlsx2csv [-h] [-v] [-a] [-c OUTPUTENCODING] [-d DELIMITER] [--hyperlinks] [-e] [--no-line-breaks] [-E EXCLUDE_SHEET_PATTERN [EXCLUDE_SHEET_PATTERN ...]] [-f DATEFORMAT] [-t TIMEFORMAT]\n                  [--floatformat FLOATFORMAT] [--sci-float] [-I INCLUDE_SHEET_PATTERN [INCLUDE_SHEET_PATTERN ...]] [--exclude_hidden_sheets] [--ignore-formats IGNORE_FORMATS [IGNORE_FORMATS ...]]\n                  [-l LINETERMINATOR] [-m] [-n SHEETNAME] [-i] [--skipemptycolumns] [-p SHEETDELIMITER] [-q QUOTING] [-s SHEETID] [--include-hidden-rows]\n                  xlsxfile [outfile]\n\n  xlsx to csv converter\n\n  positional arguments:\n    xlsxfile              xlsx file path, use '-' to read from STDIN\n    outfile               output csv file path\n\n  options:\n    -h, --help            show this help message and exit\n    -v, --version         show program's version number and exit\n    -a, --all             export all sheets\n    -c OUTPUTENCODING, --outputencoding OUTPUTENCODING\n                          encoding of output csv ** Python 3 only ** (default: utf-8)\n    -d DELIMITER, --delimiter DELIMITER\n                          delimiter - columns delimiter in csv, 'tab' or 'x09' for a tab (default: comma ',')\n    --hyperlinks, --hyperlinks\n                          include hyperlinks\n    -e, --escape          Escape \\r\\n\\t characters\n    --no-line-breaks, --no-line-breaks\n                          Replace \\r\\n\\t with space\n    -E EXCLUDE_SHEET_PATTERN [EXCLUDE_SHEET_PATTERN ...], --exclude_sheet_pattern EXCLUDE_SHEET_PATTERN [EXCLUDE_SHEET_PATTERN ...]\n                          exclude sheets named matching given pattern, only effects when -a option is enabled.\n    -f DATEFORMAT, --dateformat DATEFORMAT\n                          override date/time format (ex. %Y/%m/%d)\n    -t TIMEFORMAT, --timeformat TIMEFORMAT\n                          override time format (ex. %H/%M/%S)\n    --floatformat FLOATFORMAT\n                          override float format (ex. %.15f)\n    --sci-float           force scientific notation to float\n    -I INCLUDE_SHEET_PATTERN [INCLUDE_SHEET_PATTERN ...], --include_sheet_pattern INCLUDE_SHEET_PATTERN [INCLUDE_SHEET_PATTERN ...]\n                          only include sheets named matching given pattern, only effects when -a option is enabled.\n    --exclude_hidden_sheets\n                          Exclude hidden sheets from the output, only effects when -a option is enabled.\n    --ignore-formats IGNORE_FORMATS [IGNORE_FORMATS ...]\n                          Ignores format for specific data types.\n    -l LINETERMINATOR, --lineterminator LINETERMINATOR\n                          line terminator - lines terminator in csv, '\\n' '\\r\\n' or '\\r' (default: \\n)\n    -m, --merge-cells     merge cells\n    -n SHEETNAME, --sheetname SHEETNAME\n                          sheet name to convert\n    -i, --ignoreempty     skip empty lines\n    --skipemptycolumns    skip trailing empty columns\n    -p SHEETDELIMITER, --sheetdelimiter SHEETDELIMITER\n                          sheet delimiter used to separate sheets, pass '' if you do not need delimiter, or 'x07' or '\\f' for form feed (default: '--------')\n    -q QUOTING, --quoting QUOTING\n                          quoting - fields quoting in csv, 'none' 'minimal' 'nonnumeric' or 'all' (default: minimal)\n    -s SHEETID, --sheet SHEETID\n                          sheet number to convert\n    --include-hidden-rows\n                          include hidden rows\n#+end_src\n\n次のように再帰的に実行するのでもよい。\n\n#+begin_src console\n  $ find . -name '*.xlsx' -exec bash -c 'for f; do out=\"${f%.xlsx}.csv\"; xlsx2csv -s 2 \"$f\" > \"$out\"; done' bash {} +\n#+end_src\n\n** 3. NotebookLMにアップロードする\n\nNotebookLMはcsvアップロードに対応していないので、いったんtxtに変換してアップロードする。\n\n#+begin_src console\n  $ find . -type f -name '*.csv' -print0 | while IFS= read -r -d '' file; do   mv \"$file\" \"${file%.csv}.txt\"; done\n#+end_src\n\nあとはよしなにNotebookLMに質問する。\n\n* 得られた結果・所感\n\n変換されたcsvはセル結合のせいでだいぶ酷い形式だが、NotebookLMを介することによって圧倒的に読みやすくなった。\n管理画面上のAPIに関する情報もついでに食わせることによって自分の疑問がかなり晴れたし、どこから参照したのかも教えてくれるので自分でも確認できるのがNotebookLMのよい所だなとあらためて感じた。\n\n=xlsx2csv= はnixpkgsで提供してくれているので、雑に =nix-shell= で隔離したShell環境に入ればよい。\n\nhttps://search.nixos.org/packages?channel=unstable&show=xlsx2csv&from=0&size=50&sort=relevance&type=packages&query=xlsx2csv\n\n#+begin_src console\n  $ nix-shell -p xlsx2csv\n#+end_src\n* 今後の展開・検討事項\n\nExcelだと読み辛いのでopenapi.yamlをNotebookLMに生成させて、openapiからTypeScriptを生成する。\n",
  "backlinks": []
}