{
  "id": "CCCBEB19-626D-4776-B981-52EC623D34C0",
  "title": "GitHub ActionsでCachixを導入する",
  "raw": ":PROPERTIES:\n:ID:       CCCBEB19-626D-4776-B981-52EC623D34C0\n:END:\n#+TITLE: GitHub ActionsでCachixを導入する\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-05-10T19:28:45+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\nNixにハマってからGitHub Actions上でNixを実行する機会が増えた。\nNixというツールの性質上、どうしても実行環境の準備に時間がかかってしまうのでキャッシュ機能を導入したいと以前から思っていた。\n\nCachixが一番メジャーなサービスであり、個人利用程度なら無料で使えるので今回はじめて利用してみた。\n\n* 試したこと・やったこと\n** 1. Cachixの設定をする\n\nアカウントを新規作成して、New Cacheで作成した。\n\nhttps://app.cachix.org/\n\n「Settings > Cache Auth Tokens」でアクセストークンを作成して,GitHub Actions Secretに =CACHIX_AUTH_TOKEN= に登録した。\n\n** 2. GitHub Actionsで設定する\n\nreusable actionで次のように定義した。\nreusable actionからは =secrets.XX= を参照できないので引数で渡す必要がある。\n\n#+begin_src yaml\n  name: Run setup-nix\n  description: Set up Nix environment for GitHub Actions\n\n  inputs:\n    cachix-auth-token:\n      required: true\n\n  runs:\n    using: composite\n    steps:\n      - uses: cachix/install-nix-action@v31\n      - uses: cachix/cachix-action@v14\n        with:\n          name: takeokunn-blog\n          authToken: '${{ inputs.cachix-auth-token }}'\n#+end_src\n\n次のように呼び出すとよしなにCache HitしたらCachixからCopyしてくれるようになった。\n\n#+begin_src yaml\n  steps:\n    - name: Setup nix\n      uses: ./.github/actions/setup-nix\n      with:\n        cachix-auth-token: ${{ secrets.CACHIX_AUTH_TOKEN }}\n#+end_src\n\nあとはよしなにnixを実行する。\n\n#+begin_src yaml\n  # nix buildの場合\n  - name: Build zenn\n    run: nix build .#build-zenn\n\n  # nix developの場合\n  - name: flake check\n    run: nix develop --command bash -c \"textlint 'org/**/*.org'\"\n#+end_src\n* 得られた結果・所感\n\n[[https://github.com/takeokunn/blog][takeokunn/blog]] の場合、平均して1分でNix実行環境を用意できるようになり大幅なCI速度改善を実現できた。\n\nhttps://github.com/takeokunn/blog/actions\n\n[[file:../../static/images/E79CB8EB-4877-4997-AD8C-C78E1045C12E.png]]\n\nCachixの導入は簡単で苦労した所が特になかった。\n\n今回の対応に合わせてflake.nixを充実させた結果、LocalとGitHub Actions上で同一の環境を再現性高く構築できるようになったのが良かった。\n\n* 今後の展開・検討事項\n\nLintのチェックなどのCI部分もflake.nix化の対応したい。\n",
  "backlinks": []
}