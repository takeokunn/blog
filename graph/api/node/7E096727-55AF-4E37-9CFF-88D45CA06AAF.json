{
  "id": "7E096727-55AF-4E37-9CFF-88D45CA06AAF",
  "title": "EventBridge Ruleデバッグ方法メモ",
  "raw": ":PROPERTIES:\n:ID:       7E096727-55AF-4E37-9CFF-88D45CA06AAF\n:END:\n#+TITLE: EventBridge Ruleデバッグ方法メモ\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-06-08T16:16:20+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting aws\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\n業務をしていると、「EventBridgeでメタ情報を付与してSQSに流す」といった要件に出くわす機会がある。\n\ne.g. [[https://docs.google.com/presentation/d/1_vOdQO0SY671SRQpnpEz1xvVyUy-Vzl_Dk4Ph6ujy84/edit?slide=id.p#slide=id.p][AWS SQSとLaravelで大規模トラフィックを捌く - phpcon新潟]]\n\nEvent Busが一次受けをして複数のEventBridge Ruleでマッチしたものに情報を付与して次に流す、といった挙動になっている。\n\n- [[https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-what-is.html][EventBridge - AWS公式ドキュメント]]\n- [[https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-rules.html][Amazon EventBridge ルール]]\n- [[https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-event-patterns.html][Amazon EventBridge イベントパターン]]\n\nEventBridge Ruleのデバッグをするには[[https://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-create-rule.html][Amazon EventBridge でイベントに応答するルールの作成]] に書いてあるとおりにやればいいのだが、AWSのドキュメントは初学者から見たら分かりにくく混乱した。\n今回は後学の為に画像付きでメモしておく。\n\n* 試したこと・やったこと\n** 1. AWS consoleから対象のEventBridge Rulesを開く\n\n対象のEventBusを選択して =Create Rule= を押す。\n\n[[file:../../static/images/448BDAE9-E4D3-45BF-84EA-8C954508FED8.png]]\n\n** 2. 「Build event pattern」を開く\n\nDefine rule detailのnameは適当に入れる。\n\n** 3. Sample eventでJsonを入れる\n\n「Enter my own」を選択して「Misc > Webhook Sample」にあるようなテスト用のJsonを入れる。\n\n[[file:../../static/images/8CDED877-B8C3-4432-BA86-F867C5914C31.png]]\n\n以下はShopifyの =inventory_items/create= の実データをマスクしたもの。\n\n#+begin_src json\n  {\n      \"version\": \"0\",\n      \"id\": \"xxx-xxx-xx-xxx\",\n      \"detail-type\": \"shopifyWebhook\",\n      \"source\": \"aws.partner/shopify.com/000000/test\",\n      \"account\": \"000000000000\",\n      \"time\": \"2025-03-01T06:29:19Z\",\n      \"region\": \"ap-northeast-1\",\n      \"resources\": [],\n      \"detail\": {\n          \"payload\": {\n              \"id\": 100000000000,\n              \"sku\": \"\",\n              \"created_at\": \"2025-03-01T01:29:17-05:00\",\n              \"updated_at\": \"2025-03-01T01:29:17-05:00\",\n              \"requires_shipping\": true,\n              \"cost\": null,\n              \"country_code_of_origin\": null,\n              \"province_code_of_origin\": null,\n              \"harmonized_system_code\": \"111111\",\n              \"tracked\": true,\n              \"country_harmonized_system_codes\": [],\n              \"admin_graphql_api_id\": \"gid://shopify/InventoryItem/0000001\"\n          },\n          \"metadata\": {\n              \"Content-Type\": \"application/json\",\n              \"X-Shopify-Topic\": \"inventory_items/create\",\n              \"X-Shopify-Shop-Domain\": \"test.myshopify.com\",\n              \"X-Shopify-Hmac-SHA256\": \"xxxx\",\n              \"X-Shopify-Webhook-Id\": \"xxx-xxx-xxx-xxx-xxxx\",\n              \"X-Shopify-API-Version\": \"2024-10\",\n              \"X-Shopify-Triggered-At\": \"2025-03-01T06:29:17.989779121Z\"\n          }\n      }\n  }\n#+end_src\n** 4. Event patternを入力してテストをする\n\n検証したいEventBridge Ruleを貼り付けて 「Test pattern」 をすると検証できる。\n\n[[file:../../static/images/86DD23E0-7577-47D1-BC1E-84930BA9DBB3.png]]\n\n* 得られた結果・所感\n\nAWS ConsoleからEventBridge Ruleの検証を気軽にできるようになった。\n\nsuffix-matchingの仕様が直感から反するのでメモをしておく。\n\nhttps://docs.aws.amazon.com/ja_jp/eventbridge/latest/userguide/eb-create-pattern-operators.html#eb-filtering-suffix-matching\n\n次のサンプルは FileName のsuffixが =.png= のものだけひっかかるようなRule。\n\n#+begin_src json\n  {\n      \"FileName\": [ { \"suffix\": \".png\" } ]\n  }\n#+end_src\n\nsuffixはstringのみを受け付けておりintegerは許可されていない。\nなので、 =id: 12345= のようなinteger値が飛んできた時に次のRuleは発火しない。\n\n#+begin_src json\n  {\n      \"id\": [ { \"suffix\": \"5\" } ]\n  }\n#+end_src\n* 今後の展開・検討事項\n\nCIでテストする方法がないか追加で調査する。\n",
  "backlinks": []
}