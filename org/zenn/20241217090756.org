:PROPERTIES:
:ID:       DBD2EEBD-7954-45C4-A976-F50F26DCC2E3
:END:
#+TITLE: ISUCON14にチームOL001として参加しました(インフラ編)
#+AUTHOR: takeokunn
#+DESCRIPTION: description
#+DATE: 2024-12-17T09:08:03+0900
#+GFM_TAGS: emacs
#+GFM_CUSTOM_FRONT_MATTER: :emoji 💪
#+GFM_CUSTOM_FRONT_MATTER: :type idea
#+GFM_CUSTOM_FRONT_MATTER: :published false
#+STARTUP: content
#+STARTUP: fold
#+OPTIONS: ^:nil
#+OPTIONS: toc:nil
* Introduction

この記事は、[[https://qiita.com/advent-calendar/2024/openlogi][OPENLOGI Advent Calendar 2024]] の17日目の記事です。

ISUCON14にチームOL001のインフラ担当として参加してきました。

最高スコアは9987、最終スコアは失格になってしまい、提出できたとしても[[https://isucon.net/archives/58837992.html][ ISUCON14 受賞チームおよび全チームスコア]] では130位程度のスコアでした。

当記事ではインフラ担当としての事前準備と当日対応したことについて自分のメモも兼ねて書いていきます。

* 関連記事

- ISUCON14
  - [[https://zenn.dev/nokoy/articles/6b08378f74c6fe][ISUCON14にチームOL001として参加しました(アプリケーション編)]]
- ISUCON13
  - [[https://zenn.dev/nokoy/articles/baed50e2a28bfa][ISUCON13にチームOL001として参加しました(アプリケーション編)]]
  - [[https://zenn.dev/takeokunn/articles/20231212144218][ISUCON13にチームOL001として参加しました(インフラ編)]]

* チームメンバー

昨年同様、同僚の @noko がチケット争奪戦に勝ったので参加できました。

去年と同じメンバーで社内でも同じ開発チームなのでコミュニケーションはスムーズに進みました。

| 名前        | 役割           | 参加経験 |
|------------+---------------+--------|
| @noko      | アプリケーション | 3回目  |
| @yshir     | アプリケーション | 2回目 |
| @takeokunn | インフラ        | 2回目  |

* 目標

ISUCON13の反省を踏まえて、今年は以下の3つの目標を立てました。

** TODO 事前の手順書を洗練させ、アプリケーション担当が改善に集中できる体制作りを強化する

- ISUCON13ではenv回りの扱いや初期構築で改善を阻害してしまった
- 手順書に細かいミスが多かったので本番戸惑ってしまった

** TODO 上位チームと同等のツール選定をする

- 上位チームがどういうツール選定をしてるのか調べる
- その上で現状使いこなせそうな必要なツールのみに絞る

** TODO サーバ分割方法を用意する

- インフラ担当として大きくスコアを伸ばす為にはサーバ分割しかない
- Nginxでappを2台にしたり、DBシャーディングを調査検討しておく

* 事前練習
** 練習時間

2024年11月初旬〜2024年12月8日の約1ヵ月、約60〜80時間程度練習に費しました。

| 練習    | 時間                |
|---------+---------------------|
| 通し練習 | 8時間 × 2回 = 16時間 |
| 個人練習 | 40〜60時間程度       |

今年は合同練習をせずに個人練習のみで、直前1週間前と前日に通し練習をしたのみで練習量が少なかったです。

** 「ISUCON常勝軍団の頭の中〜メンバー集めから解き方の秘密まで〜」視聴

「ISUCON常勝軍団の頭の中〜メンバー集めから解き方の秘密まで〜 (2024/11/14 12:00〜)」をオンライン視聴しました。
https://findy.connpass.com/event/334902/

去年の自分達のチームはpprofを活用できていなかったが、それ以外のツール選定はそんなに違わなかったので安心しました。

「サーバ分割(app1台、mysql1台)みたいに分割した所でスコアが伸びない場合はどうアプローチしていけばいいですか?」という質問に対して以下のような返事をいただきました。

- そもそもCPUかメモリを使いきれてない
- 複数台にした時のレイテンシはボトルネックにならない

https://x.com/takeokunn/status/1856909009070297415

参加ブログからは読み取れない上位チームの肌感覚を知りたかったので自分としては大満足なイベントでした。

** 個人練習
*** 手順書最適化

- memo
  - org-modeをフルに活用した手順書
  - 上位チームから良さそうな設定を拝借する

*** ツール選定

- memo
  - 不要なツールの削除
    - GitHub Actionsなど
  - Ansible最適化
  - before_bench高速化
    - shell script作成
  - pprof導入
    - netdataは結局イマイチという結論になった
  - 使ってたツール
    - alp, pt-query-digest, ....
  - おまけ
    - nix活用

*** サーバ分割

- memo
  - app分割練習
  - db分割 シャーディング

** 過去問
*** isucon9-qualify

- memo
  - 8時間みっちりやった
  - 良いスコアが出た
  - サーバ分割もうまくいった

*** isucon13

- memo
  - 本番前日4〜5時間ゆるくやった
  - スムーズに改善を回せる確認ができた

* 本番
** 開始直後

- memo
  - 手順書通りに

** 中盤

- memo
  - Nginxで返せそうな静的リソース対応
  - 何もできなかった

** 提出間際

- memo
  - 祈るだけ

* 反省
