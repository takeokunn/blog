{
  "id": "63EF484B-FFFF-4EF6-9687-52A8EF770F5B",
  "title": "Emacs lsp-modeに新しいClientを追加する方法",
  "raw": ":PROPERTIES:\n:ID:       63EF484B-FFFF-4EF6-9687-52A8EF770F5B\n:END:\n#+TITLE: Emacs lsp-modeに新しいClientを追加する方法\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-05-18T16:09:49+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting emacs\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景・動機\n\nメジャーなEmacsのLSP Clientは3種類ある。\n\n- [[https://github.com/joaotavora/eglot][eglot]]\n- [[https://github.com/emacs-lsp/lsp-mode][lsp-mode]]\n- [[https://github.com/manateelazycat/lsp-bridge][lsp-bridge]]\n\nそれぞれメリットデメリットがあるが、自分としてはlsp-modeを推していて今後も使い続けるつもりでいる。\nlsp-mode最大のメリットはClientサポート数の多さにあり、メジャーなLSP Clientなら必ず収録されていると言っても過言ではない。\n\n過去に次の2つのClientを追加するPRを出したことがあるので、後学の為にも追加方法を纏めておく。\n\n- [[https://github.com/emacs-lsp/lsp-mode/pull/4785][Add support for Python(ty) #4785]]\n  - 追加で修正してくれた [[https://github.com/emacs-lsp/lsp-mode/pull/4786][lsp-python-py: make it add-on and activated on python #4786]]\n- [[https://github.com/emacs-lsp/lsp-mode/pull/4283][Add support for Jsonnet #4283]]\n\n* 試したこと・やったこと\n** 0. Language Server選定\n\n追加したいLSP Serverをみつける。\n流石に個人が趣味で開発した中途半端なものは避けるべきだと思うが、そこは取り込む人が判断するのでとりあえず出してみるのがよいかもしれない。\n\nCONTRIBUTINGを熟読して、Pull Requestにすでにあるかどうかを確認する。\n\nhttps://github.com/emacs-lsp/lsp-mode/blob/master/CONTRIBUTING.md\n\n** 1. Repoをforkして手元に落とす\n\n[[https://github.com/emacs-lsp/lsp-mode][emacs-lsp/lsp-mode]] からforkボタンを押して、自分の手元にGit Cloneする。\n\nEmacsからPATHを通して =(require 'lsp-mode)= を実行する。\n\n** 2. lsp-modeの設定をする\n\n=clients/lsp-python-ty.el= のように =clients/= に空気を読んでファイルを作成する。\n\nJsonnetの場合は以下。\n\n最低限次の2つを定義すればよい。\n完成度の高いLanguage Serverはオプションがあるので =defcustom= で都度定義する。\n\n- =server-executable=\n- =lsp-register-client=\n\nhttps://github.com/emacs-lsp/lsp-mode/blob/master/clients/lsp-jsonnet.el\n\n#+begin_src emacs-lisp\n  (require 'lsp-mode)\n\n  (defgroup lsp-jsonnet nil\n    \"LSP support for jsonnet.\"\n    :group 'lsp-mode\n    :link '(url-link \"https://github.com/grafana/jsonnet-language-server\"))\n\n  (defcustom lsp-clients-jsonnet-server-executable '(\"jsonnet-language-server\")\n    \"The jsonnet language server executable to use.\"\n    :group 'lsp-jsonnet\n    :risky t\n    :type '(repeat string))\n\n  (lsp-register-client\n   (make-lsp-client\n    :new-connection (lsp-stdio-connection (lambda () lsp-clients-jsonnet-server-executable))\n    :activation-fn (lsp-activate-on \"jsonnet\")\n    :priority -1\n    :major-modes '(jsonnet-mode)\n    :server-id 'jsonnet-lsp))\n\n  (lsp-consistency-check lsp-jsonnet)\n\n  (provide 'lsp-jsonnet)\n#+end_src\n** 3. 手元で動作確認する\n\nちょうどよいサイズのプロジェクトを手元に用意して実際に動かしてみる。\n基本的なLSP機能が正常に動くか確認する。\n\n- 定義ジャンプ\n- 構文エラー表示\n- Rename\n- 補完\n** 4. Pull Requestを出す\n\nlsp-mode.elのlsp-client-packagesにclient追加をする必要がある。\n\nまた[[https://emacs-lsp.github.io/lsp-mode/][ドキュメント]]やCHANGELOGに反映させる必要があるので、次のファイルを追加する。\n\n- [[https://github.com/emacs-lsp/lsp-mode/blob/8a266b83ea0fb880ef697771893c41f8745a04de/docs/lsp-clients.json][docs/lsp-clients.json]]\n- [[https://github.com/emacs-lsp/lsp-mode/blob/8a266b83ea0fb880ef697771893c41f8745a04de/lsp-mode.el][lsp-mode.el]]\n- [[https://github.com/emacs-lsp/lsp-mode/blob/8a266b83ea0fb880ef697771893c41f8745a04de/mkdocs.yml][mkdocs.yml]]\n- [[https://github.com/emacs-lsp/lsp-mode/blob/8a266b83ea0fb880ef697771893c41f8745a04de/CHANGELOG.org][CHANGELOG.org]]\n\nあとはdescriptionを書いてPRを出し、レビュワーの指示にしたがって修正する。\n\n* 得られた結果・所感\n\nlsp-modeプロジェクトは非常に良くできているので追加が簡単。\nレビュワーから速攻レビューが返ってきたので本当に助かった。\n\n* 今後の展開・検討事項\n\n新しいLanguage Serverを見つけたら積極的にPull Requestを出していきたい。\n",
  "backlinks": []
}