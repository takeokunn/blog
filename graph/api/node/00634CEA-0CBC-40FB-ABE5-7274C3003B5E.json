{
  "id": "00634CEA-0CBC-40FB-ABE5-7274C3003B5E",
  "title": "2024年版private-isu構築メモ",
  "raw": ":PROPERTIES:\n:ID:       00634CEA-0CBC-40FB-ABE5-7274C3003B5E\n:END:\n#+TITLE: 2024年版private-isu構築メモ\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2024-11-17T17:20:48+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting isucon\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* 背景\n\nISUCON14の練習の為[[https://github.com/catatsuy/private-isu][catatsuy/private-isu]]を自分のAWSに構築しようとしたが、 [[https://gist.github.com/tohutohu/024551682a9004da286b0abd6366fa55][tohutohu/private-isu.yaml - gist]]が構築できなかったのでメモ。\n\n* 問題点\n\n[[https://gist.github.com/tohutohu/024551682a9004da286b0abd6366fa55][tohutohu/private-isu.yaml - gist]] のCloudFormationをそのまま起動しようとするとAMIがないと怒られる。\n\n| Name   | ImageId               | InstanceType |\n|--------+-----------------------+--------------|\n| server | ami-0d92a4724cae6f07b | c6i.large    |\n| bench  | ami-0582a2a7fbe79a30d | c6i.xlarge   |\n\nAMIの検索は以下から行う。\nhttps://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/finding-an-ami.html\n\n* 修正方法\n\n[[https://github.com/catatsuy/private-isu?tab=readme-ov-file#ami][catatsuy/private-isu#ami]] に動くAMIが記述されているのでそちらに修正し、費用面を考慮して =InstanceType= を次のように修正した。\n\n| Name   | ImageId               | InstanceType |\n|--------+-----------------------+--------------|\n| server | ami-047fdc2b851e73cad | t2.medium    |\n| bench  | ami-037be39355baf1f2e | t2.medium    |\n\nまた、 =KeyPairName= は不要なので削除した。\n\n実際のCloudFormationは以下。\n\n#+begin_src yaml\n  AWSTemplateFormatVersion: '2010-09-09'\n  Description: private-isu template\n  Parameters:\n    GitHubUsername:\n      Description: \"GitHub Username for SSH public key\"\n      Type: String\n  Resources:\n    VPC:\n      Type: AWS::EC2::VPC\n      Properties:\n        CidrBlock: '192.168.0.0/16'\n    MySubnet:\n      Type: AWS::EC2::Subnet\n      Properties:\n        VpcId: !Ref VPC\n        CidrBlock: '192.168.1.0/24'\n        AvailabilityZone: ap-northeast-1a\n    MyInternetGateway:\n      Type: AWS::EC2::InternetGateway\n    AttachGateway:\n      Type: AWS::EC2::VPCGatewayAttachment\n      Properties:\n        VpcId: !Ref VPC\n        InternetGatewayId: !Ref MyInternetGateway\n    MyRouteTable:\n      Type: AWS::EC2::RouteTable\n      Properties:\n        VpcId: !Ref VPC\n    PublicRoute:\n      Type: AWS::EC2::Route\n      DependsOn: AttachGateway\n      Properties:\n        RouteTableId: !Ref MyRouteTable\n        DestinationCidrBlock: 0.0.0.0/0\n        GatewayId: !Ref MyInternetGateway\n    SubnetRouteTableAssociation:\n      Type: AWS::EC2::SubnetRouteTableAssociation\n      Properties:\n        SubnetId: !Ref MySubnet\n        RouteTableId: !Ref MyRouteTable\n    MySecurityGroup:\n      Type: AWS::EC2::SecurityGroup\n      Properties:\n        GroupDescription: Enable SSH, HTTP, HTTPS access\n        VpcId: !Ref VPC\n        SecurityGroupIngress:\n          - IpProtocol: tcp\n            FromPort: 22\n            ToPort: 22\n            CidrIp: 0.0.0.0/0\n          - IpProtocol: tcp\n            FromPort: 80\n            ToPort: 80\n            CidrIp: 0.0.0.0/0\n          - IpProtocol: tcp\n            FromPort: 443\n            ToPort: 443\n            CidrIp: 0.0.0.0/0\n          - IpProtocol: -1\n            CidrIp: 192.168.0.0/16\n    ServerInstance:\n      Type: AWS::EC2::Instance\n      Properties:\n        InstanceType: t2.medium\n        ImageId: ami-047fdc2b851e73cad\n        SubnetId: !Ref MySubnet\n        PrivateIpAddress: '192.168.1.10'\n        SecurityGroupIds:\n          - !Ref MySecurityGroup\n        UserData:\n          Fn::Base64: !Sub |\n            #!/bin/bash\n            GITHUB_USER=${GitHubUsername}\n            mkdir -p /home/isucon/.ssh\n            curl -s https://github.com/$GITHUB_USER.keys >> /home/isucon/.ssh/authorized_keys\n            chown -R isucon:isucon /home/isucon/.ssh\n            chmod 600 /home/isucon/.ssh/authorized_keys\n    BenchmarkerInstance:\n      Type: AWS::EC2::Instance\n      Properties:\n        InstanceType: t2.medium\n        ImageId: ami-037be39355baf1f2e\n        SubnetId: !Ref MySubnet\n        PrivateIpAddress: '192.168.1.20'\n        SecurityGroupIds:\n          - !Ref MySecurityGroup\n        UserData:\n          Fn::Base64: !Sub |\n            #!/bin/bash\n            GITHUB_USER=${GitHubUsername}\n            mkdir -p /home/isucon/.ssh\n            curl -s https://github.com/$GITHUB_USER.keys >> /home/isucon/.ssh/authorized_keys\n            chown -R isucon:isucon /home/isucon/.ssh\n            chmod 600 /home/isucon/.ssh/authorized_keys\n    ServerEIP:\n      Type: AWS::EC2::EIP\n    BenchmarkerEIP:\n      Type: AWS::EC2::EIP\n    ServerEIPAssociation:\n      Type: AWS::EC2::EIPAssociation\n      Properties:\n        InstanceId: !Ref ServerInstance\n        EIP: !Ref ServerEIP\n    BenchmarkerEIPAssociation:\n      Type: AWS::EC2::EIPAssociation\n      Properties:\n        InstanceId: !Ref BenchmarkerInstance\n        EIP: !Ref BenchmarkerEIP\n#+end_src\n\n* 終わりに\n\n実際に練習するなら指定された環境のまま起動した方がよいだろうが、あくまで練習として =private-isu= を立ち上げたいだけという今回の用途ではこれで十分。\n",
  "backlinks": []
}