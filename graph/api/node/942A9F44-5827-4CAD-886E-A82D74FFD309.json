{
  "id": "942A9F44-5827-4CAD-886E-A82D74FFD309",
  "title": "2025年2月 Neovimセットアップ",
  "raw": ":PROPERTIES:\n:ID:       942A9F44-5827-4CAD-886E-A82D74FFD309\n:END:\n#+TITLE: 2025年2月 Neovimセットアップ\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-02-11T11:11:01+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting vim nix\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\nNeovimに入門したいと思い早n年だったが、vim-jpの皆さんのおかげでようやくミニマムの設定が完了したのでブログにまとめておきます。\n\n[[id:E1C13122-4090-47F6-B84E-238CCC981E72][VimとNeovimの使い分けと最小構成]] のとおりVimは最小構成にしているので、Neovimはヘビーカスタマイズしていく方針です。\n\nNeovimの設定はこちら。\n\n[[https://github.com/takeokunn/nixos-configuration/tree/main/home-manager/programs/neovim][https://github.com/takeokunn/nixos-configuration/tree/main/home-manager/programs/neovim]]\n\n* Setup\n** Neovim本体\n\nNix経由でインストールしています。\n\n[[https://github.com/takeokunn/nixos-configuration/blob/main/home-manager/programs/neovim/default.nix][https://github.com/takeokunn/nixos-configuration/blob/main/home-manager/programs/neovim/default.nix]]\n\n=withNodeJs= や =withRuby= などはイマドキ使わない設定まらしいので =false= にしました。\n\n#+begin_src nix\n  { pkgs, sources }:\n  {\n    programs.neovim = {\n      enable = true;\n      withNodeJs = false;\n      withRuby = false;\n      withPython3 = false;\n      plugins = import ./plugins { inherit pkgs sources; };\n      extraLuaConfig = builtins.readFile ./init.lua;\n    };\n  }\n#+end_src\n** Plugin Manager\n\nVimのPlugin Managerは乱立しているようで、デファクトスタンダードはないらしいです。\n私はNixユーザーなのでNixで管理することにしました。\n\nまた、各Pluginごとの設定もNix内に記述する方針にしました。\n\n#+begin_src nix\n  # 実際の例\n  { pkgs }:\n  with pkgs.vimPlugins;\n  [\n    {\n      type = \"lua\";\n      plugin = dracula-nvim;\n      config = ''\n        vim.cmd[[colorscheme dracula]]\n      '';\n    }\n  ]\n#+end_src\n** Terminal Emulator\n「Terminal Emulatorにこだわらない」というこだわりを持っていたが、[[https://timingapp.com/terminal-time-tracking][Mac標準のTerminal.app]]だとうまく描画してくれない問題があった。\n\n一応以下が候補だったが、NixOS環境でも安定的に動いてくれる、かつ友人のnatsukiumが使っている[[https://github.com/kovidgoyal/kitty][Kitty]]を採用しました。\n\n- [[https://wezterm.org/][WezTerm]]\n- [[https://github.com/alacritty/alacritty][Alacritty]]\n- [[https://github.com/ghostty-org/ghostty][Ghostty]]\n\n現状Kittyで特に困っていないしTerminal Emulatorに情熱がないのでこのまま続投するつもりです。\n\n* Config\n\nNeovimの設定はVim scriptではなくLuaを使うのがイマドキであり、多くのNeovim PluginはLuaで書かれているらしい。\nそれにならって自分もLuaで設定していくことにしました。\n\n** init.lua\n\n基本的な設定は以下。\n行番号はそもそも表示不要というのが最近の結論なので消しました。\n\n#+begin_src lua\n  vim.opt.number = false\n  vim.opt.relativenumber = false\n  vim.opt.encoding = \"utf-8\"\n  vim.opt.fileencodings = \"utf-8,euc-jp,cp932\"\n  vim.opt.clipboard:append(\"unnamed\")\n  vim.opt.backspace = \"indent,eol,start\"\n  vim.opt.tabstop = 2\n  vim.opt.shiftwidth = 2\n  vim.opt.laststatus = 3\n  vim.opt.statusline = \"%y\"\n  vim.opt.showmatch = true\n  vim.opt.wrapscan = true\n  vim.opt.hlsearch = true\n  vim.opt.showcmd = true\n  vim.opt.title = true\n  vim.opt.foldenable = false\n  vim.opt.swapfile = false\n  vim.opt.expandtab = true\n  vim.opt.splitbelow = true\n  vim.opt.splitright = true\n  vim.opt.incsearch = true\n  vim.opt.ignorecase = true\n  vim.opt.smartcase = true\n  vim.opt.termguicolors = true\n#+end_src\n\n簡単なkeymapは以下。\n=mapleader= をスペースに割り当てている人が多数派みたいですが、個人的には =,= が昔から好きです。\n\n#+begin_src lua\n  vim.g.mapleader = \",\"\n\n  vim.keymap.set(\"n\", \"/\", \"/\\\\v\", { remap = false })\n  vim.keymap.set(\"n\", \"U\", \"<C-r>\", { remap = false })\n  vim.keymap.set(\"n\", \"<Leader><Leader>\", \"V\", { remap = false })\n  vim.keymap.set(\"n\", \"<Esc><Esc>\", \"<Cmd>nohlsearch<CR><Esc>\", { remap = false })\n  vim.keymap.set(\"i\", \"<C-j>\", \"<CR>\")\n#+end_src\n\nwindowやbufferの切り替えは簡単な設定をしています。\n\n#+begin_src lua\n  -- window keymap\n\n  vim.keymap.set(\"n\", \"sj\", \"<C-w>j\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sk\", \"<C-w>k\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sl\", \"<C-w>l\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sh\", \"<C-w>h\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sJ\", \"<C-w>J\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sK\", \"<C-w>K\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sL\", \"<C-w>L\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sH\", \"<C-w>H\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sw\", \"<C-w>w\", { noremap = true, silent = true })\n\n  -- buffer keymap\n\n  vim.keymap.set(\"n\", \"sp\", \":<C-u>bp<CR>\", { noremap = true, silent = true })\n  vim.keymap.set(\"n\", \"sn\", \":<C-u>bn<CR>\", { noremap = true, silent = true })\n#+end_src\n** package\n\n項目分けは雑なのでもう少しpluginが増えたら考え直します。\n\n*** basic\n\n- [[https://github.com/smoka7/hop.nvim][hop-nvim]]\n  - easymotionみたいなplugin\n  - Emacsでいう所の[[https://github.com/abo-abo/avy][avy]]\n- [[https://github.com/ConradIrwin/vim-bracketed-paste][vim-bracketed-paste]]\n  - クリップボード用\n- [[https://github.com/lambdalisue/vim-fern][vim-fern]]\n  - ありすえwareのファイラ\n  - Emacsでいう所の[[https://www.google.com/search?q=neotree+emacs&oq=neotree&gs_lcrp=EgZjaHJvbWUqBwgBEAAYgAQyBggAEEUYOTIHCAEQABiABDIHCAIQABiABDIHCAMQABiABDIHCAQQABiABDIGCAUQABgeMgYIBhAAGB4yBggHEAAYHjIGCAgQABgeMgYICRAAGB7SAQgyMzY4ajBqNKgCALACAA&sourceid=chrome&ie=UTF-8][neotree]]\n- [[https://github.com/lambdalisue/vim-nerdfont][vim-nerdfont]]\n  - nerdfontを扱えるようにするやつ\n- [[https://github.com/lambdalisue/vim-fern-renderer-nerdfont][vim-fern-renderer-nerdfont]]\n  - ファイラにアイコンを表示するやつ\n- [[https://github.com/mbbill/undotree][undotree]]\n  - undo historyを可視化するやつ\n  - Emacsでいう所の[[https://github.com/emacsmirror/undo-fu][undo-fu]]\n- [[https://github.com/kana/vim-textobj-entire][vim-textobj-entire]]\n  - buffer全体をテキストオブジェクトにするやつ\n- [[https://github.com/vim-jp/vimdoc-ja][vimdoc-ja]]\n  - 日本語help\n- [[https://github.com/jiangmiao/auto-pairs][auto-pairs]]\n  - Emacsでいう所のelectric-pair-modeみたいなやつ\n- [[https://github.com/luochen1990/rainbow/][rainbow]]\n  - 括弧の対応をハイライトしてくれるやつ\n  - Emacsでいう所の[[https://github.com/Fanael/rainbow-delimiters][rainbow-delimiters]]\n- [[https://github.com/machakann/vim-sandwich][vim-sandwich]]\n  - 括弧の操作を簡単にできるやつ\n  - Emacsでいう所の[[https://github.com/AmaiKinono/puni][puni-mode]]\n- [[https://github.com/vim-denops/denops.vim][denops-vim]]\n  - Deno製plugin用\n\nざっくりこのあたりを入れています。\n\n*** Git\n\n- [[https://github.com/lewis6991/gitsigns.nvim][gitsigns-nvim]]\n  - 変更を可視化してくれるやつ\n  - Emacsでいう所の[[https://github.com/emacsorphanage/git-gutter][git-gutter]]\n- [[https://github.com/lambdalisue/vim-gin][gin]]\n  - ありすえwareのGit clinet\n  - Emacsでいう所の[[https://github.com/magit/magit][magit]]\n\nそこまで使っていないです。\nGit操作はTerminalでもよいのかなという気持ちになってます。\n\n*** language\n\n- [[https://github.com/jceb/vim-orgmode][orgmode]]\n- [[https://github.com/preservim/vim-markdown][vim-markdown]]\n\n基本的にTree-sitterがhighlightしてくれるので特別入れる必要がなかったです。\n\n*** lsp\n\n- [[https://github.com/hrsh7th/nvim-cmp][nvim-cmp]]\n- [[https://github.com/neovim/nvim-lspconfig][nvim-lspconfig]]\n  - Emacsでいう所の[[https://github.com/emacs-lsp/lsp-mode][lsp-mode]]\n- [[https://github.com/nvimdev/lspsaga.nvim][lspsaga-nvim]]\n  - Emacsでいう所の[[https://github.com/emacs-lsp/lsp-ui][lsp-ui]]\n\nざっくりとした設定は以下。最低限満足するUIになってくれました。\n\n=nvim-cmp=:\n\n#+begin_src lua\n  local cmp = require(\"cmp\")\n\n  cmp.setup({\n        snippet = {\n           expand = function(args)\n              vim.fn[\"vsnip#anonymous\"](args.body)\n           end,\n        },\n        sources = {\n           { name = \"nvim_lsp\" },\n           { name = \"path\" },\n        },\n        mapping = cmp.mapping.preset.insert({\n              [\"<C-p>\"] = cmp.mapping.select_prev_item(),\n              [\"<C-n>\"] = cmp.mapping.select_next_item(),\n              ['<C-l>'] = cmp.mapping.complete(),\n              ['<C-e>'] = cmp.mapping.abort(),\n              [\"<CR>\"] = cmp.mapping.confirm { select = true },\n        }),\n        experimental = {\n           ghost_text = true,\n        },\n  })\n#+end_src\n\n=nvim-lspconfig=:\n\n#+begin_src lua\n  local lspconfig = require('lspconfig')\n\n  vim.keymap.set('n', 'gd', '<cmd>lua vim.lsp.buf.definition()<CR>', { silent = true, buffer = buffer })\n\n  if vim.fn.executable('nil') == 1 then\n     lspconfig.nil_ls.setup {\n        settings = {\n           ['nil'] = {\n              formatting = {\n                 command = { 'nixfmt' }\n              }\n           }\n        }\n     }\n  end\n\n  if vim.fn.executable('typescript-language-server') == 1 then\n     lspconfig.ts_ls.setup { }\n  end\n\n  if vim.fn.executable('intelephense') == 1 then\n     lspconfig.intelephense.setup { }\n  end\n#+end_src\n\n=lspsaga-nvim=:\n\n#+begin_src lua\n  require('lspsaga').setup({\n      code_action = {\n          extend_gitsigns = true,\n      },\n      finder = {\n          max_height = 0.7,\n          left_width = 0.3,\n          right_width = 0.6,\n          keys = {\n              shuttle = \"<Space>w\",\n              toggle_or_open = \"<CR>\"\n          }\n      },\n      lightbulb = {\n          enable = false,\n      }\n  })\n\n  vim.keymap.set('n', 'K', '<cmd>Lspsaga hover_doc<CR>')\n  vim.keymap.set({ 'n', 'i' }, '<S-M-r>', \"<cmd>Lspsaga rename<CR>\", opts)\n  vim.keymap.set('n', '<M-d>', \"<cmd>Lspsaga finder def+ref<CR>\", opts)\n  vim.keymap.set('n', '<M-r>', \"<cmd>Lspsaga peek_definition<CR>\", opts)\n  vim.keymap.set('n', '<M-j>', \"<cmd>Lspsaga diagnostic_jump_next<CR>\", opts)\n  vim.keymap.set('n', '<M-k>', \"<cmd>Lspsaga diagnostic_jump_prev<CR>\", opts)\n#+end_src\n*** skk\n\n- [[https://github.com/vim-skk/skkeleton][skkeleton]]\n  - Emacsでいう所の[[https://github.com/skk-dev/ddskk][ddskk]]\n- [[https://github.com/kei-s16/skkeleton-azik-kanatable][skkeleton-azik-kanatable]]\n\n簡易的な設定とskkservへの接続、AZIKの有効化をしました。\n\n=skkeleton#register_kanatable= で独自のかなテーブルを定義できるらしいです。\n\n=skkeleton=:\n\n#+begin_src lua\n  vim.fn['skkeleton#config']({\n      eggLikeNewline = true,\n      keepState = true,\n      sources = { \"skk_server\" }\n  })\n\n  vim.keymap.set({ 'i', 'c' }, '<C-j>', '<Plug>(skkeleton-toggle)', { silent = true })\n#+end_src\n\n=skkeleton-azik-kanatable=:\n\n#+begin_src lua\n  vim.fn['skkeleton#azik#add_table']('us')\n  vim.fn['skkeleton#config']({\n      kanaTable = 'azik'\n  })\n\n  vim.call(\"skkeleton#register_kanatable\", \"azik\", {\n      ss = { \"せい\" },\n  })\n#+end_src\n*** telescope\n\n- [[https://github.com/nvim-telescope/telescope.nvim][telescope-nvim]]\n- [[https://github.com/nvim-telescope/telescope-ui-select.nvim][telescope-ui-select-nvim]]\n- [[https://github.com/nvim-telescope/telescope-file-browser.nvim][telescope-file-browser-nvim]]\n- [[https://github.com/nvim-telescope/telescope-fzf-native.nvim][telescope-fzf-native-nvim]]\n\ntelescopeは簡単に導入できるということで導入しました。\n\nEmacsでいう所の、というのは説明が難しいですね。\ntomoyaさんの [[https://blog.tomoya.dev/posts/a-new-wave-has-arrived-at-emacs/][Emacsの次世代ミニバッファ補完UI]] あたりが参考になりそうです。\n\n=<leader>= はデフォルトでマッピングされてないのでこれで問題ないようです。\n\n#+begin_src lua\n  require('telescope').setup {\n      extensions = {\n          fzf = {\n              fuzzy = true,\n              override_generic_sorter = true,\n              override_file_sorter = true,\n              case_mode = \"smart_case\",\n          }\n      }\n  }\n  local builtin = require('telescope.builtin')\n  vim.keymap.set('n', '<leader>f', builtin.git_files, { desc = 'Telescope find git files' })\n  vim.keymap.set('n', '<leader>o', builtin.current_buffer_fuzzy_find, { desc = 'Telescope buffer fuzzy find' })\n  vim.keymap.set('n', '<leader>g', builtin.live_grep, { desc = 'Telescope live grep' })\n  vim.keymap.set('n', '<leader>b', builtin.buffers, { desc = 'Telescope buffers' })\n  vim.keymap.set('n', '<leader>h', builtin.help_tags, { desc = 'Telescope help tags' })\n#+end_src\n\n*** themes\n\n- [[https://github.com/Mofiqul/dracula.nvim][dracula-nvim]]\n  - Emacsでいう所の[[https://github.com/doomemacs/themes][doom-theme]]\n- [[https://github.com/nvim-lualine/lualine.nvim][lualine-nvim]]\n  - Emacsでいう所の[[https://github.com/seagle0128/doom-modeline][doom-modeline]]\n\nすべてのカラーテーマをdraculaに寄せているので導入しました。\nまた、modelpineはlualine-nvimがイマドキらしいです。\n\n* 終わりに\nvim-jpの皆さん（特にkuuさん、Kento Ogataさん、Shougoさん、こまもかくん、おもちあいす）のおかげで無事日常生活できるくらいの設定になりました。\nもう少しVimに慣れたらDark Poweredなpackageを試していくつもりです。\n",
  "backlinks": []
}