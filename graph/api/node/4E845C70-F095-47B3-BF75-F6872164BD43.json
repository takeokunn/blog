{
  "id": "4E845C70-F095-47B3-BF75-F6872164BD43",
  "title": "NextDNSを導入した",
  "raw": ":PROPERTIES:\n:ID:       4E845C70-F095-47B3-BF75-F6872164BD43\n:END:\n#+TITLE: NextDNSを導入した\n#+AUTHOR: takeokunn\n#+DESCRIPTION: description\n#+DATE: 2025-04-02T01:41:49+0900\n#+HUGO_BASE_DIR: ../../\n#+HUGO_CATEGORIES: fleeting\n#+HUGO_SECTION: posts/fleeting\n#+HUGO_TAGS: fleeting nextdns\n#+HUGO_DRAFT: false\n#+STARTUP: fold\n* Introduction\n\nかねてから興味があった [[https://nextdns.io/][NextDNS]] が Terraform Provider と nix-darwin/nixos で設定できることを知り、せっかくなので導入してみた。\n\n* What is NextDNS?\n\n流行のDeep Reasearchの結果は以下Gist。\n\nhttps://gist.github.com/takeokunn/aa9bc9ef2c7d670b71bfd962c8a1a80e\n\n日本人でも使っている人がちらほらいる。\n\n- [[https://vpn-taizen.com/what_is_nextdns/][ほぼ無料で全てまとめて広告ブロックできるNextDNSとは]]\n- [[https://mkusaka.com/2023/06/18/nextdns/][NextDNSを使ってみて広告ブロックが捗ったので紹介]]\n- [[https://www.qam-web.com/?p=21061#google_vignette][NextDNSで安全で快適なブラウジング]]\n\n* 作業手順\n** 1. アカウント作成してAPI Key発行\n\n公式サイトからメールアドレスとパスワードで登録する。\nhttps://nextdns.io/\n\n管理画面からMFAを設定してAPI keyを発行する。\nhttps://my.nextdns.io/account\n\n** 2. Terraform設定\n\nドキュメントを参考に画面上で設定できるものを宣言的に設定する。\nhttps://registry.terraform.io/providers/carbans/nextdns/latest/docs\n\n*** 2.1 providerを設定\n[[https://github.com/getsops/sops][sops]] にAPI Tokenを保存して [[https://github.com/carlpett/terraform-provider-sops][terraform-provider-sops]] 経由で入れる。\n\n#+begin_src terraform\n  terraform {\n    required_providers {\n      sops = {\n        source  = \"carlpett/sops\"\n        version = \"~> 0.5\"\n      }\n      nextdns = {\n        source  = \"carbans/nextdns\"\n        version = \"~> 0.2\"\n      }\n    }\n  }\n\n  provider \"sops\" {}\n\n  data \"sops_file\" \"secret\" {\n    source_file = \"./secrets.yaml\"\n  }\n\n  provider \"nextdns\" {\n    api_key = data.sops_file.secret.data.nextdns\n  }\n#+end_src\n\n*** 2.2 各種設定\n\nとりあえず有効にできるものは有効にした。\n\n#+begin_src terraform\n  resource \"nextdns_profile\" \"main\" {\n    name = \"Main Network\"\n  }\n\n  resource \"nextdns_security\" \"main\" {\n    profile_id                = nextdns_profile.main.id\n    ai_threat_detection       = true\n    crypto_jacking            = true\n    csam                      = true\n    ddns                      = true\n    dga                       = true\n    dns_rebinding             = true\n    google_safe_browsing      = true\n    idn_homographs            = true\n    nrd                       = false\n    parking                   = true\n    threat_intelligence_feeds = true\n    typo_squatting            = true\n  }\n\n  resource \"nextdns_privacy\" \"main\" {\n    profile_id         = nextdns_profile.main.id\n    disguised_trackers = true\n    allow_affiliate    = true\n  }\n\n  resource \"nextdns_settings\" \"main\" {\n    profile_id = nextdns_profile.main.id\n    web3       = true\n    logs {\n      enabled   = true\n      retention = \"1 day\"\n      location  = \"us\"\n\n      privacy {\n        log_clients_ip = true\n        log_domains    = true\n      }\n    }\n\n    block_page {\n      enabled = true\n    }\n\n    performance {\n      ecs              = true\n      cache_boost      = true\n      cname_flattening = true\n    }\n  }\n#+end_src\n\n** 3. Nix設定\n*** 3.1 nix-darwin設定\n\nnix-darwinはserviceで提供してくれているので有効にするだけ。\nhttps://mynixos.com/nix-darwin/options/services.nextdns\n\n#+begin_src nix\n  {\n    services.nextdns = {\n      enable = true;\n      arguments = [ \"-profile\" \"xxxx\" ];\n    };\n  }\n#+end_src\n*** 3.2 NixOS設定\n\nNixOS公式が提供してくれているので同様に有効するだけ。\nhttps://search.nixos.org/options?channel=24.11&from=0&size=50&sort=relevance&type=packages&query=nextdns\n\n** 4. 接続確認\n\nあまりよくわかっていないが、以下を明示的にたたく必要があった。（要調査）\n\n#+begin_src console\n  $ nix run nixpkgs#nextdns activate\n#+end_src\n\n管理画面で有効になっていることを確認できればよい。\n\n[[file:../../static/images/F20AAC35-AE8E-4165-BE3C-F39FDC46731A.png]]\n\nついでにAndroidも設定をした。\n\n#+begin_example\n  プライベート DNS\n  Android 9 以降\n\n  1. 設定 → ネットワークとインターネット → 詳細設定 → プライベート DNS に移動します。\n  2.「プライベート DNS プロバイダのホスト名」オプションを選択します。\n  3. xxxx.dns.nextdns.io を入力し、「保存」を押します。\n#+end_example\n* 作業結果\nWebサイトへのアクセスが体感速くなったがあくまで体感。\nもう少し運用してみて様子を見たい。\n",
  "backlinks": [
    {
      "title": "private-terraformをHCP Terraformに移行した",
      "source": "FFA7027E-161A-498C-AD36-C0033C7A9CD6"
    },
    {
      "title": "お名前comからCloudflareにドメイン移管してTerraformで管理する",
      "source": "861C8003-2791-4BF3-8126-489838D804F9"
    }
  ]
}